<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cass Brothers Â· Brand Portal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

        :root {
            --ink: #1c1b1f;
            --ink-soft: #3d3a40;
            --slate: #6b6670;
            --card: #ffffff;
            --stone: #f5f2ec;
            --line: rgba(27, 27, 27, 0.08);
            --shadow: 0 1px 3px rgba(17,18,19,0.04), 0 8px 24px rgba(17,18,19,0.06);
            --shadow-lg: 0 4px 12px rgba(17,18,19,0.05), 0 20px 48px rgba(17,18,19,0.08);
            --cass-black: #1b1b1b;
            --cass-cream: #f7f3ed;
            --cass-gold: #c49a4a;
            --cass-teal: #1f6f6b;
            --cass-moss: #2f3d33;
            --green: #1a7a3a;
            --green-bg: rgba(26,122,58,0.08);
            --red: #b5342a;
            --red-bg: rgba(181,52,42,0.08);
            --amber: #8b6b1f;
            --amber-bg: rgba(196,154,74,0.12);
            --radius: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "IBM Plex Sans", "Space Grotesk", sans-serif;
            background: radial-gradient(circle at top left, #fdfbf7 0%, var(--cass-cream) 45%, #f1ede6 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        /* ---- Shell ---- */
        .app-shell {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .brand-bar {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 28px;
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: 0.5px;
        }

        .brand-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--cass-gold);
            box-shadow: 0 0 0 3px rgba(196,154,74,0.2);
        }

        .header-pill {
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.18);
            cursor: pointer;
            transition: border-color 0.2s;
            background: transparent;
            color: #f7f1e8;
            font-size: 13px;
            font-family: inherit;
        }
        .header-pill:hover { border-color: rgba(255,255,255,0.4); }

        /* ---- Side Nav ---- */
        .side-nav {
            padding: 24px 16px;
            border-right: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.35) 100%);
        }

        .side-nav h2 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--slate);
            margin-bottom: 14px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 13.5px;
            color: var(--ink-soft);
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }
        .nav-item:hover { background: rgba(27,27,27,0.04); }
        .nav-item.active {
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .nav-item span.dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--cass-gold);
            opacity: 0.6;
            flex-shrink: 0;
        }
        .nav-item.active span.dot { opacity: 1; }

        .brand-select-wrap {
            margin-top: 20px;
            padding: 0 8px;
        }
        .brand-select-wrap label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--slate);
            display: block;
            margin-bottom: 6px;
        }
        .brand-select-wrap select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--card);
            font-size: 13px;
            font-family: inherit;
            color: var(--ink);
            cursor: pointer;
        }

        /* ---- Main ---- */
        .main-area {
            padding: 28px 32px 48px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        .page-header h1 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        .page-header .subtitle {
            font-size: 13px;
            color: var(--slate);
            margin-top: 2px;
        }

        .meta-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(27,27,27,0.05);
            color: var(--ink-soft);
        }

        /* ---- Tabs ---- */
        .tab-panel { display: none; }
        .tab-panel.active { display: flex; flex-direction: column; gap: 22px; }

        /* ---- KPI Cards ---- */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 14px;
        }
        .kpi-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
        }
        .kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--slate);
            margin-bottom: 6px;
        }
        .kpi-value {
            font-family: "Space Grotesk", sans-serif;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--ink);
        }

        /* ---- Tables ---- */
        .table-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
        }
        .table-title {
            font-family: "Space Grotesk", sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead th {
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--slate);
            padding: 10px 10px;
            border-bottom: 2px solid var(--line);
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 1;
        }
        th.num, td.num { text-align: right; font-variant-numeric: tabular-nums; }
        tbody td {
            padding: 10px 10px;
            border-bottom: 1px solid var(--line);
            vertical-align: middle;
        }
        tbody tr:hover { background: var(--stone); }
        tbody tr.clickable { cursor: pointer; }

        .delta-positive { color: var(--green); }
        .delta-negative { color: var(--red); }

        /* ---- Search ---- */
        .search-wrap {
            position: relative;
            max-width: 420px;
        }
        .search-wrap input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: var(--card);
            font-size: 14px;
            font-family: inherit;
            color: var(--ink);
        }
        .search-wrap input:focus {
            outline: none;
            border-color: var(--cass-gold);
            box-shadow: 0 0 0 3px rgba(196,154,74,0.12);
        }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            margin-top: 4px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .autocomplete-list.visible { display: block; }
        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--line);
        }
        .autocomplete-item:hover { background: var(--stone); }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item .sku-hint {
            font-size: 11px;
            color: var(--slate);
            margin-left: 6px;
        }

        /* ---- Range Selector ---- */
        .range-pills {
            display: flex;
            gap: 6px;
        }
        .range-pill {
            padding: 6px 16px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: transparent;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
            color: var(--slate);
            cursor: pointer;
            transition: all 0.15s;
        }
        .range-pill.active {
            background: var(--cass-black);
            color: #f7f1e8;
            border-color: var(--cass-black);
        }

        /* ---- SKU Detail ---- */
        .sku-detail-panel {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
        }
        .sku-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
        }
        .sku-header h2 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 18px;
            font-weight: 600;
        }
        .sku-header .sku-meta {
            font-size: 12px;
            color: var(--slate);
            margin-top: 2px;
        }

        .sku-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .sku-stat {
            background: var(--stone);
            border-radius: 12px;
            padding: 14px;
        }
        .ss-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate);
            margin-bottom: 4px;
        }
        .ss-value {
            font-family: "Space Grotesk", sans-serif;
            font-size: 20px;
            font-weight: 600;
        }

        .sku-sub-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-top: 16px;
        }

        /* ---- SVG Chart ---- */
        .chart-container { position: relative; }
        .history-chart-wrap {
            background: var(--stone);
            border-radius: 12px;
            padding: 12px 8px 8px;
        }
        .chart-tooltip {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--cass-black);
            color: #f7f1e8;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 160px;
            pointer-events: none;
            z-index: 50;
        }
        .chart-tooltip.visible { display: block; }
        .tt-date { color: var(--cass-gold); font-weight: 600; margin-bottom: 6px; }
        .tt-row { display: flex; justify-content: space-between; gap: 16px; margin-top: 3px; }
        .tt-label { color: #b0adb4; }
        .tt-val { font-weight: 600; }

        .history-legend {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--slate);
        }
        .legend-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }

        /* ---- Pagination ---- */
        .pagination {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin-top: 12px;
        }
        .pagination button {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: var(--card);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            color: var(--ink);
        }
        .pagination button:hover { background: var(--stone); }
        .pagination button.active {
            background: var(--cass-black);
            color: #f7f1e8;
            border-color: var(--cass-black);
        }
        .pagination button:disabled { opacity: 0.4; cursor: default; }
        .pagination .page-info {
            font-size: 12px;
            color: var(--slate);
            padding: 0 8px;
        }

        /* ---- Loading ---- */
        .loading-msg {
            text-align: center;
            padding: 40px 0;
            color: var(--slate);
            font-size: 14px;
        }

        /* ---- Category Filter ---- */
        .filter-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-row select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--card);
            font-size: 13px;
            font-family: inherit;
            color: var(--ink);
            min-width: 160px;
        }

        /* ---- Responsive ---- */
        @media (max-width: 900px) {
            .app-shell { grid-template-columns: 1fr; }
            .side-nav { display: none; }
            .main-area { padding: 18px 14px 32px; }
            .sku-sub-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- Brand Bar -->
        <div class="brand-bar">
            <div class="brand-mark">
                <div class="brand-dot"></div>
                <span style="font-size:15px;font-weight:600;">Cass Brothers</span>
                <span style="opacity:0.5;font-size:13px;margin-left:4px;">Brand Portal</span>
            </div>
            <div style="display:flex;gap:10px;">
                <span class="meta-badge" id="snapshot-badge" style="background:rgba(255,255,255,0.1);color:#b0adb4;"></span>
            </div>
        </div>

        <!-- Side Nav -->
        <nav class="side-nav">
            <h2>Brand Portal</h2>
            <a class="nav-item active" data-tab="overview" onclick="switchTab('overview')"><span class="dot"></span> Brand Overview</a>
            <a class="nav-item" data-tab="catalogue" onclick="switchTab('catalogue')"><span class="dot"></span> Product Catalogue</a>
            <a class="nav-item" data-tab="detail" onclick="switchTab('detail')"><span class="dot"></span> Product Detail</a>

            <div class="brand-select-wrap">
                <label>Select Brand</label>
                <select id="brand-selector" onchange="onBrandChange()">
                    <option value="">Loading...</option>
                </select>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-area">
            <div class="page-header">
                <div>
                    <h1 id="page-title">Brand Portal</h1>
                    <div class="subtitle" id="page-subtitle">Market pricing intelligence for suppliers</div>
                </div>
            </div>

            <!-- ===================== TAB 1: OVERVIEW ===================== -->
            <div class="tab-panel active" id="tab-overview">
                <div class="kpi-row" id="overview-kpis">
                    <div class="kpi-card"><div class="kpi-label">Total SKUs</div><div class="kpi-value" id="kpi-total-skus">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Avg Selling Price</div><div class="kpi-value" id="kpi-avg-price">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Avg Discount off RRP</div><div class="kpi-value" id="kpi-avg-discount">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Competitors Stocking</div><div class="kpi-value" id="kpi-competitors">-</div></div>
                </div>

                <div class="table-card">
                    <div class="table-title">Category Breakdown</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="num">SKUs</th>
                                <th class="num">Avg Price</th>
                                <th class="num">Avg Discount %</th>
                                <th class="num">Competitors</th>
                            </tr>
                        </thead>
                        <tbody id="category-table"><tr><td colspan="5" class="loading-msg">Select a brand to begin</td></tr></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <div class="table-title">Competitor Pricing</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Competitor</th>
                                <th class="num">Products Stocked</th>
                                <th class="num">Avg Price</th>
                                <th class="num">Avg Discount from RRP</th>
                                <th class="num">Times Cheapest</th>
                            </tr>
                        </thead>
                        <tbody id="competitor-table"><tr><td colspan="5" class="loading-msg">Select a brand to begin</td></tr></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <div class="table-title">Monthly Trends</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="num">Avg Selling Price</th>
                                <th class="num">Avg Discount %</th>
                                <th class="num">Snapshots</th>
                            </tr>
                        </thead>
                        <tbody id="trend-table"><tr><td colspan="4" class="loading-msg">Select a brand to begin</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- ===================== TAB 2: CATALOGUE ===================== -->
            <div class="tab-panel" id="tab-catalogue">
                <div class="filter-row">
                    <div class="search-wrap" style="flex:1;max-width:320px;">
                        <input type="text" id="cat-search" placeholder="Search SKU or product..." onkeypress="if(event.key==='Enter')loadProducts()">
                    </div>
                    <select id="cat-filter" onchange="loadProducts()">
                        <option value="">All Categories</option>
                    </select>
                    <button class="header-pill" style="background:var(--cass-moss);color:#fff;border:none;" onclick="loadProducts()">Search</button>
                </div>

                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th class="num">RRP</th>
                                <th class="num">Our Price</th>
                                <th class="num">Discount %</th>
                                <th class="num">Market Low</th>
                                <th>Cheapest</th>
                                <th class="num"># Comp.</th>
                            </tr>
                        </thead>
                        <tbody id="product-table"><tr><td colspan="9" class="loading-msg">Select a brand to begin</td></tr></tbody>
                    </table>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>

            <!-- ===================== TAB 3: PRODUCT DETAIL ===================== -->
            <div class="tab-panel" id="tab-detail">
                <div class="filter-row">
                    <div class="search-wrap" style="flex:1;max-width:420px;">
                        <input type="text" id="sku-search" placeholder="Search SKU or product name..." oninput="onSkuSearchInput()" onkeypress="if(event.key==='Enter')loadSkuDetail(this.value)">
                        <div class="autocomplete-list" id="sku-autocomplete"></div>
                    </div>
                    <div class="range-pills">
                        <button class="range-pill" data-days="30" onclick="setRange(30)">30d</button>
                        <button class="range-pill active" data-days="90" onclick="setRange(90)">90d</button>
                        <button class="range-pill" data-days="365" onclick="setRange(365)">1yr</button>
                    </div>
                </div>

                <div id="sku-detail-container">
                    <div class="loading-msg">Search for a product to see pricing detail</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        /* ============================================================
           State
           ============================================================ */
        let currentBrand = '';
        let currentPage = 1;
        let currentDays = 90;
        let searchDebounce = null;

        const fmt = (v, dec = 2) => v == null ? '\u2014' : '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: dec, maximumFractionDigits: dec});
        const pct = (v) => v == null ? '\u2014' : v.toFixed(1) + '%';

        /* ============================================================
           Init
           ============================================================ */
        async function init() {
            const res = await fetch('/brand-portal/brands');
            const brands = await res.json();
            const sel = document.getElementById('brand-selector');
            sel.innerHTML = '<option value="">-- Select Brand --</option>';
            brands.forEach(b => {
                sel.innerHTML += `<option value="${b.brand}">${b.brand} (${b.sku_count} SKUs)</option>`;
            });

            // Auto-select from URL param
            const params = new URLSearchParams(window.location.search);
            if (params.get('brand')) {
                sel.value = params.get('brand');
                onBrandChange();
            }
        }
        init();

        /* ============================================================
           Navigation
           ============================================================ */
        function switchTab(tab) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');
        }

        function onBrandChange() {
            const sel = document.getElementById('brand-selector');
            currentBrand = sel.value;
            if (!currentBrand) return;

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('brand', currentBrand);
            window.history.replaceState({}, '', url);

            document.getElementById('page-title').textContent = currentBrand + ' Brand Portal';

            loadOverview();
            loadProducts();
        }

        /* ============================================================
           TAB 1: Overview
           ============================================================ */
        async function loadOverview() {
            if (!currentBrand) return;

            document.getElementById('category-table').innerHTML = '<tr><td colspan="5" class="loading-msg">Loading...</td></tr>';
            document.getElementById('competitor-table').innerHTML = '<tr><td colspan="5" class="loading-msg">Loading...</td></tr>';
            document.getElementById('trend-table').innerHTML = '<tr><td colspan="4" class="loading-msg">Loading...</td></tr>';

            const res = await fetch(`/brand-portal/overview?brand=${encodeURIComponent(currentBrand)}`);
            const data = await res.json();
            const k = data.kpis || {};

            // KPIs
            document.getElementById('kpi-total-skus').textContent = k.total_skus ?? '-';
            document.getElementById('kpi-avg-price').textContent = k.avg_selling_price != null ? fmt(k.avg_selling_price) : '-';
            document.getElementById('kpi-avg-discount').textContent = k.avg_discount_off_rrp != null ? pct(k.avg_discount_off_rrp) : '-';
            document.getElementById('kpi-competitors').textContent = k.competitors_stocking ?? '-';
            document.getElementById('snapshot-badge').textContent = k.snapshot_date ? 'Snapshot: ' + k.snapshot_date : '';

            // Category table
            const catTbody = document.getElementById('category-table');
            if (data.categories && data.categories.length) {
                catTbody.innerHTML = data.categories.map(c => `
                    <tr>
                        <td>${c.category}</td>
                        <td class="num">${c.sku_count}</td>
                        <td class="num">${fmt(c.avg_price)}</td>
                        <td class="num">${pct(c.avg_discount_pct)}</td>
                        <td class="num">${c.num_competitors}</td>
                    </tr>
                `).join('');
            } else {
                catTbody.innerHTML = '<tr><td colspan="5" class="loading-msg">No data</td></tr>';
            }

            // Competitor table
            const compTbody = document.getElementById('competitor-table');
            if (data.competitors && data.competitors.length) {
                compTbody.innerHTML = data.competitors.map(c => `
                    <tr>
                        <td>${c.competitor}</td>
                        <td class="num">${c.products_stocked}</td>
                        <td class="num">${fmt(c.avg_price)}</td>
                        <td class="num">${pct(c.avg_discount_from_rrp)}</td>
                        <td class="num">${c.times_cheapest}</td>
                    </tr>
                `).join('');
            } else {
                compTbody.innerHTML = '<tr><td colspan="5" class="loading-msg">No data</td></tr>';
            }

            // Monthly trends
            const trendTbody = document.getElementById('trend-table');
            if (data.monthly_trends && data.monthly_trends.length) {
                trendTbody.innerHTML = data.monthly_trends.map(t => `
                    <tr>
                        <td>${t.month}</td>
                        <td class="num">${fmt(t.avg_selling_price)}</td>
                        <td class="num">${pct(t.avg_discount_pct)}</td>
                        <td class="num">${t.snapshot_count.toLocaleString()}</td>
                    </tr>
                `).join('');
            } else {
                trendTbody.innerHTML = '<tr><td colspan="4" class="loading-msg">No data</td></tr>';
            }

            // Populate category filter on catalogue tab
            const catFilter = document.getElementById('cat-filter');
            catFilter.innerHTML = '<option value="">All Categories</option>';
            (data.categories || []).forEach(c => {
                catFilter.innerHTML += `<option value="${c.category}">${c.category} (${c.sku_count})</option>`;
            });
        }

        /* ============================================================
           TAB 2: Product Catalogue
           ============================================================ */
        async function loadProducts(page) {
            if (!currentBrand) return;
            currentPage = page || 1;

            const search = document.getElementById('cat-search').value;
            const category = document.getElementById('cat-filter').value;

            const tbody = document.getElementById('product-table');
            tbody.innerHTML = '<tr><td colspan="9" class="loading-msg">Loading...</td></tr>';

            let url = `/brand-portal/products?brand=${encodeURIComponent(currentBrand)}&page=${currentPage}&per_page=50`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;

            const res = await fetch(url);
            const data = await res.json();

            if (data.items && data.items.length) {
                tbody.innerHTML = data.items.map(p => {
                    const discCls = p.discount_pct > 15 ? 'delta-negative' : p.discount_pct > 5 ? '' : 'delta-positive';
                    return `
                    <tr class="clickable" onclick="showSkuFromCatalogue('${(p.sku||'').replace(/'/g,"\\'")}')">
                        <td style="font-weight:600;">${p.sku || '\u2014'}</td>
                        <td>${p.title || '\u2014'}</td>
                        <td>${p.category || '\u2014'}</td>
                        <td class="num">${fmt(p.rrp)}</td>
                        <td class="num">${fmt(p.our_price)}</td>
                        <td class="num ${discCls}">${pct(p.discount_pct)}</td>
                        <td class="num">${fmt(p.market_low)}</td>
                        <td>${p.cheapest_competitor || '\u2014'}</td>
                        <td class="num">${p.num_competitors}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="9" class="loading-msg">No products found</td></tr>';
            }

            // Pagination
            renderPagination(data.page, data.pages, data.total);
        }

        function renderPagination(page, pages, total) {
            const el = document.getElementById('pagination');
            if (pages <= 1) { el.innerHTML = ''; return; }

            let html = `<button ${page <= 1 ? 'disabled' : ''} onclick="loadProducts(${page - 1})">Prev</button>`;
            html += `<span class="page-info">Page ${page} of ${pages} (${total} products)</span>`;
            html += `<button ${page >= pages ? 'disabled' : ''} onclick="loadProducts(${page + 1})">Next</button>`;
            el.innerHTML = html;
        }

        function showSkuFromCatalogue(sku) {
            switchTab('detail');
            document.getElementById('sku-search').value = sku;
            loadSkuDetail(sku);
        }

        /* ============================================================
           TAB 3: Product Detail
           ============================================================ */
        function setRange(days) {
            currentDays = days;
            document.querySelectorAll('.range-pill').forEach(p => {
                p.classList.toggle('active', parseInt(p.dataset.days) === days);
            });
            const sku = document.getElementById('sku-search').value;
            if (sku) loadSkuDetail(sku);
        }

        let searchTimer = null;
        function onSkuSearchInput() {
            clearTimeout(searchTimer);
            const val = document.getElementById('sku-search').value.trim();
            if (val.length < 2) {
                document.getElementById('sku-autocomplete').classList.remove('visible');
                return;
            }
            searchTimer = setTimeout(() => searchSkus(val), 400);
        }

        async function searchSkus(query) {
            if (!currentBrand) return;
            const res = await fetch(`/brand-portal/search?brand=${encodeURIComponent(currentBrand)}&query=${encodeURIComponent(query)}`);
            const results = await res.json();
            const list = document.getElementById('sku-autocomplete');

            if (results.length) {
                list.innerHTML = results.map(r =>
                    `<div class="autocomplete-item" onclick="selectSku('${(r.sku||'').replace(/'/g,"\\'")}')">${r.title || r.sku}<span class="sku-hint">${r.sku}</span></div>`
                ).join('');
                list.classList.add('visible');
            } else {
                list.classList.remove('visible');
            }
        }

        function selectSku(sku) {
            document.getElementById('sku-search').value = sku;
            document.getElementById('sku-autocomplete').classList.remove('visible');
            loadSkuDetail(sku);
        }

        // Close autocomplete on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('.search-wrap')) {
                document.getElementById('sku-autocomplete').classList.remove('visible');
            }
        });

        async function loadSkuDetail(sku) {
            if (!currentBrand || !sku) return;
            const container = document.getElementById('sku-detail-container');
            container.innerHTML = '<div class="loading-msg">Loading...</div>';

            const res = await fetch(`/brand-portal/sku?brand=${encodeURIComponent(currentBrand)}&sku=${encodeURIComponent(sku)}&days=${currentDays}`);
            if (!res.ok) {
                container.innerHTML = '<div class="loading-msg">Product not found or does not belong to this brand</div>';
                return;
            }
            const data = await res.json();
            renderSkuDetail(data);
        }

        function renderSkuDetail(data) {
            const container = document.getElementById('sku-detail-container');
            const d = data.sku_info;
            const svgId = 'priceChart_' + Math.random().toString(36).slice(2, 8);
            const tooltipId = 'chartTip_' + Math.random().toString(36).slice(2, 8);

            let html = '<div class="sku-detail-panel">';

            // Header
            html += `<div class="sku-header">
                <div>
                    <h2>${d.title || d.sku}</h2>
                    <div class="sku-meta">SKU: ${d.sku} &middot; ${d.category || 'Uncategorised'} &middot; Snapshot: ${d.pricing_date}</div>
                </div>
            </div>`;

            // Stats grid
            html += '<div class="sku-stats-grid">';
            html += `<div class="sku-stat"><div class="ss-label">Our Price</div><div class="ss-value">${fmt(d.our_price)}</div></div>`;
            html += `<div class="sku-stat"><div class="ss-label">RRP</div><div class="ss-value">${fmt(d.rrp)}</div></div>`;
            html += `<div class="sku-stat"><div class="ss-label">Lowest Competitor</div><div class="ss-value" style="color:var(--cass-gold);">${fmt(d.lowest_competitor)}</div></div>`;
            html += `<div class="sku-stat"><div class="ss-label">Avg Market Price</div><div class="ss-value">${fmt(d.avg_market_price)}</div></div>`;
            html += '</div>';

            // Sub-grid: competitor map + chart
            html += '<div class="sku-sub-grid">';

            // Competitor map
            const sorted = [...(data.competitor_map || [])].sort((a, b) => a.price - b.price);
            html += '<div>';
            html += '<div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--slate);margin-bottom:8px;">Competitor Map</div>';
            html += '<table><thead><tr><th>Competitor</th><th class="num">Price</th><th class="num">Gap vs Us</th><th class="num">Gap vs RRP</th></tr></thead><tbody>';
            if (sorted.length) {
                sorted.forEach(c => {
                    const gCls = c.gap_vs_us != null ? (c.gap_vs_us < 0 ? 'delta-negative' : c.gap_vs_us > 0 ? 'delta-positive' : '') : '';
                    html += `<tr>
                        <td>${c.competitor}</td>
                        <td class="num">${fmt(c.price)}</td>
                        <td class="num ${gCls}">${c.gap_vs_us != null ? (c.gap_vs_us >= 0 ? '+' : '') + c.gap_vs_us.toFixed(2) : '\u2014'}</td>
                        <td class="num">${c.gap_vs_rrp != null ? (c.gap_vs_rrp >= 0 ? '+' : '') + c.gap_vs_rrp.toFixed(2) : '\u2014'}</td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="4" style="color:var(--slate);text-align:center;padding:16px 0;">No competitor prices</td></tr>';
            }
            html += '</tbody></table>';
            html += '</div>';

            // Price history chart
            html += '<div>';
            html += '<div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--slate);margin-bottom:8px;">Price History</div>';
            html += `<div class="chart-container"><div class="history-chart-wrap"><svg id="${svgId}" width="100%" height="220" viewBox="0 0 600 220" preserveAspectRatio="none"></svg></div><div class="chart-tooltip" id="${tooltipId}"></div></div>`;
            html += '<div class="history-legend">';
            html += '<span><span class="legend-dot" style="background:var(--cass-teal);"></span>Our price</span>';
            html += '<span><span class="legend-dot" style="background:var(--cass-gold);"></span>Lowest competitor</span>';
            html += '<span><span class="legend-dot" style="background:var(--slate);"></span>RRP</span>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // close sku-sub-grid
            html += '</div>'; // close panel

            container.innerHTML = html;

            // Render chart
            renderHistoryChart(data.price_history || [], svgId, tooltipId);
        }

        /* ============================================================
           SVG Price History Chart
           ============================================================ */
        function renderHistoryChart(history, svgId, tooltipId) {
            const svg = document.getElementById(svgId);
            const tooltip = document.getElementById(tooltipId);
            if (!svg) return;
            svg.innerHTML = '';

            if (!history.length) {
                svg.innerHTML = '<text x="300" y="110" fill="#6b6670" text-anchor="middle" font-size="13">No history available</text>';
                return;
            }

            const W = 600, H = 220;
            const PRICE_TOP = 10, PRICE_BOTTOM = 200;
            const priceH = PRICE_BOTTOM - PRICE_TOP;

            const step = W / Math.max(history.length - 1, 1);

            // Price scale
            const priceVals = history.flatMap(r => [r.our_price, r.lowest_competitor, r.rrp]).filter(v => v != null);
            if (!priceVals.length) return;
            const pMin = Math.min(...priceVals);
            const pMax = Math.max(...priceVals);
            const pPad = (pMax - pMin) * 0.12 || 1;
            const scaleMin = pMin - pPad;
            const scaleMax = pMax + pPad;

            function toY(v) {
                return v == null ? null : PRICE_TOP + priceH - ((v - scaleMin) / (scaleMax - scaleMin)) * priceH;
            }

            let svgContent = '';

            // Price lines
            function makePath(key, color, width, opacity, dasharray) {
                const pts = [];
                history.forEach((r, i) => {
                    const y = toY(r[key]);
                    if (y != null) pts.push(`${pts.length === 0 ? 'M' : 'L'} ${i * step} ${y}`);
                });
                if (pts.length) {
                    const da = dasharray ? ` stroke-dasharray="${dasharray}"` : '';
                    svgContent += `<path d="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="${width}" opacity="${opacity}"${da}/>`;
                }
            }

            makePath('rrp', '#6b6670', 1.5, 0.4, '5,4');     // RRP dashed gray
            makePath('lowest_competitor', '#c49a4a', 2, 0.8);  // Competitor gold
            makePath('our_price', '#1f6f6b', 2.5, 1);          // Our price teal

            // Hover targets
            history.forEach((r, i) => {
                const x = i * step - step / 2;
                const w = step;
                svgContent += `<rect class="hover-target" data-idx="${i}" x="${Math.max(x, 0)}" y="0" width="${Math.min(w, W)}" height="${H}" fill="transparent" style="cursor:crosshair"/>`;
            });

            // Crosshair
            svgContent += `<line id="xhair_${svgId}" x1="0" y1="0" x2="0" y2="${H}" stroke="var(--cass-gold)" stroke-width="1" stroke-dasharray="3,3" opacity="0"/>`;

            svg.innerHTML = svgContent;

            // Hover interaction
            const crosshair = svg.querySelector(`#xhair_${svgId}`);

            svg.querySelectorAll('.hover-target').forEach(rect => {
                rect.addEventListener('mouseenter', () => {
                    const idx = parseInt(rect.dataset.idx);
                    const r = history[idx];
                    const cx = idx * step;

                    crosshair.setAttribute('x1', cx);
                    crosshair.setAttribute('x2', cx);
                    crosshair.setAttribute('opacity', '0.6');

                    let ttHtml = `<div class="tt-date">${r.date}</div>`;
                    if (r.our_price != null) ttHtml += `<div class="tt-row"><span class="tt-label">Our price</span><span class="tt-val">${fmt(r.our_price)}</span></div>`;
                    if (r.lowest_competitor != null) {
                        ttHtml += `<div class="tt-row"><span class="tt-label" style="color:#c49a4a;font-weight:700;">${r.lowest_competitor_name || 'Lowest'}</span><span class="tt-val" style="color:#c49a4a;font-weight:700;">${fmt(r.lowest_competitor)}</span></div>`;
                    }
                    if (r.rrp != null) ttHtml += `<div class="tt-row"><span class="tt-label">RRP</span><span class="tt-val">${fmt(r.rrp)}</span></div>`;

                    tooltip.innerHTML = ttHtml;
                    tooltip.classList.add('visible');
                });

                rect.addEventListener('mouseleave', () => {
                    crosshair.setAttribute('opacity', '0');
                    tooltip.classList.remove('visible');
                });
            });
        }
    </script>
</body>
</html>
