<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Intelligence - Cass Brothers</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

        :root {
            --ink: #1c1b1f;
            --ink-soft: #3d3a40;
            --slate: #6b6670;
            --stone: #f4f2ee;
            --pearl: #faf9f6;
            --cass-black: #1b1b1b;
            --cass-cream: #f7f3ed;
            --cass-gold: #c49a4a;
            --cass-moss: #2f3d33;
            --cass-teal: #1f6f6b;
            --card: #ffffff;
            --line: rgba(27, 27, 27, 0.08);
            --shadow: 0 18px 45px rgba(17, 18, 19, 0.08);
            --red: #a63a3a;
            --red-bg: rgba(166, 58, 58, 0.1);
            --amber: #8b6b1f;
            --amber-bg: rgba(196, 154, 74, 0.15);
            --green: #2f6b3a;
            --green-bg: rgba(47, 107, 58, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "IBM Plex Sans", "Space Grotesk", sans-serif;
            background: radial-gradient(circle at top left, #fdfbf7 0%, var(--cass-cream) 45%, #f1ede6 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .brand-bar {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: 0.5px;
        }

        .brand-dot {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--cass-gold);
            box-shadow: 0 0 0 4px rgba(196, 154, 74, 0.2);
        }

        .brand-bar input {
            width: min(520px, 50vw);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            padding: 10px 16px;
            color: #f7f1e8;
            outline: none;
            font-size: 14px;
        }

        .brand-bar input::placeholder { color: rgba(247, 241, 232, 0.6); }

        .brand-actions { display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .pill { padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(255, 255, 255, 0.2); }

        .side-nav {
            grid-row: 2 / span 1;
            padding: 28px 20px;
            border-right: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.4) 100%);
        }

        .side-nav h2 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--slate);
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 12px; font-size: 14px;
            color: var(--ink-soft); margin-bottom: 6px; cursor: pointer;
            transition: all 0.2s ease; text-decoration: none;
        }

        .nav-item.active {
            background: var(--cass-black); color: #f7f1e8;
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .nav-item span { width: 8px; height: 8px; border-radius: 50%; background: var(--cass-gold); opacity: 0.7; }

        .main-area {
            grid-row: 2;
            padding: 28px 32px 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        /* Header */
        .overview {
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
        }
        .overview h1 { font-family: "Space Grotesk", sans-serif; font-size: 26px; }
        .time-pill { padding: 8px 14px; border-radius: 999px; background: rgba(27,27,27,0.06); font-size: 13px; color: var(--ink-soft); }

        /* Health Score Hero */
        .health-hero {
            display: flex; align-items: center; gap: 28px;
            background: var(--card); border-radius: 18px; padding: 24px 28px;
            border: 1px solid var(--line); box-shadow: var(--shadow);
        }

        .score-ring {
            position: relative; width: 100px; height: 100px; flex-shrink: 0;
        }

        .score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }

        .score-ring .bg { fill: none; stroke: #ede9e2; stroke-width: 8; }
        .score-ring .fg { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }

        .score-number {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-family: "Space Grotesk", sans-serif; font-size: 28px; font-weight: 700;
        }

        .health-breakdown { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        .health-item { text-align: center; }
        .health-item .hi-label { font-size: 12px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; }
        .health-item .hi-value { font-size: 22px; font-weight: 600; margin-top: 4px; }
        .health-item .hi-status { font-size: 11px; margin-top: 4px; padding: 2px 8px; border-radius: 999px; display: inline-block; }

        .status-good { background: var(--green-bg); color: var(--green); }
        .status-warning { background: var(--amber-bg); color: var(--amber); }
        .status-critical { background: var(--red-bg); color: var(--red); }
        .status-nodata { background: rgba(107, 102, 112, 0.1); color: var(--slate); }

        /* Critical Issues Banner */
        .critical-banner {
            background: var(--red-bg); border: 1px solid rgba(166,58,58,0.2);
            border-radius: 14px; padding: 14px 18px;
            display: none; gap: 10px; flex-direction: column;
        }

        .critical-banner.visible { display: flex; }

        .critical-banner h3 { color: var(--red); font-size: 14px; font-family: "Space Grotesk", sans-serif; }

        .critical-item {
            font-size: 13px; color: var(--red); padding: 8px 12px;
            background: rgba(255,255,255,0.6); border-radius: 10px;
        }

        /* Section Cards */
        .section-card {
            background: var(--card); border-radius: 18px; padding: 0;
            border: 1px solid var(--line); box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; cursor: pointer; user-select: none;
            transition: background 0.15s;
        }

        .section-header:hover { background: rgba(0,0,0,0.02); }

        .section-header h3 {
            font-family: "Space Grotesk", sans-serif; font-size: 16px;
            display: flex; align-items: center; gap: 10px;
        }

        .section-badge {
            font-size: 11px; padding: 2px 8px; border-radius: 999px;
            font-family: "IBM Plex Sans", sans-serif; font-weight: 500;
        }

        .section-score { font-size: 14px; color: var(--slate); display: flex; align-items: center; gap: 8px; }
        .section-score strong { font-size: 18px; color: var(--ink); }

        .chevron { transition: transform 0.2s; font-size: 12px; color: var(--slate); }
        .section-header.collapsed .chevron { transform: rotate(-90deg); }

        .section-body { padding: 0 20px 18px; }
        .section-body.hidden { display: none; }

        .issue-list { display: flex; flex-direction: column; gap: 8px; }

        .issue-row {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 14px; border-radius: 12px; font-size: 13px;
            border: 1px solid var(--line); background: var(--pearl);
        }

        .issue-severity {
            flex-shrink: 0; width: 8px; height: 8px; border-radius: 50%; margin-top: 5px;
        }

        .sev-critical { background: var(--red); }
        .sev-warning { background: var(--cass-gold); }
        .sev-info { background: var(--cass-teal); }

        .issue-body { flex: 1; }
        .issue-title { font-weight: 500; color: var(--ink); }
        .issue-detail { color: var(--slate); font-size: 12px; margin-top: 2px; }
        .issue-file { font-family: monospace; font-size: 11px; color: var(--cass-teal); margin-top: 3px; }
        .issue-fix { font-size: 12px; color: var(--cass-moss); margin-top: 4px; font-style: italic; }

        .empty-state { text-align: center; padding: 20px; color: var(--slate); font-size: 13px; }

        .issue-link { font-size: 11px; margin-top: 3px; }
        .issue-link a { color: var(--cass-teal); text-decoration: none; font-family: monospace; }
        .issue-link a:hover { text-decoration: underline; }

        /* KPI Strip */
        .kpi-strip {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
            margin-bottom: 18px;
        }
        .kpi-item {
            background: var(--card); border-radius: 14px; padding: 16px 20px;
            border: 1px solid var(--line); box-shadow: var(--shadow);
        }
        .kpi-label { font-size: 12px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .kpi-value { font-size: 22px; font-weight: 600; font-family: "Space Grotesk", sans-serif; }
        .kpi-revenue .kpi-value { color: var(--red); }
        .kpi-issues .kpi-value { color: var(--ink); }
        .kpi-new .kpi-value { color: var(--cass-gold); }

        /* Priorities Panel */
        .priorities-panel {
            background: var(--card); border-radius: 16px; padding: 18px 22px;
            border: 1px solid var(--line); box-shadow: var(--shadow); margin-bottom: 18px;
        }
        .priorities-panel h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; font-family: "Space Grotesk", sans-serif; }
        .priority-item {
            display: flex; align-items: flex-start; gap: 12px; padding: 10px 0;
            border-bottom: 1px solid var(--line);
        }
        .priority-item:last-child { border-bottom: none; }
        .priority-num {
            flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%;
            background: var(--cass-gold); color: #fff; font-weight: 600; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .priority-body { flex: 1; }
        .priority-title { font-weight: 500; font-size: 14px; }
        .priority-impact { font-size: 12px; color: var(--red); font-weight: 500; margin-top: 2px; }
        .priority-action { font-size: 12px; color: var(--slate); margin-top: 2px; }

        /* Freshness Panel */
        .freshness-panel {
            background: var(--card); border-radius: 16px; padding: 18px 22px;
            border: 1px solid var(--line); box-shadow: var(--shadow); margin-bottom: 18px;
        }
        .freshness-panel h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; font-family: "Space Grotesk", sans-serif; }
        .freshness-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;
        }
        .freshness-item {
            padding: 10px 14px; border-radius: 10px; border: 1px solid var(--line);
            background: var(--pearl); font-size: 12px;
        }
        .freshness-source { font-weight: 500; color: var(--ink); margin-bottom: 3px; font-size: 13px; }
        .freshness-age { color: var(--slate); }
        .freshness-rows { color: var(--slate); font-size: 11px; }
        .freshness-item.stale { border-color: rgba(166, 58, 58, 0.3); background: var(--red-bg); }
        .freshness-item.fresh { border-color: rgba(47, 107, 58, 0.3); background: var(--green-bg); }
        .freshness-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
        .freshness-dot.stale { background: var(--red); }
        .freshness-dot.fresh { background: var(--green); }

        /* Two column grid for sections */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 18px;
        }

        .sections-grid .section-card.full-width {
            grid-column: 1 / -1;
        }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--slate); }

        .loading-spinner {
            display: inline-block; width: 24px; height: 24px;
            border: 3px solid #ede9e2; border-top-color: var(--cass-gold);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Refresh button */
        .refresh-btn {
            padding: 8px 16px; border-radius: 12px;
            background: var(--cass-moss); color: #f7f1e8;
            border: none; font-size: 13px; cursor: pointer;
            transition: background 0.2s;
        }
        .refresh-btn:hover { background: #35463b; }
        .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }
        .export-share-btn {
            padding: 8px 14px; border-radius: 12px;
            background: var(--card); color: var(--ink-soft);
            border: 1px solid var(--line); font-size: 12px; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .export-share-btn:hover { border-color: var(--cass-gold); color: var(--ink); }

        @media (max-width: 1200px) {
            .sections-grid { grid-template-columns: 1fr; }
            .health-breakdown { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .app-shell { grid-template-columns: 1fr; }
            .side-nav { display: flex; gap: 12px; overflow-x: auto; padding: 16px; }
            .main-area { padding: 20px; }
            .health-hero { flex-direction: column; text-align: center; }
            .health-breakdown { grid-template-columns: repeat(2, 1fr); }
        }

        /* Issue Detail Slide-over */
        .detail-overlay {
            position: fixed; inset: 0; background: rgba(27, 27, 27, 0.35);
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .detail-overlay.open { opacity: 1; pointer-events: auto; }

        .detail-panel {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: min(520px, 90vw); background: var(--card);
            box-shadow: -8px 0 40px rgba(0,0,0,0.12);
            z-index: 1001; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .detail-panel.open { transform: translateX(0); }

        .detail-topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 22px; border-bottom: 1px solid var(--line);
            background: var(--pearl);
        }
        .detail-topbar h2 { font-family: "Space Grotesk", sans-serif; font-size: 16px; font-weight: 600; }
        .detail-close {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--line);
            background: var(--card); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center; color: var(--slate);
        }
        .detail-close:hover { background: var(--stone); color: var(--ink); }

        .detail-content {
            flex: 1; overflow-y: auto; padding: 22px;
            display: flex; flex-direction: column; gap: 20px;
        }

        .detail-sev-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 500;
        }
        .detail-sev-badge.critical { background: var(--red-bg); color: var(--red); }
        .detail-sev-badge.warning { background: var(--amber-bg); color: var(--amber); }
        .detail-sev-badge.info { background: rgba(31, 111, 107, 0.1); color: var(--cass-teal); }

        .detail-sev-dot {
            width: 8px; height: 8px; border-radius: 50%;
        }
        .detail-sev-dot.critical { background: var(--red); }
        .detail-sev-dot.warning { background: var(--cass-gold); }
        .detail-sev-dot.info { background: var(--cass-teal); }

        .detail-title { font-family: "Space Grotesk", sans-serif; font-size: 20px; font-weight: 600; line-height: 1.3; }

        .detail-section {
            border: 1px solid var(--line); border-radius: 14px; flex-shrink: 0;
        }
        .detail-section-header {
            padding: 10px 16px; background: var(--pearl);
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--slate);
            border-radius: 14px 14px 0 0;
        }
        .detail-section-body { padding: 14px 16px; font-size: 13px; line-height: 1.6; color: var(--ink-soft); }

        .detail-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .detail-meta-item { padding: 10px 14px; border-radius: 10px; background: var(--pearl); }
        .detail-meta-label { font-size: 11px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-meta-value { font-size: 14px; font-weight: 500; margin-top: 2px; }

        .detail-fix-step {
            display: flex; align-items: flex-start; gap: 10px; padding: 8px 0;
            border-bottom: 1px solid var(--line);
        }
        .detail-fix-step:last-child { border-bottom: none; }
        .detail-step-num {
            flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
            background: var(--cass-moss); color: #fff; font-size: 11px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
        }
        .detail-step-text { font-size: 13px; color: var(--ink-soft); line-height: 1.5; }

        .detail-file-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 8px; background: rgba(31, 111, 107, 0.08);
            color: var(--cass-teal); font-family: monospace; font-size: 12px;
            text-decoration: none; transition: background 0.15s;
        }
        .detail-file-link:hover { background: rgba(31, 111, 107, 0.15); }

        .detail-impact-bar {
            padding: 12px 16px; border-radius: 12px; background: var(--red-bg);
            color: var(--red); font-weight: 500; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
        }

        /* Reliability Badges */
        .reliability-badge {
            display: inline-flex; align-items: center; gap: 3px;
            font-size: 10px; padding: 1px 7px; border-radius: 999px; font-weight: 500;
        }
        .reliability-badge.high-conf { background: var(--green-bg); color: var(--green); }
        .reliability-badge.med-conf { background: var(--amber-bg); color: var(--amber); }
        .reliability-badge.low-conf { background: rgba(107,102,112,0.1); color: var(--slate); }

        /* Impact Score */
        .impact-score { font-size: 10px; color: var(--slate); font-weight: 500; margin-top: 3px; }

        /* Time Window Toggle */
        .time-toggle { display: flex; gap: 4px; background: rgba(27,27,27,0.06); border-radius: 12px; padding: 3px; }
        .time-btn {
            padding: 6px 14px; border-radius: 10px; border: none;
            background: transparent; font-size: 13px; cursor: pointer;
            color: var(--ink-soft); font-weight: 500; transition: all 0.2s;
        }
        .time-btn.active { background: var(--cass-black); color: #f7f1e8; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        /* Auto-refresh countdown */
        .refresh-countdown {
            font-size: 11px; color: var(--slate); font-variant-numeric: tabular-nums;
            margin-right: -4px; min-width: 32px; text-align: right;
        }

        /* Severity filter pills */
        .filter-bar {
            display: flex; align-items: center; gap: 6px; margin-bottom: 14px;
        }
        .filter-bar label { font-size: 12px; color: var(--slate); font-weight: 500; margin-right: 2px; }
        .filter-pill {
            padding: 5px 14px; border-radius: 999px; border: 1px solid var(--line);
            background: var(--card); font-size: 12px; font-weight: 500; cursor: pointer;
            color: var(--ink-soft); transition: all 0.15s; user-select: none;
        }
        .filter-pill:hover { border-color: rgba(27,27,27,0.2); }
        .filter-pill.active { background: var(--cass-black); color: #f7f1e8; border-color: var(--cass-black); }
        .filter-pill .pill-count {
            display: inline-block; min-width: 16px; text-align: center;
            padding: 0 5px; margin-left: 4px; border-radius: 999px;
            font-size: 10px; font-weight: 600; background: rgba(0,0,0,0.08);
        }
        .filter-pill.active .pill-count { background: rgba(255,255,255,0.2); }

        /* Hidden issue rows via filter */
        .issue-row.sev-hidden { display: none !important; }

        /* Root-Cause Clustering */
        .cluster-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 14px; margin-top: 8px; border-radius: 10px;
            background: rgba(27,27,27,0.04); font-size: 13px; font-weight: 600;
            color: var(--ink-soft); cursor: pointer; user-select: none;
        }
        .cluster-header:first-child { margin-top: 0; }
        .cluster-count { font-size: 11px; padding: 2px 8px; border-radius: 999px; background: rgba(27,27,27,0.08); font-weight: 500; }
        .cluster-body.collapsed { display: none; }

        /* Show More Toggle */
        .show-more-btn {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            width: 100%; padding: 10px; margin-top: 6px; border: 1px dashed var(--line);
            border-radius: 10px; background: transparent; color: var(--slate);
            font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s;
        }
        .show-more-btn:hover { background: rgba(27,27,27,0.03); color: var(--ink-soft); border-color: rgba(27,27,27,0.18); }

        /* Slow Resource Row */
        .slow-resource-row {
            display: flex; align-items: center; gap: 10px; padding: 8px 0;
            border-bottom: 1px solid var(--line); font-size: 13px;
        }
        .slow-resource-row:last-child { border-bottom: none; }
        .slow-resource-type {
            font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            padding: 2px 7px; border-radius: 6px; background: rgba(27,27,27,0.06); color: var(--slate);
            flex-shrink: 0;
        }
        .slow-resource-url {
            flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            color: var(--ink-soft);
        }
        .slow-resource-time {
            font-weight: 600; flex-shrink: 0; font-variant-numeric: tabular-nums;
        }
        .slow-resource-time.slow { color: var(--red); }
        .slow-resource-time.moderate { color: var(--amber); }

        /* Trend Badges */
        .trend-badge { display: inline-flex; align-items: center; gap: 2px; font-size: 11px; font-weight: 500; padding: 1px 6px; border-radius: 6px; margin-left: 4px; }
        .trend-up-good { color: var(--green); background: var(--green-bg); }
        .trend-up-bad { color: var(--red); background: var(--red-bg); }
        .trend-down-good { color: var(--green); background: var(--green-bg); }
        .trend-down-bad { color: var(--red); background: var(--red-bg); }
        .trend-flat { color: var(--slate); background: rgba(107,102,112,0.1); }

        /* Owner + Status */
        .status-controls { display: flex; gap: 8px; padding: 12px 0; border-bottom: 1px solid var(--line); }
        .status-controls select, .status-controls input {
            padding: 8px 12px; border-radius: 10px; border: 1px solid var(--line);
            font-size: 13px; background: var(--pearl); color: var(--ink); outline: none;
        }
        .issue-row.resolved { opacity: 0.45; }
        .issue-status-badge {
            flex-shrink: 0; font-size: 10px; padding: 2px 8px; border-radius: 999px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }
        .issue-status-badge.acknowledged { background: var(--amber-bg); color: var(--amber); }
        .issue-status-badge.investigating { background: rgba(31,111,107,0.1); color: var(--cass-teal); }
        .issue-status-badge.resolved { background: var(--green-bg); color: var(--green); }
        .issue-status-badge.false_positive { background: rgba(107,102,112,0.1); color: var(--slate); }
        .show-resolved-toggle { font-size: 12px; color: var(--slate); cursor: pointer; padding: 6px 10px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .show-resolved-toggle input { cursor: pointer; }

        /* Action Buttons */
        .action-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line); }
        .action-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 16px; border-radius: 12px; border: 1px solid var(--line);
            background: var(--pearl); color: var(--ink); font-size: 13px;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
            font-family: "IBM Plex Sans", sans-serif;
        }
        .action-btn:hover { background: var(--stone); border-color: var(--cass-gold); }
        .action-btn.primary { background: var(--cass-moss); color: #f7f1e8; border-color: var(--cass-moss); }
        .action-btn.primary:hover { background: #35463b; }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Evidence Links */
        .evidence-links { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .evidence-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 8px;
            background: rgba(31,111,107,0.08); color: var(--cass-teal);
            font-size: 12px; text-decoration: none; transition: background 0.15s;
        }
        .evidence-link:hover { background: rgba(31,111,107,0.15); }
        .executive-panel { background:var(--card);border-radius:18px;padding:24px 28px;border:1px solid var(--line);box-shadow:var(--shadow);display:none;margin-bottom:20px; }
        .executive-panel.visible { display:block; }
        .executive-panel h2 { font-family:"Space Grotesk",sans-serif;font-size:20px;margin-bottom:16px; }
        .exec-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:20px; }
        .exec-card { padding:16px 20px;border-radius:14px;border:1px solid var(--line);background:var(--pearl); }
        .exec-card-label { font-size:12px;color:var(--slate);text-transform:uppercase;letter-spacing:0.5px; }
        .exec-card-value { font-size:24px;font-weight:600;font-family:"Space Grotesk",sans-serif;margin-top:4px; }
        .exec-card-detail { font-size:12px;color:var(--slate);margin-top:2px; }
        .exec-fix-item { display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--line); }
        .exec-fix-item:last-child { border-bottom:none; }
        .exec-fix-badge { flex-shrink:0;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:500; }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="brand-bar">
            <div class="brand-mark">
                <span class="brand-dot"></span>
                <strong>Cass Brothers Intelligence</strong>
            </div>
            <input type="search" placeholder="Search reports, SKUs, or alerts..." />
            <div class="brand-actions">
                <span class="pill">Analytics</span>
                <span class="pill">Live</span>
            </div>
        </div>

        <aside class="side-nav">
            <h2>Dashboards</h2>
            <a class="nav-item" href="/dashboard"><span></span> Overview</a>
            <a class="nav-item" href="/performance"><span></span> Performance</a>
            <a class="nav-item" href="/seo-dashboard"><span></span> SEO &amp; Content</a>
            <a class="nav-item" href="/ads-intelligence"><span></span> Ads Intelligence</a>
            <a class="nav-item" href="/finance-dashboard"><span></span> Finance</a>
            <a class="nav-item" href="/inventory"><span></span> Inventory</a>
            <a class="nav-item" href="/stock-worthiness"><span></span> Stock Worthiness</a>
            <a class="nav-item" href="/pricing-intel"><span></span> Pricing Intel</a>
            <a class="nav-item" href="/customer-intelligence"><span></span> Customer Intel</a>
            <a class="nav-item" href="/merchant-center-intel"><span></span> Merchant Center</a>
            <a class="nav-item" href="/strategic-intelligence"><span></span> Intelligence Brief</a>
            <a class="nav-item active" href="/site-intelligence"><span></span> Site Intelligence</a>
            <a class="nav-item" href="/brand-intelligence"><span></span> Brand Intelligence</a>
            <div style="border-top:1px solid rgba(27,27,27,0.08);margin-top:16px;padding-top:12px">
                <a class="nav-item" href="#" onclick="openInviteModal();return false" style="opacity:0.6"><span></span> Invite User</a>
                <a class="nav-item" href="#" onclick="fetch('/auth/logout',{method:'POST'}).then(()=>location.href='/auth/login');return false" style="opacity:0.6"><span></span> Logout</a>
            </div>
        </aside>

        <section class="main-area">
            <div class="overview">
                <div>
                    <h1>Site Intelligence</h1>
                    <p class="time-pill" id="last-refresh">Loading...</p>
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <label class="show-resolved-toggle" title="Show resolved & false-positive issues">
                        <input type="checkbox" id="show-resolved-cb" onchange="toggleShowResolved(this.checked)"> Show resolved
                    </label>
                    <div class="time-toggle" id="time-toggle">
                        <button class="time-btn" data-window="24h" onclick="setTimeWindow('24h')">24h</button>
                        <button class="time-btn active" data-window="7d" onclick="setTimeWindow('7d')">7d</button>
                        <button class="time-btn" data-window="30d" onclick="setTimeWindow('30d')">30d</button>
                    </div>
                    <button class="export-share-btn" id="exec-toggle-btn" onclick="toggleExecutiveView()" title="Toggle executive summary">Executive View</button>
                    <button class="export-share-btn" onclick="exportCSV()" title="Export all issues to CSV">Export CSV</button>
                    <button class="export-share-btn" id="copy-summary-btn" onclick="copySummary()" title="Copy executive summary to clipboard">Copy Summary</button>
                    <span class="refresh-countdown" id="refresh-countdown" title="Auto-refresh countdown"></span>
                    <button class="refresh-btn" id="refresh-btn" onclick="loadAll()">Refresh</button>
                </div>
            </div>

            <!-- Overall Health Score -->
            <div class="health-hero" id="health-hero">
                <div class="score-ring">
                    <svg viewBox="0 0 36 36">
                        <circle class="bg" cx="18" cy="18" r="15.9"/>
                        <circle class="fg" id="score-arc" cx="18" cy="18" r="15.9"
                            stroke-dasharray="100 100" stroke-dashoffset="100"/>
                    </svg>
                    <div class="score-number" id="score-number">--</div>
                </div>
                <div class="health-breakdown">
                    <div class="health-item">
                        <div class="hi-label">Data Quality</div>
                        <div class="hi-value" id="dq-score">--<span id="dq-trend"></span></div>
                        <div class="hi-status" id="dq-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Site Perf</div>
                        <div class="hi-value" id="sp-score">--<span id="sp-trend"></span></div>
                        <div class="hi-status" id="sp-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Code Health</div>
                        <div class="hi-value" id="ch-score">--<span id="ch-trend"></span></div>
                        <div class="hi-status" id="ch-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Redirects</div>
                        <div class="hi-value" id="rh-score">--<span id="rh-trend"></span></div>
                        <div class="hi-status" id="rh-status">...</div>
                    </div>
                </div>
            </div>

            <!-- KPI Impact Roll-up -->
            <div class="kpi-strip" id="kpi-strip" style="display:none">
                <div class="kpi-item kpi-revenue">
                    <div class="kpi-label">Revenue at Risk</div>
                    <div class="kpi-value" id="kpi-revenue">$0</div>
                </div>
                <div class="kpi-item kpi-issues">
                    <div class="kpi-label">Total Issues</div>
                    <div class="kpi-value" id="kpi-total-issues">0</div>
                </div>
                <div class="kpi-item kpi-new">
                    <div class="kpi-label">New Since Last Visit</div>
                    <div class="kpi-value" id="kpi-new-issues">--</div>
                </div>
            </div>

            <!-- Top 3 Priorities -->
            <div class="priorities-panel" id="priorities-panel" style="display:none">
                <h3>Top Priorities</h3>
                <div id="priorities-list"></div>
            </div>

            <!-- Executive Summary Panel -->
            <div class="executive-panel" id="executive-panel">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                    <h2>Executive Summary</h2>
                    <span class="time-pill" id="exec-period">This Week</span>
                </div>
                <div class="exec-grid" id="exec-grid"></div>
                <div id="exec-fixes"></div>
            </div>

            <!-- Critical Issues -->
            <div class="critical-banner" id="critical-banner">
                <h3 id="critical-title">Critical Issues</h3>
                <div id="critical-list"></div>
            </div>

            <!-- Data Freshness -->
            <div class="freshness-panel" id="freshness-panel" style="display:none">
                <h3>Data Freshness</h3>
                <div class="freshness-grid" id="freshness-grid"></div>
            </div>

            <!-- Severity Filter -->
            <div class="filter-bar" id="filter-bar">
                <label>Filter:</label>
                <button class="filter-pill active" data-filter="all" onclick="setSeverityFilter('all')">All</button>
                <button class="filter-pill" data-filter="critical" onclick="setSeverityFilter('critical')">Critical <span class="pill-count" id="filter-count-critical">0</span></button>
                <button class="filter-pill" data-filter="warning" onclick="setSeverityFilter('warning')">Warning <span class="pill-count" id="filter-count-warning">0</span></button>
                <button class="filter-pill" data-filter="info" onclick="setSeverityFilter('info')">Info <span class="pill-count" id="filter-count-info">0</span></button>
            </div>

            <!-- Section Cards -->
            <div class="sections-grid">

                <!-- Data Quality -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('dq')">
                        <h3>Data Quality <span class="section-badge status-good" id="dq-badge">--</span></h3>
                        <div class="section-score"><strong id="dq-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="dq-body">
                        <div class="issue-list" id="dq-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading data quality...</div>
                        </div>
                    </div>
                </div>

                <!-- Site Performance -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('sp')">
                        <h3>Site Performance <span class="section-badge status-good" id="sp-badge">--</span></h3>
                        <div class="section-score"><strong id="sp-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="sp-body">
                        <div class="issue-list" id="sp-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading site performance...</div>
                        </div>
                    </div>
                </div>

                <!-- Code Health -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('ch')">
                        <h3>Code Health <span class="section-badge status-good" id="ch-badge">--</span></h3>
                        <div class="section-score"><strong id="ch-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="ch-body">
                        <div class="issue-list" id="ch-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading code health...</div>
                        </div>
                    </div>
                </div>

                <!-- Redirects & 404s -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('rh')">
                        <h3>Redirects &amp; 404s <span class="section-badge status-good" id="rh-badge">--</span></h3>
                        <div class="section-score"><strong id="rh-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="rh-body">
                        <div class="issue-list" id="rh-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading redirect health...</div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Issue Detail Slide-over Panel -->
    <div class="detail-overlay" id="detail-overlay" onclick="closeIssueDetail()"></div>
    <div class="detail-panel" id="detail-panel">
        <div class="detail-topbar">
            <h2 id="detail-source">Issue Detail</h2>
            <button class="detail-close" onclick="closeIssueDetail()">&times;</button>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>

    <script>
        // --- Time Window ---
        let currentTimeWindow = '7d';
        function setTimeWindow(w) {
            currentTimeWindow = w;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.toggle('active', b.dataset.window === w));
            loadAll();
        }
        function getWindowParams() {
            if (currentTimeWindow === '24h') return { hours: 24, days: 1 };
            if (currentTimeWindow === '30d') return { hours: 720, days: 30 };
            return { hours: 168, days: 7 };
        }

        // --- Auto-Refresh (5 minutes) ---
        const AUTO_REFRESH_SECS = 300;
        let refreshSecsLeft = AUTO_REFRESH_SECS;
        let refreshTimerId = null;

        function startRefreshTimer() {
            clearInterval(refreshTimerId);
            refreshSecsLeft = AUTO_REFRESH_SECS;
            updateCountdown();
            refreshTimerId = setInterval(() => {
                if (document.hidden) return; // pause when tab not visible
                refreshSecsLeft--;
                if (refreshSecsLeft <= 0) {
                    loadAll();
                    // loadAll will call startRefreshTimer via its completion
                    return;
                }
                updateCountdown();
            }, 1000);
        }

        function updateCountdown() {
            const el = document.getElementById('refresh-countdown');
            if (!el) return;
            const m = Math.floor(refreshSecsLeft / 60);
            const s = refreshSecsLeft % 60;
            el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
        }

        // Reset timer when tab becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && refreshSecsLeft <= 0) loadAll();
        });

        // --- Severity Filter ---
        let activeSevFilter = 'all';

        function setSeverityFilter(sev) {
            activeSevFilter = sev;
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.toggle('active', p.dataset.filter === sev));
            applyFilter();
        }

        function applyFilter() {
            document.querySelectorAll('.issue-row').forEach(row => {
                if (activeSevFilter === 'all') {
                    row.classList.remove('sev-hidden');
                } else {
                    row.classList.toggle('sev-hidden', row.dataset.sev !== activeSevFilter);
                }
            });
            // Also hide/show "show more" buttons and cluster headers based on visible children
            document.querySelectorAll('.cluster-body').forEach(body => {
                const visibleRows = body.querySelectorAll('.issue-row:not(.sev-hidden)');
                const header = body.previousElementSibling;
                if (header && header.classList.contains('cluster-header')) {
                    header.style.display = visibleRows.length === 0 ? 'none' : '';
                }
                body.style.display = visibleRows.length === 0 ? 'none' : '';
            });
        }

        function updateFilterCounts() {
            let counts = { critical: 0, warning: 0, info: 0 };
            document.querySelectorAll('.issue-row').forEach(row => {
                const s = row.dataset.sev;
                if (s && counts[s] !== undefined) counts[s]++;
            });
            Object.entries(counts).forEach(([sev, c]) => {
                const el = document.getElementById('filter-count-' + sev);
                if (el) el.textContent = c;
            });
        }

        // --- True Impact Modeling ---
        let siteConversionRate = 0.025; // fallback default
        let siteAOV = 85.00;           // fallback default

        async function fetchSiteMetrics() {
            try {
                const res = await fetch('/monitor/metrics/live');
                if (!res.ok) return;
                const data = await res.json();
                const m = data.metrics || data;
                if (m.orders_today > 0 && m.revenue_today > 0) {
                    siteAOV = m.revenue_today / m.orders_today;
                }
                if (m.conversion_rate) {
                    const cr = typeof m.conversion_rate === 'string' ? parseFloat(m.conversion_rate) : m.conversion_rate;
                    if (!isNaN(cr) && cr > 0) siteConversionRate = cr > 1 ? cr / 100 : cr;
                }
            } catch (e) { /* keep defaults */ }
        }

        function computeImpactWeight(issue, source) {
            let dollarImpact = 0;
            let confidenceScore = 0;

            if (source === 'Redirects & 404s') {
                const hits = issue.traffic_hits || 0;
                if (issue.revenue_impact && issue.revenue_impact > 0) {
                    dollarImpact = issue.revenue_impact;
                    confidenceScore = 80;
                } else if (hits > 0) {
                    dollarImpact = hits * siteConversionRate * siteAOV;
                    confidenceScore = hits >= 100 ? 60 : hits >= 20 ? 40 : 20;
                } else {
                    dollarImpact = issue.severity === 'critical' ? siteAOV * 3 : siteAOV;
                    confidenceScore = 15;
                }
            } else if (source === 'Site Performance') {
                const ss = issue.sample_size || 0;
                let deltaFromGood = 0;
                const title = issue.title || '';
                if (title.includes('LCP')) {
                    const m = title.match(/([\d.]+)\s*s/); if (m) deltaFromGood = Math.max(0, parseFloat(m[1]) * 1000 - 2500);
                    if (!deltaFromGood) { const m2 = title.match(/([\d,]+)\s*ms/); if (m2) deltaFromGood = Math.max(0, parseInt(m2[1].replace(',','')) - 2500); }
                } else if (title.includes('CLS')) {
                    const m = title.match(/([\d.]+)/); if (m) deltaFromGood = Math.max(0, (parseFloat(m[1]) - 0.1) * 10000);
                } else if (title.includes('INP')) {
                    const m = title.match(/(\d+)\s*ms/); if (m) deltaFromGood = Math.max(0, parseInt(m[1]) - 200);
                }
                dollarImpact = (deltaFromGood / 100) * Math.sqrt(Math.max(1, ss)) * siteAOV * 0.01;
                confidenceScore = ss >= 100 ? 70 : ss >= 30 ? 45 : 20;
            } else if (source === 'Data Quality') {
                const desc = issue.description || issue.title || '';
                const lagMatch = desc.match(/(\d+)h?\s*ago/);
                const lagHours = lagMatch ? parseInt(lagMatch[1]) : 0;
                const thresholds = { shopify: 6, ga4: 72, analytics: 72, search: 96, ads: 48, merchant: 48 };
                let threshold = 24;
                const lower = (issue.title || '').toLowerCase();
                Object.keys(thresholds).forEach(k => { if (lower.includes(k)) threshold = thresholds[k]; });
                dollarImpact = lagHours > 0 ? (lagHours / threshold) * siteAOV * 5 : siteAOV;
                confidenceScore = lagHours > 0 ? 50 : 10;
            } else {
                dollarImpact = issue.severity === 'critical' ? siteAOV * 2 : issue.severity === 'warning' ? siteAOV * 0.5 : siteAOV * 0.1;
                confidenceScore = 30;
            }

            issue.dollarImpact = Math.round(dollarImpact);
            issue.confidenceLabel = confidenceScore >= 60 ? 'high' : confidenceScore >= 35 ? 'medium' : 'low';
            issue.confidenceScore = confidenceScore;

            // Backward-compatible 0-100 score
            const sevBase = issue.severity === 'critical' ? 30 : issue.severity === 'warning' ? 15 : 5;
            return Math.min(100, Math.round(dollarImpact / 50 + sevBase));
        }

        // --- Issue Tracker (localStorage) ---
        const slaDefaults = { critical: 3, warning: 7, info: 14 }; // days

        const issueTracker = {
            storageKey: 'site_intel_issue_status',
            data: JSON.parse(localStorage.getItem('site_intel_issue_status') || '{}'),
            getKey(source, issue) {
                // Use stable identifiers that don't change when counts/wording change
                if (typeof issue !== 'object') return btoa(unescape(encodeURIComponent(source + '|' + issue))).slice(0, 40);
                let stable = '';
                if (issue.requested_url || issue.url_path) {
                    // 404/redirect issues: URL path is the stable identity
                    stable = issue.requested_url || issue.url_path || '';
                } else if (issue.file_path && issue.category) {
                    // Code health: file + category (stable across re-scans)
                    stable = issue.file_path + '|' + issue.category;
                } else if (issue.file_path) {
                    stable = issue.file_path;
                } else if (issue._stableKey) {
                    // Explicitly assigned stable key (CWV metrics, data quality checks)
                    stable = issue._stableKey;
                } else {
                    // Fallback: title only (strip numbers to reduce churn)
                    stable = (issue.title || '').replace(/[\d,.]+/g, '#');
                }
                return btoa(unescape(encodeURIComponent(source + '|' + stable))).slice(0, 40);
            },
            getStatus(source, issue) { return this.data[this.getKey(source, issue)] || null; },
            setStatus(source, issue, status, owner, dueDate) {
                const key = this.getKey(source, issue);
                const existing = this.data[key] || {};
                const newDue = dueDate !== undefined ? dueDate : existing.dueDate || null;
                // Auto-assign SLA on acknowledge if no due date set
                let finalDue = newDue;
                if (status === 'acknowledged' && !finalDue && typeof issue === 'object') {
                    const sev = issue.severity || 'info';
                    const days = slaDefaults[sev] || 14;
                    const d = new Date(); d.setDate(d.getDate() + days);
                    finalDue = d.toISOString().slice(0, 10);
                }
                if (!status) {
                    // Clear status but keep timeline
                    if (existing.firstSeenAt) {
                        this.data[key] = { ...existing, status: '', owner: '', dueDate: null, updatedAt: new Date().toISOString() };
                    } else { delete this.data[key]; }
                } else {
                    this.data[key] = { ...existing, status, owner: owner || existing.owner || '', dueDate: finalDue, updatedAt: new Date().toISOString() };
                }
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            },
            // Timeline tracking
            updateTimeline(source, issue) {
                const key = this.getKey(source, issue);
                const now = new Date().toISOString();
                const today = now.slice(0, 10);
                if (!this.data[key]) {
                    this.data[key] = { status: '', owner: '', dueDate: null, updatedAt: now, firstSeenAt: now, lastSeenAt: now, seenCount: 1, seenCountHistory: [{ date: today, count: 1 }] };
                } else {
                    if (!this.data[key].firstSeenAt) this.data[key].firstSeenAt = now;
                    this.data[key].lastSeenAt = now;
                    this.data[key].seenCount = (this.data[key].seenCount || 0) + 1;
                    const hist = this.data[key].seenCountHistory || [];
                    const todayEntry = hist.find(h => h.date === today);
                    if (todayEntry) todayEntry.count++;
                    else hist.push({ date: today, count: 1 });
                    this.data[key].seenCountHistory = hist.slice(-14);
                }
            },
            getTimeline(source, issue) {
                const entry = this.data[this.getKey(source, issue)];
                if (!entry) return null;
                return { firstSeenAt: entry.firstSeenAt, lastSeenAt: entry.lastSeenAt, seenCount: entry.seenCount || 0, seenCountHistory: entry.seenCountHistory || [] };
            },
            setVerification(source, issue, result) {
                const key = this.getKey(source, issue);
                if (!this.data[key]) return;
                this.data[key].verifiedAt = new Date().toISOString();
                this.data[key].verifiedResult = result.passed ? 'passed' : 'failed';
                this.data[key].verifiedDetails = result.details || '';
                this.saveAll();
            },
            getVerification(source, issue) {
                const entry = this.data[this.getKey(source, issue)];
                if (!entry || !entry.verifiedAt) return null;
                return { verifiedAt: entry.verifiedAt, verifiedResult: entry.verifiedResult, verifiedDetails: entry.verifiedDetails };
            },
            setResolveSnapshot(source, issue, snapshot) {
                const key = this.getKey(source, issue);
                if (!this.data[key]) this.data[key] = { status: 'resolved', owner: '', dueDate: null, updatedAt: new Date().toISOString() };
                this.data[key].snapshotAtResolve = snapshot;
                this.data[key].resolvedAt = new Date().toISOString();
                this.saveAll();
            },
            getResolveSnapshot(source, issue) {
                const entry = this.data[this.getKey(source, issue)];
                return entry ? entry.snapshotAtResolve || null : null;
            },
            saveAll() { localStorage.setItem(this.storageKey, JSON.stringify(this.data)); },
            cleanup() {
                const cutoff = Date.now() - 90 * 86400000;
                Object.keys(this.data).forEach(key => {
                    const e = this.data[key];
                    if (e.lastSeenAt && new Date(e.lastSeenAt).getTime() < cutoff) delete this.data[key];
                });
                this.saveAll();
            }
        };
        let showResolved = false;
        let relatedIssuesMap = {};

        function extractNormalizedPath(issue) {
            if (!issue) return null;
            // Extract path from file_path
            if (issue.file_path) return issue.file_path.replace(/^\/+/, '/').toLowerCase();
            // Extract path from 404 titles like "404: /products/foo"
            if (issue.title) {
                const m = issue.title.match(/(?:404|301|302|redirect)[:\s]+\s*(\/\S+)/i);
                if (m) return m[1].toLowerCase().replace(/\?.*$/, '');
            }
            // Extract path from url field
            if (issue.url) {
                try { return new URL(issue.url, 'https://x.com').pathname.toLowerCase(); }
                catch (e) { return issue.url.startsWith('/') ? issue.url.toLowerCase() : null; }
            }
            return null;
        }

        function buildRelatedIssuesMap() {
            relatedIssuesMap = {};
            templateClusterMap = {};
            deployClusterMap = {};
            causeClusterMap = {};
            Object.entries(issueStore).forEach(([listId, store]) => {
                (store.issues || []).forEach((issue, idx) => {
                    const entry = { listId, idx, title: issue.title || issue.check_name || 'Issue', source: store.source, severity: issue.severity || 'info' };

                    // URL path clustering
                    const path = extractNormalizedPath(issue);
                    if (path) {
                        if (!relatedIssuesMap[path]) relatedIssuesMap[path] = [];
                        relatedIssuesMap[path].push(entry);
                    }

                    // Template clustering (code health)
                    if (store.source === 'Code Health' && issue.file_path) {
                        const tm = issue.file_path.match(/(?:sections|snippets|templates|layout)\/([^/.]+)/);
                        if (tm) {
                            const tpl = tm[1];
                            if (!templateClusterMap[tpl]) templateClusterMap[tpl] = [];
                            templateClusterMap[tpl].push({ ...entry, file_path: issue.file_path });
                        }
                    }

                    // Deploy-window clustering (same firstSeenAt date)
                    const tl = issueTracker.getTimeline(store.source, issue);
                    if (tl && tl.firstSeenAt) {
                        const dateKey = tl.firstSeenAt.slice(0, 10);
                        if (!deployClusterMap[dateKey]) deployClusterMap[dateKey] = [];
                        deployClusterMap[dateKey].push({ ...entry, firstSeenAt: tl.firstSeenAt });
                    }

                    // Cause clustering (redirects)
                    if (issue.likely_cause && issue.likely_cause !== 'unknown') {
                        const cause = issue.likely_cause;
                        if (!causeClusterMap[cause]) causeClusterMap[cause] = [];
                        causeClusterMap[cause].push(entry);
                    }
                });
            });
        }

        let templateClusterMap = {};
        let deployClusterMap = {};
        let causeClusterMap = {};

        // --- Trend Helpers ---
        function trendBadge(current, previous, higherIsBetter) {
            if (previous === null || previous === undefined || current === null || current === undefined) return '';
            const pct = previous === 0 ? 0 : Math.round(((current - previous) / Math.abs(previous)) * 100);
            if (Math.abs(pct) < 5) return '<span class="trend-badge trend-flat">Stable</span>';
            const up = pct > 0;
            const good = up === higherIsBetter;
            const cls = up ? (good ? 'trend-up-good' : 'trend-up-bad') : (good ? 'trend-down-good' : 'trend-down-bad');
            const arrow = up ? '&#9650;' : '&#9660;';
            return '<span class="trend-badge ' + cls + '">' + arrow + ' ' + Math.abs(pct) + '%</span>';
        }

        function toggleSection(id) {
            const body = document.getElementById(id + '-body');
            const header = body.previousElementSibling;
            body.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        }

        function setScore(elementId, score) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const val = score !== null && score !== undefined ? Math.round(score) : '--';
            // Preserve trend span by only updating the first text node
            const first = el.firstChild;
            if (first && first.nodeType === 3) { first.textContent = val; }
            else { el.textContent = val; }
        }

        function setStatus(elementId, score) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (score === null || score === undefined) { el.textContent = '...'; el.className = 'hi-status'; return; }
            if (score >= 80) { el.textContent = 'Good'; el.className = 'hi-status status-good'; }
            else if (score >= 50) { el.textContent = 'Warning'; el.className = 'hi-status status-warning'; }
            else { el.textContent = 'Critical'; el.className = 'hi-status status-critical'; }
        }

        function setBadge(elementId, score) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (score === null || score === undefined) { el.textContent = '--'; el.className = 'section-badge'; return; }
            const s = Math.round(score);
            if (s >= 80) { el.textContent = s + '/100'; el.className = 'section-badge status-good'; }
            else if (s >= 50) { el.textContent = s + '/100'; el.className = 'section-badge status-warning'; }
            else { el.textContent = s + '/100'; el.className = 'section-badge status-critical'; }
        }

        function setScoreRing(score) {
            const arc = document.getElementById('score-arc');
            const num = document.getElementById('score-number');
            if (!arc) return;
            const s = Math.max(0, Math.min(100, Math.round(score || 0)));
            const offset = 100 - s;
            arc.style.strokeDashoffset = offset;
            num.textContent = s;
            if (s >= 80) arc.style.stroke = 'var(--green)';
            else if (s >= 50) arc.style.stroke = 'var(--cass-gold)';
            else arc.style.stroke = 'var(--red)';
        }

        // Store all issues by section for detail panel access
        const issueStore = {};

        function renderIssueRow(issue, idx, listId) {
            const sev = issue.severity || 'info';
            const source = issueStore[listId] ? issueStore[listId].source : '';
            const tracked = issueTracker.getStatus(source, issue);
            const isResolved = tracked && (tracked.status === 'resolved' || tracked.status === 'false_positive');
            if (isResolved && !showResolved) return '';

            let linkHtml = '';
            if (issue.file_path) {
                const fp = issue.file_path;
                if (issue.github_url) {
                    linkHtml = '<div class="issue-link"><a href="' + esc(issue.github_url) + '" target="_blank" onclick="event.stopPropagation()">' + esc(fp) + (issue.line_number ? ':' + issue.line_number : '') + '</a></div>';
                } else if (fp.endsWith('.liquid') || fp.endsWith('.js') || fp.endsWith('.json') || fp.endsWith('.css')) {
                    linkHtml = '<div class="issue-file">' + esc(fp) + (issue.line_number ? ':' + issue.line_number : '') + '</div>';
                } else {
                    linkHtml = '<div class="issue-file">' + esc(fp) + '</div>';
                }
            }
            let impactHtml = '';
            if (issue.dollarImpact > 0) {
                const confCls = issue.confidenceLabel === 'high' ? 'high-conf' : issue.confidenceLabel === 'medium' ? 'med-conf' : 'low-conf';
                impactHtml = '<div class="issue-detail" style="color:var(--red);font-weight:500">~$' + issue.dollarImpact.toLocaleString() + '/mo impact <span class="reliability-badge ' + confCls + '">' + issue.confidenceLabel + '</span></div>';
            } else if (issue.revenue_impact) {
                impactHtml = '<div class="issue-detail" style="color:var(--red);font-weight:500">~$' + Math.round(issue.revenue_impact) + '/mo impact</div>';
            }

            let badgeHtml = '';
            if (tracked) badgeHtml = '<span class="issue-status-badge ' + tracked.status + '">' + tracked.status.replace('_', ' ') + '</span>';
            const verif = issueTracker.getVerification(source, issue);
            if (verif && verif.verifiedResult === 'passed') badgeHtml += ' <span class="issue-status-badge" style="background:var(--green-bg);color:var(--green)">VERIFIED</span>';

            // SLA overdue/due-soon badge
            let slaHtml = '';
            if (tracked && tracked.dueDate) {
                const hoursLeft = (new Date(tracked.dueDate + 'T23:59:59') - new Date()) / 3600000;
                if (hoursLeft < 0) slaHtml = '<span class="issue-status-badge" style="background:var(--red-bg);color:var(--red)">OVERDUE</span>';
                else if (hoursLeft < 24) slaHtml = '<span class="issue-status-badge" style="background:var(--amber-bg);color:var(--amber)">DUE SOON</span>';
            }

            let confHtml = '';
            if (issue.confidence_level) {
                const cls = issue.confidence_level === 'high' ? 'high-conf' : issue.confidence_level === 'medium' ? 'med-conf' : 'low-conf';
                confHtml = ' <span class="reliability-badge ' + cls + '">' + issue.confidence_level + '</span>';
            } else if (issue.sample_size !== undefined) {
                const cls = issue.sample_size >= 100 ? 'high-conf' : issue.sample_size >= 30 ? 'med-conf' : 'low-conf';
                confHtml = ' <span class="reliability-badge ' + cls + '">n=' + issue.sample_size + '</span>';
            }

            // NEW badge + trend arrow for issues
            let ageHtml = '';
            const tl = issueTracker.getTimeline(source, issue);
            if (tl && tl.firstSeenAt) {
                const ageDays = Math.floor((Date.now() - new Date(tl.firstSeenAt).getTime()) / 86400000);
                if (ageDays === 0) ageHtml = ' <span class="reliability-badge med-conf">NEW</span>';
            }
            let trendHtml = '';
            if (tl && tl.seenCountHistory && tl.seenCountHistory.length >= 3) {
                const splitAt = Math.max(1, tl.seenCountHistory.length - 3);
                const recent = tl.seenCountHistory.slice(splitAt).reduce((s, h) => s + h.count, 0);
                const older = tl.seenCountHistory.slice(0, splitAt).reduce((s, h) => s + h.count, 0);
                if (older > 0 && recent > older * 1.3) trendHtml = ' <span class="trend-badge trend-up-bad" title="Getting worse">&#9650;</span>';
                else if (older > 0 && recent < older * 0.7) trendHtml = ' <span class="trend-badge trend-down-good" title="Improving">&#9660;</span>';
            }

            return '<div class="issue-row' + (isResolved ? ' resolved' : '') + '" data-sev="' + sev + '" style="cursor:pointer" onclick="openIssueDetail(\'' + listId + '\',' + idx + ')">' +
                '<div class="issue-severity sev-' + sev + '"></div>' +
                '<div class="issue-body">' +
                    '<div class="issue-title">' + esc(issue.title || issue.check_name || 'Issue') + ageHtml + trendHtml + confHtml + '</div>' +
                    (issue.description ? '<div class="issue-detail">' + esc(issue.description) + '</div>' : '') +
                    impactHtml +
                    linkHtml +
                    (issue.recommendation || issue.fix ? '<div class="issue-fix">' + esc(issue.recommendation || issue.fix) + '</div>' : '') +
                '</div>' +
                (slaHtml ? slaHtml : '') +
                (badgeHtml ? badgeHtml : '') +
                '<span class="chevron" style="color:var(--slate);font-size:11px;align-self:center;flex-shrink:0">&#9654;</span>' +
            '</div>';
        }

        const INITIAL_SHOW = 8;

        function renderIssues(listId, issues, emptyMsg, source) {
            const el = document.getElementById(listId);
            if (!el) return;
            if (!issues || issues.length === 0) {
                el.innerHTML = '<div class="empty-state">' + (emptyMsg || 'No issues found') + '</div>';
                return;
            }
            issues.forEach(i => { i.impactWeight = computeImpactWeight(i, source); });
            issues.sort((a, b) => b.impactWeight - a.impactWeight);
            issueStore[listId] = { issues: issues, source: source || 'Issue' };

            let html = issues.slice(0, INITIAL_SHOW).map((issue, idx) => renderIssueRow(issue, idx, listId)).join('');
            if (issues.length > INITIAL_SHOW) {
                const hiddenId = listId + '_overflow';
                html += '<div id="' + hiddenId + '" style="display:none">';
                html += issues.slice(INITIAL_SHOW).map((issue, idx) => renderIssueRow(issue, idx + INITIAL_SHOW, listId)).join('');
                html += '</div>';
                html += '<button class="show-more-btn" id="' + listId + '_toggle" onclick="toggleShowAll(\'' + listId + '\')">' +
                    'Show all ' + issues.length + ' issues &#9662;</button>';
            }
            el.innerHTML = html;
            if (!el.innerHTML.trim()) el.innerHTML = '<div class="empty-state">' + (emptyMsg || 'No issues found') + '</div>';
        }

        // Root-cause clustering renderer
        const causeLabelMap = {
            deleted_product: 'Deleted Products', old_url_structure: 'Changed URLs',
            broken_external: 'External Broken Links', unknown: 'Unknown Cause',
            liquid: 'Liquid Templates', javascript: 'JavaScript', css: 'CSS',
            json: 'JSON', security: 'Security', performance: 'Performance', accessibility: 'Accessibility'
        };

        function renderClusteredIssues(listId, issues, emptyMsg, source, groupKey) {
            const el = document.getElementById(listId);
            if (!el) return;
            if (!issues || issues.length === 0) {
                el.innerHTML = '<div class="empty-state">' + (emptyMsg || 'No issues found') + '</div>';
                return;
            }
            issues.forEach(i => { i.impactWeight = computeImpactWeight(i, source); });
            issues.sort((a, b) => b.impactWeight - a.impactWeight);
            issueStore[listId] = { issues: issues, source: source || 'Issue', clusteredBy: groupKey };

            // Group by key
            const groups = {};
            issues.forEach((issue, idx) => {
                const key = issue[groupKey] || 'other';
                if (!groups[key]) groups[key] = [];
                groups[key].push({ issue, idx });
            });

            // Sort groups by total weight
            const sortedGroups = Object.entries(groups).sort((a, b) => {
                const wa = a[1].reduce((s, i) => s + i.issue.impactWeight, 0);
                const wb = b[1].reduce((s, i) => s + i.issue.impactWeight, 0);
                return wb - wa;
            });

            let html = '';
            const CLUSTER_SHOW = 6;
            sortedGroups.forEach(([key, items]) => {
                const label = causeLabelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                const cid = listId + '_' + key.replace(/[^a-zA-Z0-9_-]/g, '_');
                html += '<div class="cluster-header" onclick="document.getElementById(\'' + cid + '\').classList.toggle(\'collapsed\')">' +
                    '<span>' + esc(label) + '</span><span class="cluster-count">' + items.length + '</span></div>';
                html += '<div class="cluster-body" id="' + cid + '">';
                items.slice(0, CLUSTER_SHOW).forEach(({ issue, idx }) => {
                    html += renderIssueRow(issue, idx, listId);
                });
                if (items.length > CLUSTER_SHOW) {
                    const overId = cid + '_overflow';
                    html += '<div id="' + overId + '" style="display:none">';
                    items.slice(CLUSTER_SHOW).forEach(({ issue, idx }) => {
                        html += renderIssueRow(issue, idx, listId);
                    });
                    html += '</div>';
                    html += '<button class="show-more-btn" id="' + overId + '_toggle" onclick="toggleShowAll(\'' + cid + '\')">' +
                        'Show all ' + items.length + ' in group &#9662;</button>';
                }
                html += '</div>';
            });
            el.innerHTML = html;
            if (!el.innerHTML.trim()) el.innerHTML = '<div class="empty-state">' + (emptyMsg || 'No issues found') + '</div>';
        }

        function toggleShowAll(id) {
            const overflow = document.getElementById(id + '_overflow');
            if (!overflow) return;
            const hidden = overflow.style.display === 'none';
            overflow.style.display = hidden ? '' : 'none';
            const btn = overflow.nextElementSibling;
            if (btn && btn.classList.contains('show-more-btn')) {
                if (hidden) {
                    if (!btn.dataset.orig) btn.dataset.orig = btn.innerHTML;
                    btn.innerHTML = 'Show fewer &#9652;';
                } else {
                    btn.innerHTML = btn.dataset.orig || 'Show all &#9662;';
                }
            }
        }

        function esc(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // --- Issue Detail Panel ---

        let currentDetailListId = null, currentDetailIdx = null;

        function openIssueDetail(listId, idx) {
            const store = issueStore[listId];
            if (!store || !store.issues[idx]) return;
            currentDetailListId = listId; currentDetailIdx = idx;
            const issue = store.issues[idx];
            const source = store.source;

            document.getElementById('detail-overlay').classList.add('open');
            document.getElementById('detail-panel').classList.add('open');
            document.getElementById('detail-source').textContent = source;
            document.body.style.overflow = 'hidden';

            const content = document.getElementById('detail-content');
            content.innerHTML = buildDetailHTML(issue, source);
        }

        function closeIssueDetail() {
            document.getElementById('detail-overlay').classList.remove('open');
            document.getElementById('detail-panel').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Close on Escape key
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeIssueDetail(); });

        function buildDetailHTML(issue, source) {
            const sev = issue.severity || 'info';
            const sevLabel = { critical: 'Critical', warning: 'Warning', info: 'Info' }[sev] || sev;
            const tracked = issueTracker.getStatus(source, issue);
            const curStatus = tracked ? tracked.status : '';
            const curOwner = tracked ? tracked.owner : '';
            let html = '';

            // Status controls with SLA date picker
            const curDue = tracked ? (tracked.dueDate || '') : '';
            html += '<div class="status-controls">' +
                '<select onchange="updateIssueStatus(this.value)">' +
                    '<option value=""' + (!curStatus ? ' selected' : '') + '>Open</option>' +
                    '<option value="acknowledged"' + (curStatus === 'acknowledged' ? ' selected' : '') + '>Acknowledged</option>' +
                    '<option value="investigating"' + (curStatus === 'investigating' ? ' selected' : '') + '>Investigating</option>' +
                    '<option value="resolved"' + (curStatus === 'resolved' ? ' selected' : '') + '>Resolved</option>' +
                    '<option value="false_positive"' + (curStatus === 'false_positive' ? ' selected' : '') + '>False Positive</option>' +
                '</select>' +
                '<input type="text" placeholder="Owner" value="' + esc(curOwner) + '" onchange="updateIssueOwner(this.value)" style="flex:1">' +
                '<input type="date" value="' + esc(curDue) + '" onchange="updateIssueDueDate(this.value)" title="Due date (SLA)" style="width:140px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);font-size:13px;background:var(--pearl);color:var(--ink)">' +
            '</div>';

            // Verify fix area for resolved issues (all sources)
            if (curStatus === 'resolved') {
                const verif = issueTracker.getVerification(source, issue);
                if (verif) {
                    const vColor = verif.verifiedResult === 'passed' ? 'green' : 'amber';
                    html += '<div id="verify-fix-area" style="padding:4px 0 8px"><div style="padding:8px 12px;background:var(--' + vColor + '-bg);color:var(--' + vColor + ');border-radius:10px;font-size:13px;font-weight:500">' +
                        (verif.verifiedResult === 'passed' ? '&#10003; Verified ' : '&#10060; Not verified ') + new Date(verif.verifiedAt).toLocaleDateString() +
                        (verif.verifiedDetails ? '  ' + esc(verif.verifiedDetails) : '') + '</div></div>';
                } else {
                    let vLabel = 'Verify Fix';
                    if (source === 'Redirects & 404s') vLabel = 'Verify Fix' + (issue.title && issue.title.startsWith('404:') ? ' for ' + issue.title.replace('404: ', '') : '');
                    else if (source === 'Site Performance') vLabel = 'Check CWV Improvement';
                    else if (source === 'Data Quality') vLabel = 'Check Data Freshness';
                    html += '<div id="verify-fix-area" style="padding:4px 0 8px">' +
                        '<button class="action-btn primary" onclick="verifyFix(\'' + esc(source) + '\', issueStore[\'' + esc(currentDetailListId) + '\'].issues[' + currentDetailIdx + '], this)" style="width:100%">' + esc(vLabel) + '</button></div>';
                }
            }

            // Severity badge + title
            html += '<div><span class="detail-sev-badge ' + sev + '">' +
                '<span class="detail-sev-dot ' + sev + '"></span>' + sevLabel +
                '</span></div>';
            html += '<div class="detail-title">' + esc(issue.title || issue.check_name || 'Issue') + '</div>';

            // Revenue impact bar
            if (issue.revenue_impact) {
                html += '<div class="detail-impact-bar">~$' + Math.round(issue.revenue_impact).toLocaleString() + '/mo estimated revenue at risk</div>';
            }

            // Meta grid
            html += '<div class="detail-meta-grid">';
            html += '<div class="detail-meta-item"><div class="detail-meta-label">Source</div><div class="detail-meta-value">' + esc(source) + '</div></div>';
            html += '<div class="detail-meta-item"><div class="detail-meta-label">Severity</div><div class="detail-meta-value">' + esc(sevLabel) + '</div></div>';
            if (issue.category) html += '<div class="detail-meta-item"><div class="detail-meta-label">Category</div><div class="detail-meta-value">' + esc(issue.category) + '</div></div>';
            if (issue.file_path) html += '<div class="detail-meta-item"><div class="detail-meta-label">Location</div><div class="detail-meta-value" style="font-family:monospace;font-size:12px">' + esc(issue.file_path) + (issue.line_number ? ':' + issue.line_number : '') + '</div></div>';
            if (issue.confidence_level) html += '<div class="detail-meta-item"><div class="detail-meta-label">Confidence</div><div class="detail-meta-value">' + esc(issue.confidence_level) + '</div></div>';
            if (issue.sample_size !== undefined) html += '<div class="detail-meta-item"><div class="detail-meta-label">Sample Size</div><div class="detail-meta-value">' + issue.sample_size + ' events</div></div>';
            if (issue.impactWeight) html += '<div class="detail-meta-item"><div class="detail-meta-label">Impact Score</div><div class="detail-meta-value">' + issue.impactWeight + '/100</div></div>';
            if (issue.dollarImpact > 0) html += '<div class="detail-meta-item"><div class="detail-meta-label">Est. Monthly Impact</div><div class="detail-meta-value" style="color:var(--red)">$' + issue.dollarImpact.toLocaleString() + '</div></div>';
            if (issue.confidenceLabel) html += '<div class="detail-meta-item"><div class="detail-meta-label">Confidence</div><div class="detail-meta-value">' + issue.confidenceLabel.charAt(0).toUpperCase() + issue.confidenceLabel.slice(1) + ' (' + issue.confidenceScore + '%)</div></div>';
            html += '</div>';

            // Timeline section
            const timeline = issueTracker.getTimeline(source, issue);
            if (timeline && timeline.firstSeenAt) {
                const firstDate = new Date(timeline.firstSeenAt).toLocaleDateString();
                const lastDate = new Date(timeline.lastSeenAt).toLocaleDateString();
                const daysSince = Math.floor((Date.now() - new Date(timeline.firstSeenAt).getTime()) / 86400000);
                let ageLabel = '';
                if (daysSince === 0) ageLabel = '<span style="color:var(--cass-gold);font-weight:500">New today</span>';
                else if (daysSince <= 2) ageLabel = '<span style="color:var(--cass-gold);font-weight:500">New (' + daysSince + 'd)</span>';
                else if (daysSince > 14) ageLabel = '<span style="color:var(--red);font-weight:500">Persistent (' + daysSince + 'd)</span>';
                else ageLabel = '<span style="color:var(--slate)">Recurring (' + daysSince + 'd)</span>';
                html += '<div class="detail-section"><div class="detail-section-header">Timeline</div><div class="detail-section-body">' +
                    '<div class="detail-meta-grid">' +
                    '<div class="detail-meta-item"><div class="detail-meta-label">First Seen</div><div class="detail-meta-value">' + firstDate + '</div></div>' +
                    '<div class="detail-meta-item"><div class="detail-meta-label">Last Seen</div><div class="detail-meta-value">' + lastDate + '</div></div>' +
                    '<div class="detail-meta-item"><div class="detail-meta-label">Times Seen</div><div class="detail-meta-value">' + (timeline.seenCount || 1) + '</div></div>' +
                    '<div class="detail-meta-item"><div class="detail-meta-label">Age</div><div class="detail-meta-value">' + ageLabel + '</div></div>' +
                    '</div></div></div>';

                // Frequency trend sparkline
                if (timeline.seenCountHistory && timeline.seenCountHistory.length >= 2) {
                    const hist = timeline.seenCountHistory;
                    const maxC = Math.max(...hist.map(h => h.count));
                    const bars = hist.map(h => {
                        const ht = Math.max(4, Math.round((h.count / maxC) * 24));
                        return '<div style="width:8px;height:' + ht + 'px;background:var(--cass-gold);border-radius:2px" title="' + h.date + ': ' + h.count + '"></div>';
                    }).join('');
                    html += '<div class="detail-section"><div class="detail-section-header">Frequency Trend</div><div class="detail-section-body">' +
                        '<div style="display:flex;align-items:flex-end;gap:2px;height:28px">' + bars + '</div>' +
                        '<div style="font-size:11px;color:var(--slate);margin-top:4px">Daily detection frequency (last ' + hist.length + ' days)</div></div></div>';
                }
            }

            // Blast radius
            let blastHtml = '';
            if (source === 'Redirects & 404s' && issue.traffic_hits) {
                blastHtml += '<div class="detail-meta-item"><div class="detail-meta-label">Monthly Hits</div><div class="detail-meta-value">' + issue.traffic_hits.toLocaleString() + '</div></div>';
                if (issue.referrers && issue.referrers.external_links_count) blastHtml += '<div class="detail-meta-item"><div class="detail-meta-label">External Links</div><div class="detail-meta-value">' + issue.referrers.external_links_count + '</div></div>';
            }
            if (source === 'Site Performance' && issue.sample_size) {
                blastHtml += '<div class="detail-meta-item"><div class="detail-meta-label">Events Sampled</div><div class="detail-meta-value">' + issue.sample_size.toLocaleString() + '</div></div>';
            }
            if (blastHtml) {
                html += '<div class="detail-section"><div class="detail-section-header">Blast Radius</div><div class="detail-section-body"><div class="detail-meta-grid">' + blastHtml + '</div></div></div>';
            }

            // Evidence section
            const evidence = buildEvidence(issue, source);
            if (evidence) {
                html += '<div class="detail-section"><div class="detail-section-header">Evidence</div><div class="detail-section-body">' + evidence + '</div></div>';
            }

            // Root cause
            html += '<div class="detail-section"><div class="detail-section-header">Root Cause</div><div class="detail-section-body">' + buildRootCause(issue, source) + '</div></div>';

            // Fix steps
            html += '<div class="detail-section"><div class="detail-section-header">Recommended Fix</div><div class="detail-section-body">' + buildFixSteps(issue, source) + '</div></div>';

            // Evidence links
            const eLinks = buildEvidenceLinks(issue, source);
            if (eLinks.length > 0) {
                html += '<div class="detail-section"><div class="detail-section-header">Evidence &amp; Links</div><div class="detail-section-body"><div class="evidence-links">';
                eLinks.forEach(l => { html += '<a class="evidence-link" href="' + esc(l.url) + '" target="_blank">' + esc(l.label) + ' &rarr;</a>'; });
                html += '</div></div></div>';
            }

            // Related issues cross-reference
            const currentPath = extractNormalizedPath(issue);
            if (currentPath && relatedIssuesMap[currentPath]) {
                const related = relatedIssuesMap[currentPath].filter(r => !(r.listId === currentDetailListId && r.idx === currentDetailIdx));
                if (related.length > 0) {
                    html += '<div class="detail-section"><div class="detail-section-header">Related Issues (' + related.length + ')</div><div class="detail-section-body">';
                    related.forEach(r => {
                        const sevDot = r.severity === 'critical' ? 'var(--red)' : r.severity === 'warning' ? 'var(--cass-gold)' : 'var(--cass-teal)';
                        html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--line);cursor:pointer" ' +
                            'onclick="openIssueDetail(\'' + r.listId + '\',' + r.idx + ')">' +
                            '<span style="width:8px;height:8px;border-radius:50%;background:' + sevDot + ';flex-shrink:0"></span>' +
                            '<span style="font-size:13px;flex:1">' + esc(r.title) + '</span>' +
                            '<span style="font-size:11px;color:var(--slate)">' + esc(r.source) + '</span></div>';
                    });
                    html += '</div></div>';
                }
            }

            // Template cluster context
            if (issue.file_path) {
                const tplMatch = issue.file_path.match(/(?:sections|snippets|templates|layout)\/([^/.]+)/);
                if (tplMatch && templateClusterMap[tplMatch[1]] && templateClusterMap[tplMatch[1]].length > 1) {
                    const cluster = templateClusterMap[tplMatch[1]].filter(c => !(c.listId === currentDetailListId && c.idx === currentDetailIdx));
                    if (cluster.length > 0) {
                        html += '<div class="detail-section"><div class="detail-section-header">Template: ' + esc(tplMatch[1]) + ' (' + (cluster.length + 1) + ' issues)</div><div class="detail-section-body">';
                        cluster.slice(0, 5).forEach(c => {
                            const dot = c.severity === 'critical' ? 'var(--red)' : c.severity === 'warning' ? 'var(--cass-gold)' : 'var(--cass-teal)';
                            html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--line);cursor:pointer" onclick="openIssueDetail(\'' + c.listId + '\',' + c.idx + ')">' +
                                '<span style="width:8px;height:8px;border-radius:50%;background:' + dot + ';flex-shrink:0"></span>' +
                                '<span style="font-size:13px;flex:1">' + esc(c.title) + '</span></div>';
                        });
                        html += '</div></div>';
                    }
                }
            }

            // Deploy-window cluster (3 issues on same day = likely same deploy)
            const issueTl = issueTracker.getTimeline(source, issue);
            if (issueTl && issueTl.firstSeenAt) {
                const dKey = issueTl.firstSeenAt.slice(0, 10);
                const deployCluster = (deployClusterMap[dKey] || []).filter(c => !(c.listId === currentDetailListId && c.idx === currentDetailIdx));
                if (deployCluster.length >= 2) {
                    html += '<div class="detail-section"><div class="detail-section-header">Deploy Window: ' + dKey + ' (' + (deployCluster.length + 1) + ' issues)</div><div class="detail-section-body">' +
                        '<p style="font-size:12px;color:var(--slate);margin-bottom:6px">These issues were first detected on the same day.</p>';
                    deployCluster.slice(0, 5).forEach(c => {
                        const dot = c.severity === 'critical' ? 'var(--red)' : c.severity === 'warning' ? 'var(--cass-gold)' : 'var(--cass-teal)';
                        html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--line);cursor:pointer" onclick="openIssueDetail(\'' + c.listId + '\',' + c.idx + ')">' +
                            '<span style="width:8px;height:8px;border-radius:50%;background:' + dot + ';flex-shrink:0"></span>' +
                            '<span style="font-size:13px;flex:1">' + esc(c.title) + '</span>' +
                            '<span style="font-size:11px;color:var(--slate)">' + esc(c.source) + '</span></div>';
                    });
                    html += '</div></div>';
                }
            }

            // Root cause cluster (redirect issues with same likely_cause)
            if (issue.likely_cause && issue.likely_cause !== 'unknown' && causeClusterMap[issue.likely_cause] && causeClusterMap[issue.likely_cause].length > 1) {
                const causeCluster = causeClusterMap[issue.likely_cause].filter(c => !(c.listId === currentDetailListId && c.idx === currentDetailIdx));
                if (causeCluster.length > 0) {
                    const causeLabel = (typeof causeLabelMap !== 'undefined' && causeLabelMap[issue.likely_cause]) || issue.likely_cause.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    html += '<div class="detail-section"><div class="detail-section-header">Root Cause: ' + esc(causeLabel) + ' (' + (causeCluster.length + 1) + ' issues)</div><div class="detail-section-body">';
                    causeCluster.slice(0, 5).forEach(c => {
                        const dot = c.severity === 'critical' ? 'var(--red)' : c.severity === 'warning' ? 'var(--cass-gold)' : 'var(--cass-teal)';
                        html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--line);cursor:pointer" onclick="openIssueDetail(\'' + c.listId + '\',' + c.idx + ')">' +
                            '<span style="width:8px;height:8px;border-radius:50%;background:' + dot + ';flex-shrink:0"></span>' +
                            '<span style="font-size:13px;flex:1">' + esc(c.title) + '</span></div>';
                    });
                    html += '</div></div>';
                }
            }

            // Action buttons
            const actions = getActions(issue, source);
            if (actions.length > 0) {
                html += '<div class="action-buttons">';
                actions.forEach(a => {
                    if (a.type === 'link') {
                        html += '<a class="action-btn' + (a.primary ? ' primary' : '') + '" href="' + esc(a.url) + '" target="_blank">' + esc(a.label) + '</a>';
                    } else if (a.type === 'redirect_create') {
                        html += '<div style="display:flex;gap:8px;align-items:center;width:100%">' +
                            '<input type="text" id="redirect-target" placeholder="Target path e.g. /collections/all" style="flex:1;padding:8px 12px;border-radius:10px;border:1px solid var(--line);font-size:13px">' +
                            '<button class="action-btn primary" onclick="createRedirect(\'' + esc(a.urlPath) + '\',document.getElementById(\'redirect-target\').value,this)">' + esc(a.label) + '</button></div>';
                    } else if (a.type === 'github_issue') {
                        html += '<button class="action-btn' + (a.primary ? ' primary' : '') + '" onclick="createGitHubIssue(this)">' + esc(a.label) + '</button>';
                    } else {
                        html += '<button class="action-btn' + (a.primary ? ' primary' : '') + '" onclick="executeAction(\'' + esc(a.endpoint) + '\',\'' + esc(a.label) + '\',this)">' + esc(a.label) + '</button>';
                    }
                });
                html += '</div>';
            }

            return html;
        }

        function updateIssueStatus(status) {
            if (!currentDetailListId || currentDetailIdx === null) return;
            const store = issueStore[currentDetailListId];
            if (!store) return;
            const issue = store.issues[currentDetailIdx];
            const tracked = issueTracker.getStatus(store.source, issue);
            issueTracker.setStatus(store.source, issue, status, tracked ? tracked.owner : '');
            // Capture baseline snapshot when marking as resolved
            if (status === 'resolved') captureResolveSnapshot(store.source, issue);
            rerenderList(currentDetailListId);
            document.getElementById('detail-content').innerHTML = buildDetailHTML(issue, store.source);
        }

        async function captureResolveSnapshot(source, issue) {
            if (source === 'Site Performance') {
                try {
                    const res = await fetch('/site-health/summary?hours=168');
                    const data = await res.json();
                    const cwv = (data.data || data).core_web_vitals || {};
                    issueTracker.setResolveSnapshot(source, issue, {
                        type: 'cwv', LCP: cwv.LCP ? cwv.LCP.p75 : null, CLS: cwv.CLS ? cwv.CLS.p75 : null, INP: cwv.INP ? cwv.INP.p75 : null, capturedAt: new Date().toISOString()
                    });
                } catch (e) { /* silent */ }
            } else if (source === 'Data Quality') {
                try {
                    const res = await fetch('/data-quality/dashboard');
                    const data = await res.json();
                    const freshness = (data.data || data).freshness || {};
                    issueTracker.setResolveSnapshot(source, issue, {
                        type: 'freshness', sources: freshness.sources || {}, capturedAt: new Date().toISOString()
                    });
                } catch (e) { /* silent */ }
            }
        }

        function updateIssueOwner(owner) {
            if (!currentDetailListId || currentDetailIdx === null) return;
            const store = issueStore[currentDetailListId];
            if (!store) return;
            const issue = store.issues[currentDetailIdx];
            const tracked = issueTracker.getStatus(store.source, issue);
            issueTracker.setStatus(store.source, issue, tracked ? tracked.status : 'acknowledged', owner);
            rerenderList(currentDetailListId);
        }

        function updateIssueDueDate(dueDate) {
            if (!currentDetailListId || currentDetailIdx === null) return;
            const store = issueStore[currentDetailListId];
            if (!store) return;
            const issue = store.issues[currentDetailIdx];
            const tracked = issueTracker.getStatus(store.source, issue);
            issueTracker.setStatus(store.source, issue, tracked ? tracked.status : '', tracked ? tracked.owner : '', dueDate || null);
            rerenderList(currentDetailListId);
        }

        async function verifyFix(source, issue, btn) {
            if (source === 'Redirects & 404s' && issue.title && issue.title.startsWith('404:')) {
                return verifyFix404(issue.title.replace('404: ', ''), btn);
            } else if (source === 'Site Performance') {
                return verifyCWVFix(source, issue, btn);
            } else if (source === 'Data Quality') {
                return verifyDataQualityFix(source, issue, btn);
            }
            btn.textContent = 'No verifier for this source';
        }

        async function verifyFix404(urlPath, btn) {
            btn.disabled = true;
            btn.textContent = 'Checking URL...';
            const store = issueStore[currentDetailListId];
            try {
                const res = await fetch('/redirects/verify-url?url=' + encodeURIComponent(urlPath));
                const data = await res.json();
                const area = document.getElementById('verify-fix-area');
                const passed = data.is_healthy;
                if (store) issueTracker.setVerification(store.source, store.issues[currentDetailIdx], { passed, details: 'Status ' + data.final_status_code + (data.chain_length > 1 ? ' via ' + data.chain_length + ' redirects' : '') });
                if (passed) {
                    area.innerHTML = '<div style="padding:8px 12px;background:var(--green-bg);color:var(--green);border-radius:10px;font-size:13px;font-weight:500">' +
                        '&#10003; Verified ' + new Date().toLocaleDateString() + '  returns ' + data.final_status_code + (data.chain_length > 1 ? ' (via ' + data.chain_length + ' redirects)' : '') + '</div>';
                } else {
                    area.innerHTML = '<div style="padding:8px 12px;background:var(--red-bg);color:var(--red);border-radius:10px;font-size:13px;font-weight:500">' +
                        '&#10007; Still broken  returns ' + (data.final_status_code || 'error') +
                        '</div><button class="action-btn" onclick="revertToOpen()" style="margin-top:6px;width:100%">Revert to Open</button>';
                }
                if (store) rerenderList(currentDetailListId);
            } catch (e) { btn.textContent = 'Error  try again'; btn.disabled = false; }
        }

        async function verifyCWVFix(source, issue, btn) {
            btn.disabled = true; btn.textContent = 'Checking CWV...';
            const store = issueStore[currentDetailListId];
            const snapshot = store ? issueTracker.getResolveSnapshot(store.source, issue) : null;
            if (!snapshot || snapshot.type !== 'cwv') { btn.textContent = 'No baseline snapshot  resolve again to capture'; btn.disabled = false; return; }
            try {
                const res = await fetch('/site-health/summary?hours=168');
                const data = await res.json();
                const cwv = (data.data || data).core_web_vitals || {};
                let improved = false, details = '';
                ['LCP', 'CLS', 'INP'].forEach(m => {
                    if (snapshot[m] !== null && snapshot[m] !== undefined && cwv[m]) {
                        const before = snapshot[m], after = cwv[m].p75;
                        if (after < before) { improved = true; details += m + ': ' + Math.round(before) + ' -> ' + Math.round(after) + ' (improved). '; }
                        else details += m + ': ' + Math.round(before) + ' -> ' + Math.round(after) + '. ';
                    }
                });
                if (store) issueTracker.setVerification(store.source, issue, { passed: improved, details });
                const area = document.getElementById('verify-fix-area');
                const color = improved ? 'green' : 'amber';
                area.innerHTML = '<div style="padding:8px 12px;background:var(--' + color + '-bg);color:var(--' + color + ');border-radius:10px;font-size:13px;font-weight:500">' +
                    (improved ? '&#10003; Verified ' : '&#10060; Not yet improved ') + new Date().toLocaleDateString() + '  ' + esc(details) + '</div>';
                if (store) rerenderList(currentDetailListId);
            } catch (e) { btn.textContent = 'Error'; btn.disabled = false; }
        }

        async function verifyDataQualityFix(source, issue, btn) {
            btn.disabled = true; btn.textContent = 'Checking freshness...';
            const store = issueStore[currentDetailListId];
            try {
                const res = await fetch('/data-quality/dashboard');
                const data = await res.json();
                const d = data.data || data;
                const freshness = d.freshness || {};
                const sources = freshness.sources || {};
                let sourceKey = null;
                Object.keys(sources).forEach(k => { if ((issue.title || '').toLowerCase().includes(k.replace(/_/g, ' '))) sourceKey = k; });
                const src = sourceKey ? sources[sourceKey] : null;
                const isFresh = src && !src.stale && !src.is_stale;
                if (store) issueTracker.setVerification(store.source, issue, { passed: isFresh, details: sourceKey ? (isFresh ? sourceKey + ' is now fresh' : sourceKey + ' still stale (' + (src.lag_hours || '?') + 'h)') : 'Source not identified' });
                const area = document.getElementById('verify-fix-area');
                const color = isFresh ? 'green' : 'red';
                area.innerHTML = '<div style="padding:8px 12px;background:var(--' + color + '-bg);color:var(--' + color + ');border-radius:10px;font-size:13px;font-weight:500">' +
                    (isFresh ? '&#10003; Verified ' + new Date().toLocaleDateString() + '  data is now fresh' : '&#10007; Still stale  source not refreshed') + '</div>';
                if (store) rerenderList(currentDetailListId);
            } catch (e) { btn.textContent = 'Error'; btn.disabled = false; }
        }

        function revertToOpen() {
            if (!currentDetailListId || currentDetailIdx === null) return;
            const store = issueStore[currentDetailListId];
            if (!store) return;
            const issue = store.issues[currentDetailIdx];
            issueTracker.setStatus(store.source, issue, '', '');
            rerenderList(currentDetailListId);
            document.getElementById('detail-content').innerHTML = buildDetailHTML(issue, store.source);
        }

        // Re-render a single issue list from its issueStore (preserves sort/cluster)
        function rerenderList(listId) {
            const store = issueStore[listId];
            if (!store) return;
            if (store.clusteredBy) {
                renderClusteredIssues(listId, store.issues, '', store.source, store.clusteredBy);
            } else {
                renderIssues(listId, store.issues, '', store.source);
            }
        }

        function toggleShowResolved(checked) {
            showResolved = checked;
            // Re-render all lists
            Object.keys(issueStore).forEach(listId => rerenderList(listId));
        }

        function buildEvidenceLinks(issue, source) {
            const links = [];
            if (source === 'Redirects & 404s') {
                links.push({ label: 'Shopify URL Redirects', url: 'https://admin.shopify.com/store/cass-brothers/settings/redirects' });
                if (issue.title && issue.title.startsWith('404:')) {
                    const path = issue.title.replace('404: ', '');
                    links.push({ label: 'View 404 page', url: 'https://cassbrothers.com.au' + path });
                }
            }
            if (source === 'Code Health' && issue.github_url) {
                links.push({ label: 'View in GitHub', url: issue.github_url });
            }
            if (source === 'Site Performance' && issue.file_path) {
                links.push({ label: 'PageSpeed Insights', url: 'https://pagespeed.web.dev/analysis?url=https://cassbrothers.com.au' + issue.file_path });
            }
            if (source === 'Data Quality') {
                links.push({ label: 'Freshness Report', url: '/data-quality/freshness' });
            }
            return links;
        }

        function getActions(issue, source) {
            const actions = [];
            if (source === 'Redirects & 404s' && issue.title && issue.title.startsWith('404:')) {
                const urlPath = issue.title.replace('404: ', '');
                actions.push({ label: 'Create 301 Redirect', type: 'redirect_create', urlPath: urlPath, primary: true });
                actions.push({ label: 'View in Shopify Admin', type: 'link', url: 'https://admin.shopify.com/store/cass-brothers/settings/redirects' });
            }
            if (source === 'Code Health') {
                actions.push({ label: 'Create GitHub Issue', type: 'github_issue', primary: true });
                if (issue.github_url) actions.push({ label: 'Open in GitHub', type: 'link', url: issue.github_url });
            }
            if (source === 'Data Quality' && issue.title && issue.title.includes('stale')) {
                const syncSrc = detectSyncSource(issue.title);
                actions.push({ label: 'Run Sync Now', type: 'api', endpoint: '/sync/' + syncSrc, primary: true });
            }
            if (source === 'Site Performance' && issue.file_path) {
                actions.push({ label: 'PageSpeed Insights', type: 'link', url: 'https://pagespeed.web.dev/analysis?url=https://cassbrothers.com.au' + issue.file_path });
            }
            return actions;
        }

        function detectSyncSource(title) {
            const t = title.toLowerCase();
            if (t.includes('shopify')) return 'shopify';
            if (t.includes('ga4') || t.includes('analytics') || t.includes('traffic')) return 'ga4';
            if (t.includes('search_console') || t.includes('gsc')) return 'search-console';
            if (t.includes('google_ads') || t.includes('ads_campaign')) return 'google-ads';
            if (t.includes('merchant')) return 'merchant-center';
            return 'all';
        }

        async function executeAction(endpoint, label, btn) {
            if (!confirm('Run "' + label + '" now?')) return;
            btn.disabled = true; btn.textContent = 'Running...';
            try {
                const res = await fetch(endpoint, { method: 'POST' });
                if (res.ok) {
                    btn.textContent = 'Done!'; btn.style.background = 'var(--green)'; btn.style.color = '#fff';
                    setTimeout(() => loadAll(), 3000);
                } else { btn.textContent = 'Failed'; btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
            } catch (e) { btn.textContent = 'Error'; btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
        }

        async function createRedirect(fromPath, toPath, btn) {
            if (!toPath || !toPath.startsWith('/')) { alert('Enter a valid target path starting with /'); return; }
            if (!confirm('Create redirect: ' + fromPath + ' -> ' + toPath + '?')) return;
            btn.disabled = true; btn.textContent = 'Creating...';
            try {
                const res = await fetch('/redirects/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from_path: fromPath, to_path: toPath }) });
                const data = await res.json();
                if (data.success) {
                    btn.textContent = 'Created!'; btn.style.background = 'var(--green)'; btn.style.color = '#fff';
                    const store = issueStore[currentDetailListId];
                    if (store) {
                        const key = issueTracker.getKey(store.source, store.issues[currentDetailIdx]);
                        if (issueTracker.data[key]) { issueTracker.data[key].actionExecutedAt = new Date().toISOString(); issueTracker.data[key].actionType = 'redirect_created'; issueTracker.saveAll(); }
                    }
                } else { btn.textContent = 'Failed: ' + (data.detail || 'error'); btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
            } catch (e) { btn.textContent = 'Error'; btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
        }

        async function createGitHubIssue(btn) {
            const store = issueStore[currentDetailListId];
            if (!store || currentDetailIdx === null) return;
            const issue = store.issues[currentDetailIdx];
            const title = '[Site Intelligence] ' + (issue.title || issue.check_name || 'Code issue');
            const body = '## Auto-detected by Site Intelligence\n\n**Severity:** ' + (issue.severity || 'info') + '\n**Category:** ' + (issue.category || 'unknown') + '\n**File:** `' + (issue.file_path || 'N/A') + (issue.line_number ? ':' + issue.line_number : '') + '`\n\n### Description\n' + (issue.description || 'No description') + '\n\n### Recommendation\n' + (issue.recommendation || 'Review and fix') + '\n\n_Created from Site Intelligence dashboard._';
            if (!confirm('Create GitHub issue: "' + title + '"?')) return;
            btn.disabled = true; btn.textContent = 'Creating...';
            try {
                const res = await fetch('/code/github-issue', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, body, labels: ['site-intelligence', issue.category || 'code-health'] }) });
                const data = await res.json();
                if (data.success) {
                    btn.textContent = 'Created #' + data.issue.number; btn.style.background = 'var(--green)'; btn.style.color = '#fff';
                    btn.onclick = () => window.open(data.issue.url, '_blank');
                    const key = issueTracker.getKey(store.source, issue);
                    if (issueTracker.data[key]) { issueTracker.data[key].actionExecutedAt = new Date().toISOString(); issueTracker.data[key].actionType = 'github_issue_created'; issueTracker.data[key].githubIssueUrl = data.issue.url; issueTracker.saveAll(); }
                } else { btn.textContent = 'Failed'; btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
            } catch (e) { btn.textContent = 'Error'; btn.style.background = 'var(--red)'; btn.style.color = '#fff'; }
        }

        function buildEvidence(issue, source) {
            const parts = [];
            if (issue.description) parts.push('<p>' + esc(issue.description) + '</p>');

            // Source-specific evidence
            if (source === 'Redirects & 404s') {
                if (issue.title && issue.title.startsWith('404:')) {
                    parts.push('<p>This URL is being requested by users or bots but returns a 404 error. Each hit represents a lost visitor and potential lost revenue.</p>');
                }
                if (issue.revenue_impact) {
                    parts.push('<p>Based on average conversion rate and order value, this 404 pattern costs approximately <strong>$' + Math.round(issue.revenue_impact) + '/month</strong> in lost sales.</p>');
                }
            } else if (source === 'Code Health') {
                if (issue.category === 'liquid') {
                    parts.push('<p>Found in Shopify Liquid template. This affects how the storefront renders for customers.</p>');
                } else if (issue.category === 'javascript') {
                    parts.push('<p>Found in JavaScript bundle. This can affect page interactivity and performance.</p>');
                } else if (issue.category === 'security') {
                    parts.push('<p>Security issues can expose the store to XSS attacks or data leaks.</p>');
                }
                if (issue.line_number) {
                    parts.push('<p>Issue detected at <strong>line ' + issue.line_number + '</strong> in the file.</p>');
                }
            } else if (source === 'Site Performance') {
                if (issue.title && issue.title.includes('LCP')) {
                    parts.push('<p>LCP (Largest Contentful Paint) measures when the main content is visible. Google uses this as a Core Web Vital ranking factor.</p>');
                } else if (issue.title && issue.title.includes('CLS')) {
                    parts.push('<p>CLS (Cumulative Layout Shift) measures visual stability. High CLS causes elements to jump around during loading, frustrating users.</p>');
                } else if (issue.title && issue.title.includes('INP')) {
                    parts.push('<p>INP (Interaction to Next Paint) measures responsiveness. Slow INP means clicks/taps feel laggy to users.</p>');
                }
            } else if (source === 'Data Quality') {
                if (issue.title && issue.title.includes('stale')) {
                    parts.push('<p>Stale data means decisions are being made on outdated information. This can lead to missed opportunities or incorrect analysis.</p>');
                }
            }

            return parts.length > 0 ? parts.join('') : '<p>This issue was detected during the latest automated scan.</p>';
        }

        function buildRootCause(issue, source) {
            // Generate contextual root cause based on issue type
            if (source === 'Redirects & 404s') {
                if (issue.title && issue.title.startsWith('404:')) {
                    return '<p>A page that was previously accessible is now returning a 404. This is commonly caused by:</p>' +
                        '<ul style="margin:8px 0 0 18px"><li>Product or collection deleted from Shopify</li>' +
                        '<li>URL handle changed without a redirect</li>' +
                        '<li>Incoming links from external sites pointing to an old URL</li>' +
                        '<li>Sitemap still listing removed pages</li></ul>';
                }
                if (issue.title && issue.title.includes('redirect chain')) {
                    return '<p>Redirect chains occur when one redirect points to another redirect, creating a multi-hop path. This slows page loads and wastes search engine crawl budget.</p>';
                }
                if (issue.title && issue.title.includes('broken redirect')) {
                    return '<p>A redirect rule exists but its destination page no longer exists, creating a redirect that leads to a 404. This is worse than a simple 404 because it gives a false promise of resolution.</p>';
                }
                return '<p>Redirect and 404 issues typically arise from URL changes, deleted content, or misconfigured routing rules.</p>';
            }
            if (source === 'Code Health') {
                if (issue.title && issue.title.includes('include')) {
                    return '<p>The <code>{% include %}</code> tag is deprecated in Shopify themes. It shares the parent scope and is slower than <code>{% render %}</code> which creates an isolated scope and enables better caching.</p>';
                }
                if (issue.title && issue.title.includes('console.log')) {
                    return '<p>Debug logging statements left in production code. While not harmful, they clutter the browser console and may expose internal logic to users.</p>';
                }
                if (issue.title && issue.title.includes('alt text') || (issue.title && issue.title.includes('accessibility'))) {
                    return '<p>Images without alt text are inaccessible to screen readers and miss SEO opportunities. Search engines use alt text to understand image content.</p>';
                }
                if (issue.category === 'security') {
                    return '<p>Security vulnerabilities in theme code can allow attackers to inject malicious scripts (XSS), steal customer data, or manipulate the storefront.</p>';
                }
                return '<p>Code health issues arise from deprecated patterns, missing best practices, or technical debt accumulated over theme development.</p>';
            }
            if (source === 'Site Performance') {
                if (issue.title && issue.title.includes('LCP')) {
                    return '<p>Poor LCP is typically caused by large unoptimized images, slow server response, render-blocking CSS/JS, or client-side rendering of the main content.</p>';
                }
                if (issue.title && issue.title.includes('CLS')) {
                    return '<p>Layout shifts happen when elements load without reserved space - typically images without dimensions, ads/banners injected dynamically, or web fonts causing text reflow.</p>';
                }
                if (issue.title && issue.title.includes('INP')) {
                    return '<p>Slow interactions are caused by heavy JavaScript execution on the main thread, typically from third-party scripts, complex event handlers, or large DOM updates.</p>';
                }
                return '<p>Performance issues can stem from unoptimized assets, excessive scripts, slow server responses, or poor caching configuration.</p>';
            }
            if (source === 'Data Quality') {
                if (issue.title && issue.title.includes('stale')) {
                    return '<p>Data sync has not completed recently. This could be due to expired API credentials, rate limiting, a paused scheduler, or a connectivity issue with the data source.</p>';
                }
                if (issue.title && issue.title.includes('critical')) {
                    return '<p>This data quality check is in a critical state, meaning the data source may be misconfigured, disconnected, or returning errors.</p>';
                }
                return '<p>Data quality issues indicate a gap between expected and actual data freshness or completeness.</p>';
            }
            return '<p>This issue was identified during automated analysis. Review the evidence above for specific context.</p>';
        }

        function buildFixSteps(issue, source) {
            const steps = [];
            const rec = issue.recommendation || issue.fix || '';

            // Source-specific fix steps
            if (source === 'Redirects & 404s' && issue.title && issue.title.startsWith('404:')) {
                const url = issue.title.replace('404: ', '');
                steps.push('Identify what page this URL originally pointed to (product, collection, or blog post)');
                steps.push('In Shopify Admin, go to Online Store &rarr; Navigation &rarr; URL Redirects');
                steps.push('Create a redirect from <code>' + esc(url) + '</code> to the most relevant live page');
                steps.push('If the content is permanently removed, redirect to the parent collection or homepage');
                if (rec) steps.push(esc(rec));
            } else if (source === 'Code Health' && issue.title && issue.title.includes('include')) {
                steps.push('Open the file <code>' + esc(issue.file_path || '') + '</code> in your theme editor');
                steps.push('Replace <code>{% include \'snippet\' %}</code> with <code>{% render \'snippet\' %}</code>');
                steps.push('Pass any needed variables explicitly: <code>{% render \'snippet\', product: product %}</code>');
                steps.push('Test the page to ensure the rendered output is unchanged');
            } else if (source === 'Site Performance' && issue.title && issue.title.includes('LCP')) {
                steps.push('Identify the largest element on the page (usually a hero image or heading)');
                steps.push('Optimize the hero image: convert to WebP, set appropriate dimensions, use srcset');
                steps.push('Add <code>fetchpriority="high"</code> to the LCP image element');
                steps.push('Remove render-blocking scripts and defer non-critical CSS');
            } else if (source === 'Data Quality' && issue.title && issue.title.includes('stale')) {
                steps.push('Check the scheduler is running: visit the monitoring dashboard');
                steps.push('Verify API credentials are still valid for this data source');
                steps.push('Try a manual sync via the API: <code>POST /sync/all</code>');
                steps.push('Check server logs for error messages from the connector');
            } else if (rec) {
                // Fallback: split recommendation into steps if it has multiple sentences
                const sentences = rec.split(/\.\s+/).filter(s => s.trim());
                if (sentences.length > 1) {
                    sentences.forEach(s => steps.push(esc(s.trim().replace(/\.$/, ''))));
                } else {
                    steps.push(esc(rec));
                }
            }

            if (steps.length === 0) {
                steps.push('Review the issue details and evidence above');
                steps.push('Apply the appropriate fix based on the root cause');
                steps.push('Verify the fix by refreshing this dashboard');
            }

            return steps.map((step, idx) =>
                '<div class="detail-fix-step">' +
                    '<span class="detail-step-num">' + (idx + 1) + '</span>' +
                    '<span class="detail-step-text">' + step + '</span>' +
                '</div>'
            ).join('');
        }

        // Collect critical issues from all sections
        let allCriticalIssues = [];

        function showCriticalBanner() {
            const banner = document.getElementById('critical-banner');
            const list = document.getElementById('critical-list');
            const title = document.getElementById('critical-title');
            if (allCriticalIssues.length === 0) { banner.classList.remove('visible'); return; }
            title.textContent = allCriticalIssues.length + ' Critical Issue' + (allCriticalIssues.length > 1 ? 's' : '');
            list.innerHTML = allCriticalIssues.slice(0, 5).map(i =>
                '<div class="critical-item"><strong>' + esc(i.source) + ':</strong> ' + esc(i.title) + '</div>'
            ).join('');
            banner.classList.add('visible');
        }

        // --- Data Loaders ---

        async function loadDataQuality() {
            try {
                const res = await fetch('/data-quality/dashboard');
                const data = await res.json();
                const d = data.data || data;

                const score = d.quality_score ?? d.overall_score ?? 75;
                setScore('dq-score', score);
                setStatus('dq-status', score);
                setBadge('dq-badge', score);

                const issues = [];

                // Build issues from health checks
                const healthChecks = [
                    { key: 'sync_health', label: 'Data Sync' },
                    { key: 'tracking_health', label: 'Conversion Tracking' },
                    { key: 'utm_health', label: 'UTM Tracking' },
                    { key: 'feed_health', label: 'Merchant Center Feed' },
                    { key: 'link_health', label: 'Google Ads Link' }
                ];
                healthChecks.forEach(check => {
                    const h = d[check.key];
                    if (h && h.status === 'critical') {
                        issues.push({ severity: 'critical', title: check.label + ' is critical', description: h.message || h.detail || '', recommendation: 'Check ' + check.label.toLowerCase() + ' configuration', _stableKey: 'dq_' + check.key });
                        allCriticalIssues.push({ source: 'Data Quality', title: check.label + ' is critical' });
                    } else if (h && h.status === 'warning') {
                        issues.push({ severity: 'warning', title: check.label + ' needs attention', description: h.message || h.detail || '', recommendation: 'Review ' + check.label.toLowerCase(), _stableKey: 'dq_' + check.key });
                    }
                });

                // Freshness  API returns { sources: { table_name: { stale, lag_hours, ... } } }
                const freshness = d.freshness || {};
                const freshSources = freshness.sources || freshness;
                if (typeof freshSources === 'object' && !Array.isArray(freshSources)) {
                    Object.entries(freshSources).forEach(([source, info]) => {
                        if (info && typeof info === 'object' && (info.stale || info.is_stale || info.status === 'stale')) {
                            const lagH = info.lag_hours || info.hours_since_update;
                            const sev = lagH > 48 ? 'critical' : 'warning';
                            issues.push({ severity: sev, title: source + ' data is stale', description: 'Last update: ' + (lagH ? Math.round(lagH) + 'h ago' : 'unknown'), recommendation: 'Check sync for ' + source, _stableKey: 'freshness_' + source });
                            if (sev === 'critical') allCriticalIssues.push({ source: 'Data Quality', title: source + ' data is stale (' + Math.round(lagH) + 'h)' });
                        }
                    });
                }

                // Overall summary message as fallback
                if (issues.length === 0 && d.summary && d.summary.status === 'critical') {
                    issues.push({ severity: 'critical', title: d.summary.message || 'Data quality is critical', description: d.issues_found + ' issues found', recommendation: 'Review data quality dashboard for details' });
                    allCriticalIssues.push({ source: 'Data Quality', title: d.summary.message || 'Score: ' + score + '/100' });
                }

                document.getElementById('dq-issues').textContent = issues.length || d.issues_found || 0;
                renderIssues('dq-list', issues, 'All data sources are fresh and healthy', 'Data Quality');

                // Render freshness panel
                renderFreshness(d.freshness);

                return score;
            } catch (e) {
                document.getElementById('dq-list').innerHTML = '<div class="empty-state">Could not load data quality</div>';
                return null;
            }
        }

        async function loadSitePerformance() {
            try {
                const res = await fetch('/site-health/summary?hours=' + getWindowParams().hours);
                const data = await res.json();
                const d = data.data || data;

                const issues = [];

                // Core Web Vitals  API returns uppercase keys: LCP, CLS, INP, TTFB
                const cwv = d.core_web_vitals || {};
                let score = 85;

                // LCP (value in ms or seconds)
                const lcpRaw = cwv.LCP || cwv.lcp;
                if (lcpRaw !== null && lcpRaw !== undefined) {
                    const lcpVal = typeof lcpRaw === 'object' ? (lcpRaw.p75 || lcpRaw.value) : lcpRaw;
                    const lcpSamples = typeof lcpRaw === 'object' ? lcpRaw.sample_size : undefined;
                    if (lcpVal) {
                        const lcpMs = lcpVal > 100 ? lcpVal : lcpVal * 1000;
                        if (lcpMs > 4000) { issues.push({ severity: 'critical', title: 'LCP is poor: ' + (lcpMs / 1000).toFixed(1) + 's', description: 'Largest Contentful Paint should be under 2.5s', recommendation: 'Optimize images, reduce server response time', sample_size: lcpSamples, _stableKey: 'cwv_lcp' }); allCriticalIssues.push({ source: 'Performance', title: 'LCP is ' + (lcpMs / 1000).toFixed(1) + 's (poor)' }); score -= 25; }
                        else if (lcpMs > 2500) { issues.push({ severity: 'warning', title: 'LCP needs improvement: ' + (lcpMs / 1000).toFixed(1) + 's', description: 'Target under 2.5s for good experience', recommendation: 'Optimize largest image/text block', sample_size: lcpSamples, _stableKey: 'cwv_lcp' }); score -= 10; }
                    }
                }

                // CLS
                const clsRaw = cwv.CLS || cwv.cls;
                if (clsRaw !== null && clsRaw !== undefined) {
                    const clsVal = typeof clsRaw === 'object' ? (clsRaw.p75 || clsRaw.value) : clsRaw;
                    const clsSamples = typeof clsRaw === 'object' ? clsRaw.sample_size : undefined;
                    if (clsVal) {
                        if (clsVal > 0.25) { issues.push({ severity: 'critical', title: 'CLS is poor: ' + clsVal.toFixed(3), description: 'Cumulative Layout Shift should be under 0.1', recommendation: 'Set dimensions on images/ads, avoid dynamic content injection', sample_size: clsSamples, _stableKey: 'cwv_cls' }); score -= 20; }
                        else if (clsVal > 0.1) { issues.push({ severity: 'warning', title: 'CLS needs improvement: ' + clsVal.toFixed(3), description: 'Target under 0.1', recommendation: 'Reserve space for dynamic content', sample_size: clsSamples, _stableKey: 'cwv_cls' }); score -= 8; }
                    }
                }

                // INP
                const inpRaw = cwv.INP || cwv.inp;
                if (inpRaw !== null && inpRaw !== undefined) {
                    const inpVal = typeof inpRaw === 'object' ? (inpRaw.p75 || inpRaw.value) : inpRaw;
                    const inpSamples = typeof inpRaw === 'object' ? inpRaw.sample_size : undefined;
                    if (inpVal) {
                        if (inpVal > 500) { issues.push({ severity: 'critical', title: 'INP is poor: ' + inpVal + 'ms', description: 'Interaction to Next Paint should be under 200ms', recommendation: 'Reduce JavaScript execution time, optimize event handlers', sample_size: inpSamples, _stableKey: 'cwv_inp' }); score -= 20; }
                        else if (inpVal > 200) { issues.push({ severity: 'warning', title: 'INP needs improvement: ' + inpVal + 'ms', description: 'Target under 200ms', recommendation: 'Optimize interaction responsiveness', sample_size: inpSamples, _stableKey: 'cwv_inp' }); score -= 8; }
                    }
                }

                // Error pages
                const errorPages = d.error_pages || [];
                if (Array.isArray(errorPages)) {
                    errorPages.slice(0, 3).forEach(err => {
                        const count = err.error_count || err.count || err.occurrences || '';
                        issues.push({ severity: 'warning', title: (err.status_code ? err.status_code + ' error' : 'Error') + (err.page_path ? ' on ' + err.page_path : ''), description: count + ' occurrences', file_path: err.page_path || err.url, recommendation: 'Investigate and fix error page' });
                    });
                }

                // Error types
                const errorTypes = d.error_types || [];
                if (Array.isArray(errorTypes)) {
                    errorTypes.slice(0, 3).forEach(err => {
                        issues.push({ severity: 'warning', title: err.error_type || err.type || 'Error', description: (err.count || '') + ' occurrences', recommendation: 'Fix this error type' });
                    });
                }

                // Slow pages
                const slow = d.slowest_pages || [];
                if (Array.isArray(slow)) {
                    slow.slice(0, 2).forEach(p => {
                        const lcp = p.lcp_p75 || p.avg_lcp || p.lcp;
                        issues.push({ severity: 'info', title: 'Slow page' + (lcp ? ': ' + (lcp > 100 ? (lcp / 1000).toFixed(1) : lcp.toFixed(1)) + 's LCP' : ''), file_path: p.page_path || p.url || p.path, recommendation: 'Optimize page load' });
                    });
                }

                // Slow resources (scripts, images, fonts loading >2s)
                const slowRes = d.slow_resources || [];
                if (Array.isArray(slowRes)) {
                    slowRes.forEach(r => {
                        const ms = r.avg_duration_ms || 0;
                        const sev = ms > 5000 ? 'warning' : 'info';
                        const url = r.resource_url || '';
                        const shortUrl = url.split('/').pop().split('?')[0] || url.slice(0, 60);
                        const typeLabel = (r.resource_type || 'resource').replace('xmlhttprequest', 'XHR');
                        issues.push({
                            severity: sev,
                            title: 'Slow ' + typeLabel + ': ' + (ms / 1000).toFixed(1) + 's  ' + shortUrl,
                            description: r.count + ' occurrence' + (r.count !== 1 ? 's' : '') + '  avg ' + Math.round(ms) + 'ms',
                            file_path: url,
                            recommendation: typeLabel === 'script' ? 'Defer or async-load this script, or replace with lighter alternative' :
                                typeLabel === 'img' ? 'Compress image, serve in WebP/AVIF, or lazy-load below the fold' :
                                typeLabel === 'css' ? 'Inline critical CSS, defer non-critical stylesheet' :
                                typeLabel === 'font' ? 'Use font-display: swap, preload critical fonts' :
                                'Optimize or defer this resource to reduce page load time',
                            _resourceType: typeLabel,
                            _avgMs: ms
                        });
                        if (sev === 'warning') score -= 3;
                    });
                }

                // If no CWV data at all, show neutral "No Data" state
                const noData = !lcpRaw && !clsRaw && !inpRaw && errorPages.length === 0 && errorTypes.length === 0 && slow.length === 0 && slowRes.length === 0;
                if (noData) {
                    issues.push({ severity: 'info', title: 'No performance data available', description: 'GA4 performance events may not be configured', recommendation: 'Ensure GA4 is tracking Core Web Vitals' });
                    score = null;
                }

                if (score !== null) score = Math.max(0, Math.min(100, score));
                setScore('sp-score', noData ? '--' : score);
                if (noData) {
                    const statusEl = document.getElementById('sp-status');
                    if (statusEl) { statusEl.textContent = 'No Data'; statusEl.className = 'hi-status status-nodata'; }
                    const badgeEl = document.getElementById('sp-badge');
                    if (badgeEl) { badgeEl.textContent = 'No Data'; badgeEl.className = 'section-badge status-nodata'; }
                } else {
                    setStatus('sp-status', score);
                    setBadge('sp-badge', score);
                }
                document.getElementById('sp-issues').textContent = issues.length;
                renderIssues('sp-list', issues, 'Site performance looks healthy', 'Site Performance');
                return score;
            } catch (e) {
                document.getElementById('sp-list').innerHTML = '<div class="empty-state">Could not load site performance</div>';
                return null;
            }
        }

        async function loadCodeHealth() {
            try {
                const res = await fetch('/code/issues');
                const data = await res.json();
                const d = data.data || data;

                const issues = d.issues || [];
                const summary = d.summary || {};
                const total = d.total_count || issues.length;
                const critical = summary.critical || 0;
                const warning = summary.warning || 0;

                let score = 100 - (critical * 10) - (warning * 3);
                score = Math.max(0, Math.min(100, score));

                // Add critical code issues to global list
                issues.filter(i => i.severity === 'critical').forEach(i => {
                    allCriticalIssues.push({ source: 'Code Health', title: i.title || i.check_name });
                });

                setScore('ch-score', score);
                setStatus('ch-status', score);
                setBadge('ch-badge', score);
                document.getElementById('ch-issues').textContent = total;
                renderClusteredIssues('ch-list', issues, 'No code issues found. Theme looks clean!', 'Code Health', 'category');
                return score;
            } catch (e) {
                document.getElementById('ch-list').innerHTML = '<div class="empty-state">Could not load code health. Is GitHub connected?</div>';
                return null;
            }
        }

        async function loadRedirectHealth() {
            try {
                const res = await fetch('/redirects/dashboard?days=' + getWindowParams().days);
                const data = await res.json();
                const d = data.data || data;

                const issues = [];
                let score = 90;
                const overview = d.overview || {};

                // 404 errors from 404_summary.top_errors
                const summary404 = d['404_summary'] || {};
                const errors404 = summary404.top_errors || d.top_404s || [];
                if (Array.isArray(errors404)) {
                    errors404.slice(0, 4).forEach(e => {
                        const traffic = e.traffic || {};
                        const hits = traffic.total_hits || e.total_hits || e.hit_count || 0;
                        const revImpact = e.revenue_impact || {};
                        const revenue = revImpact.estimated_monthly_revenue_loss || e.estimated_lost_revenue || 0;
                        const confidence = revImpact.confidence_level || null;
                        const cause = e.likely_cause || (e.requested_url && e.requested_url.includes('/products/') ? 'deleted_product' : 'unknown');
                        const sev = hits > 100 ? 'critical' : hits > 20 ? 'warning' : 'info';
                        issues.push({ severity: sev, title: '404: ' + (e.requested_url || e.url_path || e.url), description: hits + ' hits' + (revenue ? ' / ~$' + Math.round(revenue) + '/mo lost' : ''), revenue_impact: revenue, confidence_level: confidence, likely_cause: cause, traffic_hits: hits, recommendation: (e.recommended_redirect || {}).action || e.recommended_action || 'Create redirect or restore page' });
                        totalRevenueAtRisk += revenue;
                        if (sev === 'critical') { allCriticalIssues.push({ source: 'Redirects', title: '404 with ' + hits + ' hits: ' + (e.requested_url || e.url), revenue: revenue }); score -= 15; }
                        else if (sev === 'warning') score -= 5;
                    });
                }

                // Redirect issues from redirect_issues_summary
                const redirectSummary = d.redirect_issues_summary || {};
                if (redirectSummary.redirect_chains > 0) {
                    issues.push({ severity: 'warning', title: redirectSummary.redirect_chains + ' redirect chain(s) detected', description: 'Multiple hops slow down page loads and waste crawl budget', recommendation: 'Simplify to single direct redirects', likely_cause: 'redirect_chain' });
                    score -= 5 * redirectSummary.redirect_chains;
                }
                if (redirectSummary.broken_redirects > 0) {
                    issues.push({ severity: 'critical', title: redirectSummary.broken_redirects + ' broken redirect(s)', description: 'Redirects pointing to non-existent pages', recommendation: 'Fix redirect destinations', likely_cause: 'broken_redirect' });
                    allCriticalIssues.push({ source: 'Redirects', title: redirectSummary.broken_redirects + ' broken redirects' });
                    score -= 15;
                }

                // Broken links from broken_links_summary.top_links
                const brokenSummary = d.broken_links_summary || {};
                const brokenLinks = brokenSummary.top_links || d.broken_links || [];
                if (Array.isArray(brokenLinks)) {
                    brokenLinks.slice(0, 3).forEach(b => {
                        issues.push({ severity: b.priority === 'high' ? 'warning' : 'info', title: 'Broken link on ' + (b.source_page || 'page'), description: 'Links to: ' + (b.broken_link || b.broken_url || b.url), recommendation: b.recommended_fix || 'Fix or remove broken link', likely_cause: 'broken_external' });
                    });
                }

                // Top priorities as additional context
                const priorities = d.top_priorities || [];
                if (Array.isArray(priorities) && issues.length === 0) {
                    priorities.slice(0, 3).forEach(p => {
                        issues.push({ severity: p.priority === 'high' ? 'warning' : 'info', title: p.title, description: p.description, recommendation: p.action || '', likely_cause: 'unknown' });
                    });
                }

                // Revenue impact
                const totalRevenueLoss = overview.total_revenue_loss || 0;
                if (totalRevenueLoss > 500) {
                    score -= 10;
                }

                score = Math.max(0, Math.min(100, score));
                setScore('rh-score', score);
                setStatus('rh-status', score);
                setBadge('rh-badge', score);
                document.getElementById('rh-issues').textContent = issues.length;
                renderClusteredIssues('rh-list', issues, 'No redirect issues found', 'Redirects & 404s', 'likely_cause');
                return score;
            } catch (e) {
                document.getElementById('rh-list').innerHTML = '<div class="empty-state">Could not load redirect health</div>';
                return null;
            }
        }

        // Track revenue at risk from redirects
        let totalRevenueAtRisk = 0;

        function renderFreshness(freshness) {
            const panel = document.getElementById('freshness-panel');
            const grid = document.getElementById('freshness-grid');
            if (!freshness || !freshness.sources) { panel.style.display = 'none'; return; }
            panel.style.display = '';

            const sourceNames = {
                'shopify_orders': 'Shopify Orders',
                'shopify_order_items': 'Order Items',
                'ga4_daily_summary': 'GA4 Analytics',
                'ga4_traffic_sources': 'GA4 Traffic',
                'search_console_queries': 'GSC Queries',
                'search_console_pages': 'GSC Pages',
                'google_ads_campaigns': 'Google Ads',
                'merchant_center_statuses': 'Merchant Center'
            };

            const entries = Object.entries(freshness.sources);
            grid.innerHTML = entries.map(([key, s]) => {
                const name = sourceNames[key] || key.replace(/_/g, ' ');
                const isStale = s.stale || s.status === 'stale';
                const lagH = Math.round(s.lag_hours || 0);
                const rows = s.rows || 0;
                const age = lagH < 1 ? 'Just now' : lagH < 24 ? lagH + 'h ago' : Math.round(lagH / 24) + 'd ago';
                return '<div class="freshness-item ' + (isStale ? 'stale' : 'fresh') + '">' +
                    '<div class="freshness-source"><span class="freshness-dot ' + (isStale ? 'stale' : 'fresh') + '"></span>' + esc(name) + '</div>' +
                    '<div class="freshness-age">' + age + '</div>' +
                    '<div class="freshness-rows">' + rows.toLocaleString() + ' rows</div>' +
                '</div>';
            }).join('');
        }

        function renderPriorities() {
            const panel = document.getElementById('priorities-panel');
            const list = document.getElementById('priorities-list');

            // Gather top issues from all issueStore sections by impactWeight
            const allIssues = [];
            Object.entries(issueStore).forEach(([listId, store]) => {
                (store.issues || []).forEach(issue => {
                    const tracked = issueTracker.getStatus(store.source, issue);
                    const isResolved = tracked && (tracked.status === 'resolved' || tracked.status === 'false_positive');
                    if (!isResolved) {
                        allIssues.push({ ...issue, _source: store.source, _listId: listId });
                    }
                });
            });

            // Sort by impactWeight descending (overdue issues get 1.5x boost), take top 5
            allIssues.sort((a, b) => {
                let wa = a.impactWeight || 0, wb = b.impactWeight || 0;
                const ta = issueTracker.getStatus(a._source, a);
                const tb = issueTracker.getStatus(b._source, b);
                if (ta && ta.dueDate && new Date(ta.dueDate + 'T23:59:59') < new Date()) wa *= 1.5;
                if (tb && tb.dueDate && new Date(tb.dueDate + 'T23:59:59') < new Date()) wb *= 1.5;
                return wb - wa;
            });
            const topItems = allIssues.slice(0, 5);

            if (topItems.length === 0) { panel.style.display = 'none'; return; }
            panel.style.display = '';

            list.innerHTML = topItems.map((item, idx) => {
                const sev = item.severity || 'info';
                return '<div class="priority-item">' +
                    '<div class="priority-num">' + (idx + 1) + '</div>' +
                    '<div class="priority-body">' +
                        '<div class="priority-title">' + esc(item.title || item.check_name || 'Issue') + '</div>' +
                        (item.revenue_impact ? '<div class="priority-impact">~$' + Math.round(item.revenue_impact) + '/mo at risk</div>' : '') +
                        '<div class="priority-action">' + esc(item._source) + ' &middot; Impact: ' + (item.impactWeight || 0) + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderKPIs(totalIssues) {
            const strip = document.getElementById('kpi-strip');
            strip.style.display = '';

            document.getElementById('kpi-revenue').textContent = totalRevenueAtRisk > 0 ? '$' + Math.round(totalRevenueAtRisk).toLocaleString() + '/mo' : '$0';
            document.getElementById('kpi-total-issues').textContent = totalIssues;

            // Change tracking via localStorage (window-scoped)
            const storageKey = 'site_intel_snapshot_' + currentTimeWindow;
            const prev = JSON.parse(localStorage.getItem(storageKey) || 'null');
            const newEl = document.getElementById('kpi-new-issues');

            if (prev && prev.totalIssues !== undefined) {
                const diff = totalIssues - prev.totalIssues;
                if (diff > 0) { newEl.textContent = '+' + diff; newEl.style.color = 'var(--red)'; }
                else if (diff < 0) { newEl.textContent = diff; newEl.style.color = 'var(--green)'; }
                else { newEl.textContent = 'None'; newEl.style.color = 'var(--green)'; }
            } else {
                newEl.textContent = 'First visit';
                newEl.style.color = 'var(--slate)';
            }

            // Save current snapshot
            localStorage.setItem(storageKey, JSON.stringify({
                totalIssues: totalIssues,
                revenue: totalRevenueAtRisk,
                timestamp: new Date().toISOString()
            }));
        }

        let executiveMode = false;

        function toggleExecutiveView() {
            executiveMode = !executiveMode;
            const panel = document.getElementById('executive-panel');
            const btn = document.getElementById('exec-toggle-btn');
            if (executiveMode) {
                panel.classList.add('visible');
                btn.style.background = 'var(--cass-black)'; btn.style.color = '#f7f1e8';
                renderExecutiveSummary();
            } else {
                panel.classList.remove('visible');
                btn.style.background = ''; btn.style.color = '';
            }
        }

        function renderExecutiveSummary() {
            const grid = document.getElementById('exec-grid');
            const fixesEl = document.getElementById('exec-fixes');

            // 1. Score change vs history
            const history = JSON.parse(localStorage.getItem('site_intel_scores_' + currentTimeWindow) || '[]');
            let scoreCard = '';
            if (history.length >= 2) {
                const oldest = history[0], latest = history[history.length - 1];
                const changes = ['dq','sp','ch','rh'].map(s => (oldest[s] !== null && latest[s] !== null) ? latest[s] - oldest[s] : null).filter(c => c !== null);
                const avg = changes.length > 0 ? Math.round(changes.reduce((a,b) => a+b, 0) / changes.length) : 0;
                const clr = avg > 0 ? 'var(--green)' : avg < 0 ? 'var(--red)' : 'var(--slate)';
                scoreCard = '<div class="exec-card"><div class="exec-card-label">Health Score Change</div><div class="exec-card-value" style="color:' + clr + '">' + (avg > 0 ? '+' : '') + avg + ' pts</div><div class="exec-card-detail">vs ' + history.length + ' days ago</div></div>';
            }

            // 2. Revenue at risk
            let revCard = '<div class="exec-card"><div class="exec-card-label">Revenue at Risk</div><div class="exec-card-value" style="color:var(--red)">$' + Math.round(totalRevenueAtRisk).toLocaleString() + '/mo</div>';
            const prev = JSON.parse(localStorage.getItem('site_intel_snapshot_' + currentTimeWindow) || 'null');
            if (prev && prev.revenue !== undefined) {
                const diff = totalRevenueAtRisk - prev.revenue;
                const clr = diff > 0 ? 'var(--red)' : diff < 0 ? 'var(--green)' : 'var(--slate)';
                revCard += '<div class="exec-card-detail" style="color:' + clr + '">' + (diff > 0 ? '+' : '') + '$' + Math.round(Math.abs(diff)).toLocaleString() + ' vs last visit</div>';
            }
            revCard += '</div>';

            // 3. In-progress count
            let inProgress = 0;
            Object.entries(issueStore).forEach(([, store]) => {
                (store.issues || []).forEach(issue => {
                    const t = issueTracker.getStatus(store.source, issue);
                    if (t && (t.status === 'acknowledged' || t.status === 'investigating')) inProgress++;
                });
            });
            const effortCard = '<div class="exec-card"><div class="exec-card-label">In Progress</div><div class="exec-card-value">' + inProgress + '</div><div class="exec-card-detail">Issues being worked on</div></div>';

            // 4. Validated fixes
            let verifiedCount = 0, verifiedImpact = 0;
            const verifiedFixes = [];
            Object.entries(issueStore).forEach(([, store]) => {
                (store.issues || []).forEach(issue => {
                    const v = issueTracker.getVerification(store.source, issue);
                    if (v && v.verifiedResult === 'passed') {
                        verifiedCount++;
                        verifiedImpact += issue.dollarImpact || 0;
                        verifiedFixes.push({ title: issue.title || issue.check_name, source: store.source, verifiedAt: v.verifiedAt, details: v.verifiedDetails, dollarImpact: issue.dollarImpact || 0 });
                    }
                });
            });
            const valCard = '<div class="exec-card"><div class="exec-card-label">Validated Fixes</div><div class="exec-card-value" style="color:var(--green)">' + verifiedCount + '</div><div class="exec-card-detail">$' + verifiedImpact.toLocaleString() + '/mo impact resolved</div></div>';

            grid.innerHTML = scoreCard + revCard + effortCard + valCard;

            // 5. Top validated fixes
            if (verifiedFixes.length > 0) {
                verifiedFixes.sort((a,b) => (b.dollarImpact || 0) - (a.dollarImpact || 0));
                let fhtml = '<h3 style="font-family:Space Grotesk;font-size:15px;font-weight:600;margin-bottom:10px">Top Validated Fixes</h3>';
                verifiedFixes.slice(0, 3).forEach(f => {
                    fhtml += '<div class="exec-fix-item"><span class="exec-fix-badge" style="background:var(--green-bg);color:var(--green)">Verified</span><div>' +
                        '<div style="font-weight:500;font-size:14px">' + esc(f.title) + '</div>' +
                        '<div style="font-size:12px;color:var(--slate)">' + esc(f.source) + (f.dollarImpact ? ' &middot; $' + f.dollarImpact.toLocaleString() + '/mo saved' : '') + ' &middot; ' + new Date(f.verifiedAt).toLocaleDateString() + '</div>' +
                        (f.details ? '<div style="font-size:12px;color:var(--cass-teal);margin-top:2px">' + esc(f.details) + '</div>' : '') +
                        '</div></div>';
                });
                fixesEl.innerHTML = fhtml;
            } else {
                fixesEl.innerHTML = '<div style="text-align:center;padding:16px;color:var(--slate);font-size:13px">No verified fixes yet. Resolve issues and verify them to track validated outcomes here.</div>';
            }
        }

        function exportCSV() {
            const rows = [['Source', 'Severity', 'Title', 'Impact Score', 'Revenue Impact', 'Status', 'Owner', 'Due Date', 'First Seen', 'Category', 'File Path', 'Recommendation']];
            Object.entries(issueStore).forEach(([listId, store]) => {
                (store.issues || []).forEach(issue => {
                    const tracked = issueTracker.getStatus(store.source, issue) || {};
                    const tl = issueTracker.getTimeline(store.source, issue) || {};
                    rows.push([
                        store.source,
                        issue.severity || 'info',
                        (issue.title || issue.check_name || '').replace(/"/g, '""'),
                        issue.impactWeight || 0,
                        issue.revenue_impact || '',
                        tracked.status || 'open',
                        tracked.owner || '',
                        tracked.dueDate || '',
                        tl.firstSeenAt ? new Date(tl.firstSeenAt).toLocaleDateString() : '',
                        issue.category || '',
                        issue.file_path || '',
                        (issue.recommendation || issue.fix || '').replace(/"/g, '""')
                    ]);
                });
            });
            const csv = rows.map(r => r.map(c => '"' + c + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'site-intelligence-' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copySummary() {
            let totalIssues = 0, critCount = 0, warnCount = 0, infoCount = 0;
            const sourceStats = {};
            Object.entries(issueStore).forEach(([listId, store]) => {
                const issues = store.issues || [];
                totalIssues += issues.length;
                issues.forEach(i => {
                    if (i.severity === 'critical') critCount++;
                    else if (i.severity === 'warning') warnCount++;
                    else infoCount++;
                });
                sourceStats[store.source] = issues.length;
            });

            const allSorted = [];
            Object.entries(issueStore).forEach(([listId, store]) => {
                (store.issues || []).forEach(issue => allSorted.push({ ...issue, _source: store.source }));
            });
            allSorted.sort((a, b) => (b.impactWeight || 0) - (a.impactWeight || 0));
            const top3 = allSorted.slice(0, 3);

            let text = 'SITE INTELLIGENCE SUMMARY  ' + new Date().toLocaleDateString() + '\n';
            text += '='.repeat(50) + '\n\n';
            text += 'Total Issues: ' + totalIssues + ' (Critical: ' + critCount + ', Warning: ' + warnCount + ', Info: ' + infoCount + ')\n';
            text += 'Revenue at Risk: $' + Math.round(totalRevenueAtRisk).toLocaleString() + '/mo\n\n';
            text += 'By Source:\n';
            Object.entries(sourceStats).forEach(([src, cnt]) => { text += '  - ' + src + ': ' + cnt + ' issues\n'; });
            text += '\nTop 3 Priorities:\n';
            top3.forEach((item, i) => {
                text += '  ' + (i + 1) + '. ' + (item.title || item.check_name || 'Issue') + ' [' + item._source + ']';
                if (item.revenue_impact) text += ' (~$' + Math.round(item.revenue_impact) + '/mo)';
                text += '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copy-summary-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy Summary'; }, 2000);
            });
        }

        async function loadAll() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            allCriticalIssues = [];
            totalRevenueAtRisk = 0;

            // Cleanup stale localStorage entries (>90 days)
            issueTracker.cleanup();

            // Load site-wide metrics AND all sections in parallel
            const [, dqScore, spScore, chScore, rhScore] = await Promise.all([
                fetchSiteMetrics(),
                loadDataQuality(),
                loadSitePerformance(),
                loadCodeHealth(),
                loadRedirectHealth()
            ]);

            // Calculate overall score
            const scores = [dqScore, spScore, chScore, rhScore].filter(s => s !== null);
            const overall = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            setScoreRing(overall);

            // --- Trend context (window-scoped) ---
            const historyKey = 'site_intel_scores_' + currentTimeWindow;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const today = new Date().toISOString().slice(0, 10);
            // Dedup by date - replace today's entry if exists
            const filtered = history.filter(h => h.date !== today);
            filtered.push({ date: today, dq: dqScore, sp: spScore, ch: chScore, rh: rhScore });
            // Keep last 7 entries
            const trimmed = filtered.slice(-7);
            localStorage.setItem(historyKey, JSON.stringify(trimmed));

            // Compare current to oldest entry for trend badges
            if (trimmed.length >= 2) {
                const oldest = trimmed[0];
                document.getElementById('dq-trend').innerHTML = trendBadge(dqScore, oldest.dq, true);
                document.getElementById('sp-trend').innerHTML = trendBadge(spScore, oldest.sp, true);
                document.getElementById('ch-trend').innerHTML = trendBadge(chScore, oldest.ch, true);
                document.getElementById('rh-trend').innerHTML = trendBadge(rhScore, oldest.rh, true);
            }

            // Sweep all current issues for timeline tracking
            Object.entries(issueStore).forEach(([listId, store]) => {
                (store.issues || []).forEach(issue => {
                    issueTracker.updateTimeline(store.source, issue);
                });
            });
            issueTracker.saveAll();

            // Build cross-source related issues map
            buildRelatedIssuesMap();

            // Count total issues
            const totalIssues = ['dq-issues', 'sp-issues', 'ch-issues', 'rh-issues']
                .map(id => parseInt(document.getElementById(id).textContent) || 0)
                .reduce((a, b) => a + b, 0);

            // Render new panels
            renderKPIs(totalIssues);
            renderPriorities();
            if (executiveMode) renderExecutiveSummary();
            showCriticalBanner();

            // Update timestamp
            const now = new Date();
            document.getElementById('last-refresh').textContent = 'Last refresh: ' + now.toLocaleTimeString();

            // Update filter pill counts and re-apply active filter
            updateFilterCounts();
            applyFilter();

            btn.disabled = false;
            btn.textContent = 'Refresh';

            // Restart auto-refresh countdown
            startRefreshTimer();
        }

        // Load on page load
        loadAll();
    </script>

<!-- Invite User Modal -->
<div id="invite-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:16px;padding:32px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.15)">
        <h3 style="font-family:'Space Grotesk',sans-serif;margin-bottom:8px">Invite User</h3>
        <p style="color:#6b6670;font-size:14px;margin-bottom:20px">Send an invite email to create a new account</p>
        <div id="invite-error" style="background:#fef2f2;color:#dc2626;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
        <div id="invite-success" style="background:#f0fdf4;color:#16a34a;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
        <input type="email" id="invite-email" placeholder="email@example.com" style="width:100%;padding:12px 14px;border:1px solid rgba(27,27,27,0.08);border-radius:10px;font-size:14px;font-family:'IBM Plex Sans',sans-serif;margin-bottom:16px;outline:none;background:#faf9f6">
        <div style="display:flex;gap:12px">
            <button onclick="closeInviteModal()" style="flex:1;padding:12px;border:1px solid rgba(27,27,27,0.08);border-radius:10px;background:#fff;font-size:14px;font-family:'Space Grotesk',sans-serif;cursor:pointer">Cancel</button>
            <button id="send-invite-btn" onclick="sendInvite()" style="flex:1;padding:12px;background:#1b1b1b;color:#f7f1e8;border:none;border-radius:10px;font-size:14px;font-weight:600;font-family:'Space Grotesk',sans-serif;cursor:pointer">Send Invite</button>
        </div>
    </div>
</div>
<script>
function openInviteModal(){
    var m=document.getElementById('invite-modal');m.style.display='flex';
    document.getElementById('invite-email').value='';
    document.getElementById('invite-error').style.display='none';
    document.getElementById('invite-success').style.display='none';
    document.getElementById('invite-email').focus();
}
function closeInviteModal(){document.getElementById('invite-modal').style.display='none'}
async function sendInvite(){
    var btn=document.getElementById('send-invite-btn');
    var email=document.getElementById('invite-email').value.trim();
    var errEl=document.getElementById('invite-error');
    var okEl=document.getElementById('invite-success');
    errEl.style.display='none';okEl.style.display='none';
    if(!email){errEl.textContent='Please enter an email address';errEl.style.display='block';return}
    btn.disabled=true;btn.textContent='Sending...';
    try{
        var r=await fetch('/auth/invite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email})});
        var d=await r.json();
        if(r.ok){okEl.textContent='Invite sent to '+email;okEl.style.display='block';document.getElementById('invite-email').value=''}
        else{errEl.textContent=d.detail||'Failed to send invite';errEl.style.display='block'}
    }catch(e){errEl.textContent='Network error';errEl.style.display='block'}
    btn.disabled=false;btn.textContent='Send Invite';
}
document.getElementById('invite-modal').addEventListener('click',function(e){if(e.target===this)closeInviteModal()});
</script>
</body>
</html>
