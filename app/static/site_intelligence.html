<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Intelligence - Cass Brothers</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

        :root {
            --ink: #1c1b1f;
            --ink-soft: #3d3a40;
            --slate: #6b6670;
            --stone: #f4f2ee;
            --pearl: #faf9f6;
            --cass-black: #1b1b1b;
            --cass-cream: #f7f3ed;
            --cass-gold: #c49a4a;
            --cass-moss: #2f3d33;
            --cass-teal: #1f6f6b;
            --card: #ffffff;
            --line: rgba(27, 27, 27, 0.08);
            --shadow: 0 18px 45px rgba(17, 18, 19, 0.08);
            --red: #a63a3a;
            --red-bg: rgba(166, 58, 58, 0.1);
            --amber: #8b6b1f;
            --amber-bg: rgba(196, 154, 74, 0.15);
            --green: #2f6b3a;
            --green-bg: rgba(47, 107, 58, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "IBM Plex Sans", "Space Grotesk", sans-serif;
            background: radial-gradient(circle at top left, #fdfbf7 0%, var(--cass-cream) 45%, #f1ede6 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .brand-bar {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: 0.5px;
        }

        .brand-dot {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--cass-gold);
            box-shadow: 0 0 0 4px rgba(196, 154, 74, 0.2);
        }

        .brand-bar input {
            width: min(520px, 50vw);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            padding: 10px 16px;
            color: #f7f1e8;
            outline: none;
            font-size: 14px;
        }

        .brand-bar input::placeholder { color: rgba(247, 241, 232, 0.6); }

        .brand-actions { display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .pill { padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(255, 255, 255, 0.2); }

        .side-nav {
            grid-row: 2 / span 1;
            padding: 28px 20px;
            border-right: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.4) 100%);
        }

        .side-nav h2 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--slate);
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 12px; font-size: 14px;
            color: var(--ink-soft); margin-bottom: 6px; cursor: pointer;
            transition: all 0.2s ease; text-decoration: none;
        }

        .nav-item.active {
            background: var(--cass-black); color: #f7f1e8;
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .nav-item span { width: 8px; height: 8px; border-radius: 50%; background: var(--cass-gold); opacity: 0.7; }

        .main-area {
            grid-row: 2;
            padding: 28px 32px 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        /* Header */
        .overview {
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
        }
        .overview h1 { font-family: "Space Grotesk", sans-serif; font-size: 26px; }
        .time-pill { padding: 8px 14px; border-radius: 999px; background: rgba(27,27,27,0.06); font-size: 13px; color: var(--ink-soft); }

        /* Health Score Hero */
        .health-hero {
            display: flex; align-items: center; gap: 28px;
            background: var(--card); border-radius: 18px; padding: 24px 28px;
            border: 1px solid var(--line); box-shadow: var(--shadow);
        }

        .score-ring {
            position: relative; width: 100px; height: 100px; flex-shrink: 0;
        }

        .score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }

        .score-ring .bg { fill: none; stroke: #ede9e2; stroke-width: 8; }
        .score-ring .fg { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }

        .score-number {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-family: "Space Grotesk", sans-serif; font-size: 28px; font-weight: 700;
        }

        .health-breakdown { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        .health-item { text-align: center; }
        .health-item .hi-label { font-size: 12px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; }
        .health-item .hi-value { font-size: 22px; font-weight: 600; margin-top: 4px; }
        .health-item .hi-status { font-size: 11px; margin-top: 4px; padding: 2px 8px; border-radius: 999px; display: inline-block; }

        .status-good { background: var(--green-bg); color: var(--green); }
        .status-warning { background: var(--amber-bg); color: var(--amber); }
        .status-critical { background: var(--red-bg); color: var(--red); }
        .status-nodata { background: rgba(107, 102, 112, 0.1); color: var(--slate); }

        /* Critical Issues Banner */
        .critical-banner {
            background: var(--red-bg); border: 1px solid rgba(166,58,58,0.2);
            border-radius: 14px; padding: 14px 18px;
            display: none; gap: 10px; flex-direction: column;
        }

        .critical-banner.visible { display: flex; }

        .critical-banner h3 { color: var(--red); font-size: 14px; font-family: "Space Grotesk", sans-serif; }

        .critical-item {
            font-size: 13px; color: var(--red); padding: 8px 12px;
            background: rgba(255,255,255,0.6); border-radius: 10px;
        }

        /* Section Cards */
        .section-card {
            background: var(--card); border-radius: 18px; padding: 0;
            border: 1px solid var(--line); box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; cursor: pointer; user-select: none;
            transition: background 0.15s;
        }

        .section-header:hover { background: rgba(0,0,0,0.02); }

        .section-header h3 {
            font-family: "Space Grotesk", sans-serif; font-size: 16px;
            display: flex; align-items: center; gap: 10px;
        }

        .section-badge {
            font-size: 11px; padding: 2px 8px; border-radius: 999px;
            font-family: "IBM Plex Sans", sans-serif; font-weight: 500;
        }

        .section-score { font-size: 14px; color: var(--slate); display: flex; align-items: center; gap: 8px; }
        .section-score strong { font-size: 18px; color: var(--ink); }

        .chevron { transition: transform 0.2s; font-size: 12px; color: var(--slate); }
        .section-header.collapsed .chevron { transform: rotate(-90deg); }

        .section-body { padding: 0 20px 18px; }
        .section-body.hidden { display: none; }

        .issue-list { display: flex; flex-direction: column; gap: 8px; }

        .issue-row {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 14px; border-radius: 12px; font-size: 13px;
            border: 1px solid var(--line); background: var(--pearl);
        }

        .issue-severity {
            flex-shrink: 0; width: 8px; height: 8px; border-radius: 50%; margin-top: 5px;
        }

        .sev-critical { background: var(--red); }
        .sev-warning { background: var(--cass-gold); }
        .sev-info { background: var(--cass-teal); }

        .issue-body { flex: 1; }
        .issue-title { font-weight: 500; color: var(--ink); }
        .issue-detail { color: var(--slate); font-size: 12px; margin-top: 2px; }
        .issue-file { font-family: monospace; font-size: 11px; color: var(--cass-teal); margin-top: 3px; }
        .issue-fix { font-size: 12px; color: var(--cass-moss); margin-top: 4px; font-style: italic; }

        .empty-state { text-align: center; padding: 20px; color: var(--slate); font-size: 13px; }

        .issue-link { font-size: 11px; margin-top: 3px; }
        .issue-link a { color: var(--cass-teal); text-decoration: none; font-family: monospace; }
        .issue-link a:hover { text-decoration: underline; }

        /* KPI Strip */
        .kpi-strip {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
            margin-bottom: 18px;
        }
        .kpi-item {
            background: var(--card); border-radius: 14px; padding: 16px 20px;
            border: 1px solid var(--line); box-shadow: var(--shadow);
        }
        .kpi-label { font-size: 12px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .kpi-value { font-size: 22px; font-weight: 600; font-family: "Space Grotesk", sans-serif; }
        .kpi-revenue .kpi-value { color: var(--red); }
        .kpi-issues .kpi-value { color: var(--ink); }
        .kpi-new .kpi-value { color: var(--cass-gold); }

        /* Priorities Panel */
        .priorities-panel {
            background: var(--card); border-radius: 16px; padding: 18px 22px;
            border: 1px solid var(--line); box-shadow: var(--shadow); margin-bottom: 18px;
        }
        .priorities-panel h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; font-family: "Space Grotesk", sans-serif; }
        .priority-item {
            display: flex; align-items: flex-start; gap: 12px; padding: 10px 0;
            border-bottom: 1px solid var(--line);
        }
        .priority-item:last-child { border-bottom: none; }
        .priority-num {
            flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%;
            background: var(--cass-gold); color: #fff; font-weight: 600; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .priority-body { flex: 1; }
        .priority-title { font-weight: 500; font-size: 14px; }
        .priority-impact { font-size: 12px; color: var(--red); font-weight: 500; margin-top: 2px; }
        .priority-action { font-size: 12px; color: var(--slate); margin-top: 2px; }

        /* Freshness Panel */
        .freshness-panel {
            background: var(--card); border-radius: 16px; padding: 18px 22px;
            border: 1px solid var(--line); box-shadow: var(--shadow); margin-bottom: 18px;
        }
        .freshness-panel h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; font-family: "Space Grotesk", sans-serif; }
        .freshness-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;
        }
        .freshness-item {
            padding: 10px 14px; border-radius: 10px; border: 1px solid var(--line);
            background: var(--pearl); font-size: 12px;
        }
        .freshness-source { font-weight: 500; color: var(--ink); margin-bottom: 3px; font-size: 13px; }
        .freshness-age { color: var(--slate); }
        .freshness-rows { color: var(--slate); font-size: 11px; }
        .freshness-item.stale { border-color: rgba(166, 58, 58, 0.3); background: var(--red-bg); }
        .freshness-item.fresh { border-color: rgba(47, 107, 58, 0.3); background: var(--green-bg); }
        .freshness-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
        .freshness-dot.stale { background: var(--red); }
        .freshness-dot.fresh { background: var(--green); }

        /* Two column grid for sections */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 18px;
        }

        .sections-grid .section-card.full-width {
            grid-column: 1 / -1;
        }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--slate); }

        .loading-spinner {
            display: inline-block; width: 24px; height: 24px;
            border: 3px solid #ede9e2; border-top-color: var(--cass-gold);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Refresh button */
        .refresh-btn {
            padding: 8px 16px; border-radius: 12px;
            background: var(--cass-moss); color: #f7f1e8;
            border: none; font-size: 13px; cursor: pointer;
            transition: background 0.2s;
        }
        .refresh-btn:hover { background: #35463b; }
        .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }

        @media (max-width: 1200px) {
            .sections-grid { grid-template-columns: 1fr; }
            .health-breakdown { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .app-shell { grid-template-columns: 1fr; }
            .side-nav { display: flex; gap: 12px; overflow-x: auto; padding: 16px; }
            .main-area { padding: 20px; }
            .health-hero { flex-direction: column; text-align: center; }
            .health-breakdown { grid-template-columns: repeat(2, 1fr); }
        }

        /* Issue Detail Slide-over */
        .detail-overlay {
            position: fixed; inset: 0; background: rgba(27, 27, 27, 0.35);
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .detail-overlay.open { opacity: 1; pointer-events: auto; }

        .detail-panel {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: min(520px, 90vw); background: var(--card);
            box-shadow: -8px 0 40px rgba(0,0,0,0.12);
            z-index: 1001; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .detail-panel.open { transform: translateX(0); }

        .detail-topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 22px; border-bottom: 1px solid var(--line);
            background: var(--pearl);
        }
        .detail-topbar h2 { font-family: "Space Grotesk", sans-serif; font-size: 16px; font-weight: 600; }
        .detail-close {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--line);
            background: var(--card); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center; color: var(--slate);
        }
        .detail-close:hover { background: var(--stone); color: var(--ink); }

        .detail-content {
            flex: 1; overflow-y: auto; padding: 22px;
            display: flex; flex-direction: column; gap: 20px;
        }

        .detail-sev-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 500;
        }
        .detail-sev-badge.critical { background: var(--red-bg); color: var(--red); }
        .detail-sev-badge.warning { background: var(--amber-bg); color: var(--amber); }
        .detail-sev-badge.info { background: rgba(31, 111, 107, 0.1); color: var(--cass-teal); }

        .detail-sev-dot {
            width: 8px; height: 8px; border-radius: 50%;
        }
        .detail-sev-dot.critical { background: var(--red); }
        .detail-sev-dot.warning { background: var(--cass-gold); }
        .detail-sev-dot.info { background: var(--cass-teal); }

        .detail-title { font-family: "Space Grotesk", sans-serif; font-size: 20px; font-weight: 600; line-height: 1.3; }

        .detail-section {
            border: 1px solid var(--line); border-radius: 14px; overflow: hidden;
        }
        .detail-section-header {
            padding: 10px 16px; background: var(--pearl);
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--slate);
        }
        .detail-section-body { padding: 14px 16px; font-size: 13px; line-height: 1.6; color: var(--ink-soft); }

        .detail-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .detail-meta-item { padding: 10px 14px; border-radius: 10px; background: var(--pearl); }
        .detail-meta-label { font-size: 11px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-meta-value { font-size: 14px; font-weight: 500; margin-top: 2px; }

        .detail-fix-step {
            display: flex; align-items: flex-start; gap: 10px; padding: 8px 0;
            border-bottom: 1px solid var(--line);
        }
        .detail-fix-step:last-child { border-bottom: none; }
        .detail-step-num {
            flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
            background: var(--cass-moss); color: #fff; font-size: 11px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
        }
        .detail-step-text { font-size: 13px; color: var(--ink-soft); line-height: 1.5; }

        .detail-file-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 8px; background: rgba(31, 111, 107, 0.08);
            color: var(--cass-teal); font-family: monospace; font-size: 12px;
            text-decoration: none; transition: background 0.15s;
        }
        .detail-file-link:hover { background: rgba(31, 111, 107, 0.15); }

        .detail-impact-bar {
            padding: 12px 16px; border-radius: 12px; background: var(--red-bg);
            color: var(--red); font-weight: 500; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="brand-bar">
            <div class="brand-mark">
                <span class="brand-dot"></span>
                <strong>Cass Brothers Intelligence</strong>
            </div>
            <input type="search" placeholder="Search reports, SKUs, or alerts..." />
            <div class="brand-actions">
                <span class="pill">Analytics</span>
                <span class="pill">Live</span>
            </div>
        </div>

        <aside class="side-nav">
            <h2>Dashboards</h2>
            <a class="nav-item" href="/dashboard"><span></span> Overview</a>
            <a class="nav-item" href="/performance"><span></span> Performance</a>
            <a class="nav-item" href="/seo-dashboard"><span></span> SEO &amp; Content</a>
            <a class="nav-item" href="/ads-intelligence"><span></span> Ads Intelligence</a>
            <a class="nav-item" href="/finance-dashboard"><span></span> Finance</a>
            <a class="nav-item" href="/inventory"><span></span> Inventory</a>
            <a class="nav-item" href="/pricing-intel"><span></span> Pricing Intel</a>
            <a class="nav-item" href="/customer-intelligence"><span></span> Customer Intel</a>
            <a class="nav-item" href="/merchant-center-intel"><span></span> Merchant Center</a>
            <a class="nav-item" href="/strategic-intelligence"><span></span> Intelligence Brief</a>
            <a class="nav-item active" href="/site-intelligence"><span></span> Site Intelligence</a>
            <div style="border-top:1px solid rgba(27,27,27,0.08);margin-top:16px;padding-top:12px">
                <a class="nav-item" href="#" onclick="fetch('/auth/logout',{method:'POST'}).then(()=>location.href='/auth/login');return false" style="opacity:0.6"><span></span> Logout</a>
            </div>
        </aside>

        <section class="main-area">
            <div class="overview">
                <div>
                    <h1>Site Intelligence</h1>
                    <p class="time-pill" id="last-refresh">Loading...</p>
                </div>
                <button class="refresh-btn" id="refresh-btn" onclick="loadAll()">Refresh</button>
            </div>

            <!-- Overall Health Score -->
            <div class="health-hero" id="health-hero">
                <div class="score-ring">
                    <svg viewBox="0 0 36 36">
                        <circle class="bg" cx="18" cy="18" r="15.9"/>
                        <circle class="fg" id="score-arc" cx="18" cy="18" r="15.9"
                            stroke-dasharray="100 100" stroke-dashoffset="100"/>
                    </svg>
                    <div class="score-number" id="score-number">--</div>
                </div>
                <div class="health-breakdown">
                    <div class="health-item">
                        <div class="hi-label">Data Quality</div>
                        <div class="hi-value" id="dq-score">--</div>
                        <div class="hi-status" id="dq-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Site Perf</div>
                        <div class="hi-value" id="sp-score">--</div>
                        <div class="hi-status" id="sp-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Code Health</div>
                        <div class="hi-value" id="ch-score">--</div>
                        <div class="hi-status" id="ch-status">...</div>
                    </div>
                    <div class="health-item">
                        <div class="hi-label">Redirects</div>
                        <div class="hi-value" id="rh-score">--</div>
                        <div class="hi-status" id="rh-status">...</div>
                    </div>
                </div>
            </div>

            <!-- KPI Impact Roll-up -->
            <div class="kpi-strip" id="kpi-strip" style="display:none">
                <div class="kpi-item kpi-revenue">
                    <div class="kpi-label">Revenue at Risk</div>
                    <div class="kpi-value" id="kpi-revenue">$0</div>
                </div>
                <div class="kpi-item kpi-issues">
                    <div class="kpi-label">Total Issues</div>
                    <div class="kpi-value" id="kpi-total-issues">0</div>
                </div>
                <div class="kpi-item kpi-new">
                    <div class="kpi-label">New Since Last Visit</div>
                    <div class="kpi-value" id="kpi-new-issues">--</div>
                </div>
            </div>

            <!-- Top 3 Priorities -->
            <div class="priorities-panel" id="priorities-panel" style="display:none">
                <h3>Top Priorities</h3>
                <div id="priorities-list"></div>
            </div>

            <!-- Critical Issues -->
            <div class="critical-banner" id="critical-banner">
                <h3 id="critical-title">Critical Issues</h3>
                <div id="critical-list"></div>
            </div>

            <!-- Data Freshness -->
            <div class="freshness-panel" id="freshness-panel" style="display:none">
                <h3>Data Freshness</h3>
                <div class="freshness-grid" id="freshness-grid"></div>
            </div>

            <!-- Section Cards -->
            <div class="sections-grid">

                <!-- Data Quality -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('dq')">
                        <h3>Data Quality <span class="section-badge status-good" id="dq-badge">--</span></h3>
                        <div class="section-score"><strong id="dq-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="dq-body">
                        <div class="issue-list" id="dq-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading data quality...</div>
                        </div>
                    </div>
                </div>

                <!-- Site Performance -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('sp')">
                        <h3>Site Performance <span class="section-badge status-good" id="sp-badge">--</span></h3>
                        <div class="section-score"><strong id="sp-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="sp-body">
                        <div class="issue-list" id="sp-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading site performance...</div>
                        </div>
                    </div>
                </div>

                <!-- Code Health -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('ch')">
                        <h3>Code Health <span class="section-badge status-good" id="ch-badge">--</span></h3>
                        <div class="section-score"><strong id="ch-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="ch-body">
                        <div class="issue-list" id="ch-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading code health...</div>
                        </div>
                    </div>
                </div>

                <!-- Redirects & 404s -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('rh')">
                        <h3>Redirects &amp; 404s <span class="section-badge status-good" id="rh-badge">--</span></h3>
                        <div class="section-score"><strong id="rh-issues">0</strong> issues <span class="chevron">&#9660;</span></div>
                    </div>
                    <div class="section-body" id="rh-body">
                        <div class="issue-list" id="rh-list">
                            <div class="loading"><div class="loading-spinner"></div><br>Loading redirect health...</div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Issue Detail Slide-over Panel -->
    <div class="detail-overlay" id="detail-overlay" onclick="closeIssueDetail()"></div>
    <div class="detail-panel" id="detail-panel">
        <div class="detail-topbar">
            <h2 id="detail-source">Issue Detail</h2>
            <button class="detail-close" onclick="closeIssueDetail()">&times;</button>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>

    <script>
        function toggleSection(id) {
            const body = document.getElementById(id + '-body');
            const header = body.previousElementSibling;
            body.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        }

        function setScore(elementId, score) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = score !== null && score !== undefined ? Math.round(score) : '--';
        }

        function setStatus(elementId, score) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (score === null || score === undefined) { el.textContent = '...'; el.className = 'hi-status'; return; }
            if (score >= 80) { el.textContent = 'Good'; el.className = 'hi-status status-good'; }
            else if (score >= 50) { el.textContent = 'Warning'; el.className = 'hi-status status-warning'; }
            else { el.textContent = 'Critical'; el.className = 'hi-status status-critical'; }
        }

        function setBadge(elementId, score) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (score === null || score === undefined) { el.textContent = '--'; el.className = 'section-badge'; return; }
            const s = Math.round(score);
            if (s >= 80) { el.textContent = s + '/100'; el.className = 'section-badge status-good'; }
            else if (s >= 50) { el.textContent = s + '/100'; el.className = 'section-badge status-warning'; }
            else { el.textContent = s + '/100'; el.className = 'section-badge status-critical'; }
        }

        function setScoreRing(score) {
            const arc = document.getElementById('score-arc');
            const num = document.getElementById('score-number');
            if (!arc) return;
            const s = Math.max(0, Math.min(100, Math.round(score || 0)));
            const offset = 100 - s;
            arc.style.strokeDashoffset = offset;
            num.textContent = s;
            if (s >= 80) arc.style.stroke = 'var(--green)';
            else if (s >= 50) arc.style.stroke = 'var(--cass-gold)';
            else arc.style.stroke = 'var(--red)';
        }

        // Store all issues by section for detail panel access
        const issueStore = {};

        function renderIssues(listId, issues, emptyMsg, source) {
            const el = document.getElementById(listId);
            if (!el) return;
            if (!issues || issues.length === 0) {
                el.innerHTML = '<div class="empty-state">' + (emptyMsg || 'No issues found') + '</div>';
                return;
            }
            // Store issues for detail panel
            issueStore[listId] = { issues: issues, source: source || 'Issue' };

            el.innerHTML = issues.slice(0, 10).map((issue, idx) => {
                const sev = issue.severity || 'info';
                let linkHtml = '';
                if (issue.file_path) {
                    const fp = issue.file_path;
                    if (issue.github_url) {
                        linkHtml = '<div class="issue-link"><a href="' + esc(issue.github_url) + '" target="_blank" onclick="event.stopPropagation()">' + esc(fp) + (issue.line_number ? ':' + issue.line_number : '') + '</a></div>';
                    } else if (fp.endsWith('.liquid') || fp.endsWith('.js') || fp.endsWith('.json') || fp.endsWith('.css')) {
                        linkHtml = '<div class="issue-file">' + esc(fp) + (issue.line_number ? ':' + issue.line_number : '') + '</div>';
                    } else {
                        linkHtml = '<div class="issue-file">' + esc(fp) + '</div>';
                    }
                }
                let impactHtml = '';
                if (issue.revenue_impact) impactHtml = '<div class="issue-detail" style="color:var(--red);font-weight:500">~$' + Math.round(issue.revenue_impact) + '/mo impact</div>';
                return '<div class="issue-row" style="cursor:pointer" onclick="openIssueDetail(\'' + listId + '\',' + idx + ')">' +
                    '<div class="issue-severity sev-' + sev + '"></div>' +
                    '<div class="issue-body">' +
                        '<div class="issue-title">' + esc(issue.title || issue.check_name || 'Issue') + '</div>' +
                        (issue.description ? '<div class="issue-detail">' + esc(issue.description) + '</div>' : '') +
                        impactHtml +
                        linkHtml +
                        (issue.recommendation || issue.fix ? '<div class="issue-fix">' + esc(issue.recommendation || issue.fix) + '</div>' : '') +
                    '</div>' +
                    '<span class="chevron" style="color:var(--slate);font-size:11px;align-self:center;flex-shrink:0">&#9654;</span>' +
                '</div>';
            }).join('');
        }

        function esc(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // --- Issue Detail Panel ---

        function openIssueDetail(listId, idx) {
            const store = issueStore[listId];
            if (!store || !store.issues[idx]) return;
            const issue = store.issues[idx];
            const source = store.source;

            document.getElementById('detail-overlay').classList.add('open');
            document.getElementById('detail-panel').classList.add('open');
            document.getElementById('detail-source').textContent = source;
            document.body.style.overflow = 'hidden';

            const content = document.getElementById('detail-content');
            content.innerHTML = buildDetailHTML(issue, source);
        }

        function closeIssueDetail() {
            document.getElementById('detail-overlay').classList.remove('open');
            document.getElementById('detail-panel').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Close on Escape key
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeIssueDetail(); });

        function buildDetailHTML(issue, source) {
            const sev = issue.severity || 'info';
            const sevLabel = { critical: 'Critical', warning: 'Warning', info: 'Info' }[sev] || sev;
            let html = '';

            // Severity badge + title
            html += '<div><span class="detail-sev-badge ' + sev + '">' +
                '<span class="detail-sev-dot ' + sev + '"></span>' + sevLabel +
                '</span></div>';
            html += '<div class="detail-title">' + esc(issue.title || issue.check_name || 'Issue') + '</div>';

            // Revenue impact bar
            if (issue.revenue_impact) {
                html += '<div class="detail-impact-bar">~$' + Math.round(issue.revenue_impact).toLocaleString() + '/mo estimated revenue at risk</div>';
            }

            // Meta grid
            html += '<div class="detail-meta-grid">';
            html += '<div class="detail-meta-item"><div class="detail-meta-label">Source</div><div class="detail-meta-value">' + esc(source) + '</div></div>';
            html += '<div class="detail-meta-item"><div class="detail-meta-label">Severity</div><div class="detail-meta-value">' + esc(sevLabel) + '</div></div>';
            if (issue.category) {
                html += '<div class="detail-meta-item"><div class="detail-meta-label">Category</div><div class="detail-meta-value">' + esc(issue.category) + '</div></div>';
            }
            if (issue.file_path) {
                html += '<div class="detail-meta-item"><div class="detail-meta-label">Location</div><div class="detail-meta-value" style="font-family:monospace;font-size:12px">' + esc(issue.file_path) + (issue.line_number ? ':' + issue.line_number : '') + '</div></div>';
            }
            html += '</div>';

            // Evidence section
            const evidence = buildEvidence(issue, source);
            if (evidence) {
                html += '<div class="detail-section">' +
                    '<div class="detail-section-header">Evidence</div>' +
                    '<div class="detail-section-body">' + evidence + '</div>' +
                '</div>';
            }

            // Root cause section
            const rootCause = buildRootCause(issue, source);
            html += '<div class="detail-section">' +
                '<div class="detail-section-header">Root Cause</div>' +
                '<div class="detail-section-body">' + rootCause + '</div>' +
            '</div>';

            // Recommended fix section
            const fixSteps = buildFixSteps(issue, source);
            html += '<div class="detail-section">' +
                '<div class="detail-section-header">Recommended Fix</div>' +
                '<div class="detail-section-body">' + fixSteps + '</div>' +
            '</div>';

            // File link (if GitHub URL available)
            if (issue.github_url) {
                html += '<a class="detail-file-link" href="' + esc(issue.github_url) + '" target="_blank">View in GitHub &rarr;</a>';
            } else if (issue.file_path && (issue.file_path.endsWith('.liquid') || issue.file_path.endsWith('.js') || issue.file_path.endsWith('.css') || issue.file_path.endsWith('.json'))) {
                html += '<span class="detail-file-link">' + esc(issue.file_path) + (issue.line_number ? ':' + issue.line_number : '') + '</span>';
            }

            return html;
        }

        function buildEvidence(issue, source) {
            const parts = [];
            if (issue.description) parts.push('<p>' + esc(issue.description) + '</p>');

            // Source-specific evidence
            if (source === 'Redirects & 404s') {
                if (issue.title && issue.title.startsWith('404:')) {
                    parts.push('<p>This URL is being requested by users or bots but returns a 404 error. Each hit represents a lost visitor and potential lost revenue.</p>');
                }
                if (issue.revenue_impact) {
                    parts.push('<p>Based on average conversion rate and order value, this 404 pattern costs approximately <strong>$' + Math.round(issue.revenue_impact) + '/month</strong> in lost sales.</p>');
                }
            } else if (source === 'Code Health') {
                if (issue.category === 'liquid') {
                    parts.push('<p>Found in Shopify Liquid template. This affects how the storefront renders for customers.</p>');
                } else if (issue.category === 'javascript') {
                    parts.push('<p>Found in JavaScript bundle. This can affect page interactivity and performance.</p>');
                } else if (issue.category === 'security') {
                    parts.push('<p>Security issues can expose the store to XSS attacks or data leaks.</p>');
                }
                if (issue.line_number) {
                    parts.push('<p>Issue detected at <strong>line ' + issue.line_number + '</strong> in the file.</p>');
                }
            } else if (source === 'Site Performance') {
                if (issue.title && issue.title.includes('LCP')) {
                    parts.push('<p>LCP (Largest Contentful Paint) measures when the main content is visible. Google uses this as a Core Web Vital ranking factor.</p>');
                } else if (issue.title && issue.title.includes('CLS')) {
                    parts.push('<p>CLS (Cumulative Layout Shift) measures visual stability. High CLS causes elements to jump around during loading, frustrating users.</p>');
                } else if (issue.title && issue.title.includes('INP')) {
                    parts.push('<p>INP (Interaction to Next Paint) measures responsiveness. Slow INP means clicks/taps feel laggy to users.</p>');
                }
            } else if (source === 'Data Quality') {
                if (issue.title && issue.title.includes('stale')) {
                    parts.push('<p>Stale data means decisions are being made on outdated information. This can lead to missed opportunities or incorrect analysis.</p>');
                }
            }

            return parts.length > 0 ? parts.join('') : '<p>This issue was detected during the latest automated scan.</p>';
        }

        function buildRootCause(issue, source) {
            // Generate contextual root cause based on issue type
            if (source === 'Redirects & 404s') {
                if (issue.title && issue.title.startsWith('404:')) {
                    return '<p>A page that was previously accessible is now returning a 404. This is commonly caused by:</p>' +
                        '<ul style="margin:8px 0 0 18px"><li>Product or collection deleted from Shopify</li>' +
                        '<li>URL handle changed without a redirect</li>' +
                        '<li>Incoming links from external sites pointing to an old URL</li>' +
                        '<li>Sitemap still listing removed pages</li></ul>';
                }
                if (issue.title && issue.title.includes('redirect chain')) {
                    return '<p>Redirect chains occur when one redirect points to another redirect, creating a multi-hop path. This slows page loads and wastes search engine crawl budget.</p>';
                }
                if (issue.title && issue.title.includes('broken redirect')) {
                    return '<p>A redirect rule exists but its destination page no longer exists, creating a redirect that leads to a 404. This is worse than a simple 404 because it gives a false promise of resolution.</p>';
                }
                return '<p>Redirect and 404 issues typically arise from URL changes, deleted content, or misconfigured routing rules.</p>';
            }
            if (source === 'Code Health') {
                if (issue.title && issue.title.includes('include')) {
                    return '<p>The <code>{% include %}</code> tag is deprecated in Shopify themes. It shares the parent scope and is slower than <code>{% render %}</code> which creates an isolated scope and enables better caching.</p>';
                }
                if (issue.title && issue.title.includes('console.log')) {
                    return '<p>Debug logging statements left in production code. While not harmful, they clutter the browser console and may expose internal logic to users.</p>';
                }
                if (issue.title && issue.title.includes('alt text') || (issue.title && issue.title.includes('accessibility'))) {
                    return '<p>Images without alt text are inaccessible to screen readers and miss SEO opportunities. Search engines use alt text to understand image content.</p>';
                }
                if (issue.category === 'security') {
                    return '<p>Security vulnerabilities in theme code can allow attackers to inject malicious scripts (XSS), steal customer data, or manipulate the storefront.</p>';
                }
                return '<p>Code health issues arise from deprecated patterns, missing best practices, or technical debt accumulated over theme development.</p>';
            }
            if (source === 'Site Performance') {
                if (issue.title && issue.title.includes('LCP')) {
                    return '<p>Poor LCP is typically caused by large unoptimized images, slow server response, render-blocking CSS/JS, or client-side rendering of the main content.</p>';
                }
                if (issue.title && issue.title.includes('CLS')) {
                    return '<p>Layout shifts happen when elements load without reserved space - typically images without dimensions, ads/banners injected dynamically, or web fonts causing text reflow.</p>';
                }
                if (issue.title && issue.title.includes('INP')) {
                    return '<p>Slow interactions are caused by heavy JavaScript execution on the main thread, typically from third-party scripts, complex event handlers, or large DOM updates.</p>';
                }
                return '<p>Performance issues can stem from unoptimized assets, excessive scripts, slow server responses, or poor caching configuration.</p>';
            }
            if (source === 'Data Quality') {
                if (issue.title && issue.title.includes('stale')) {
                    return '<p>Data sync has not completed recently. This could be due to expired API credentials, rate limiting, a paused scheduler, or a connectivity issue with the data source.</p>';
                }
                if (issue.title && issue.title.includes('critical')) {
                    return '<p>This data quality check is in a critical state, meaning the data source may be misconfigured, disconnected, or returning errors.</p>';
                }
                return '<p>Data quality issues indicate a gap between expected and actual data freshness or completeness.</p>';
            }
            return '<p>This issue was identified during automated analysis. Review the evidence above for specific context.</p>';
        }

        function buildFixSteps(issue, source) {
            const steps = [];
            const rec = issue.recommendation || issue.fix || '';

            // Source-specific fix steps
            if (source === 'Redirects & 404s' && issue.title && issue.title.startsWith('404:')) {
                const url = issue.title.replace('404: ', '');
                steps.push('Identify what page this URL originally pointed to (product, collection, or blog post)');
                steps.push('In Shopify Admin, go to Online Store &rarr; Navigation &rarr; URL Redirects');
                steps.push('Create a redirect from <code>' + esc(url) + '</code> to the most relevant live page');
                steps.push('If the content is permanently removed, redirect to the parent collection or homepage');
                if (rec) steps.push(esc(rec));
            } else if (source === 'Code Health' && issue.title && issue.title.includes('include')) {
                steps.push('Open the file <code>' + esc(issue.file_path || '') + '</code> in your theme editor');
                steps.push('Replace <code>{% include \'snippet\' %}</code> with <code>{% render \'snippet\' %}</code>');
                steps.push('Pass any needed variables explicitly: <code>{% render \'snippet\', product: product %}</code>');
                steps.push('Test the page to ensure the rendered output is unchanged');
            } else if (source === 'Site Performance' && issue.title && issue.title.includes('LCP')) {
                steps.push('Identify the largest element on the page (usually a hero image or heading)');
                steps.push('Optimize the hero image: convert to WebP, set appropriate dimensions, use srcset');
                steps.push('Add <code>fetchpriority="high"</code> to the LCP image element');
                steps.push('Remove render-blocking scripts and defer non-critical CSS');
            } else if (source === 'Data Quality' && issue.title && issue.title.includes('stale')) {
                steps.push('Check the scheduler is running: visit the monitoring dashboard');
                steps.push('Verify API credentials are still valid for this data source');
                steps.push('Try a manual sync via the API: <code>POST /sync/all</code>');
                steps.push('Check server logs for error messages from the connector');
            } else if (rec) {
                // Fallback: split recommendation into steps if it has multiple sentences
                const sentences = rec.split(/\.\s+/).filter(s => s.trim());
                if (sentences.length > 1) {
                    sentences.forEach(s => steps.push(esc(s.trim().replace(/\.$/, ''))));
                } else {
                    steps.push(esc(rec));
                }
            }

            if (steps.length === 0) {
                steps.push('Review the issue details and evidence above');
                steps.push('Apply the appropriate fix based on the root cause');
                steps.push('Verify the fix by refreshing this dashboard');
            }

            return steps.map((step, idx) =>
                '<div class="detail-fix-step">' +
                    '<span class="detail-step-num">' + (idx + 1) + '</span>' +
                    '<span class="detail-step-text">' + step + '</span>' +
                '</div>'
            ).join('');
        }

        // Collect critical issues from all sections
        let allCriticalIssues = [];

        function showCriticalBanner() {
            const banner = document.getElementById('critical-banner');
            const list = document.getElementById('critical-list');
            const title = document.getElementById('critical-title');
            if (allCriticalIssues.length === 0) { banner.classList.remove('visible'); return; }
            title.textContent = allCriticalIssues.length + ' Critical Issue' + (allCriticalIssues.length > 1 ? 's' : '');
            list.innerHTML = allCriticalIssues.slice(0, 5).map(i =>
                '<div class="critical-item"><strong>' + esc(i.source) + ':</strong> ' + esc(i.title) + '</div>'
            ).join('');
            banner.classList.add('visible');
        }

        // --- Data Loaders ---

        async function loadDataQuality() {
            try {
                const res = await fetch('/data-quality/dashboard');
                const data = await res.json();
                const d = data.data || data;

                const score = d.quality_score ?? d.overall_score ?? 75;
                setScore('dq-score', score);
                setStatus('dq-status', score);
                setBadge('dq-badge', score);

                const issues = [];

                // Build issues from health checks
                const healthChecks = [
                    { key: 'sync_health', label: 'Data Sync' },
                    { key: 'tracking_health', label: 'Conversion Tracking' },
                    { key: 'utm_health', label: 'UTM Tracking' },
                    { key: 'feed_health', label: 'Merchant Center Feed' },
                    { key: 'link_health', label: 'Google Ads Link' }
                ];
                healthChecks.forEach(check => {
                    const h = d[check.key];
                    if (h && h.status === 'critical') {
                        issues.push({ severity: 'critical', title: check.label + ' is critical', description: h.message || h.detail || '', recommendation: 'Check ' + check.label.toLowerCase() + ' configuration' });
                        allCriticalIssues.push({ source: 'Data Quality', title: check.label + ' is critical' });
                    } else if (h && h.status === 'warning') {
                        issues.push({ severity: 'warning', title: check.label + ' needs attention', description: h.message || h.detail || '', recommendation: 'Review ' + check.label.toLowerCase() });
                    }
                });

                // Freshness  API returns { sources: { table_name: { stale, lag_hours, ... } } }
                const freshness = d.freshness || {};
                const freshSources = freshness.sources || freshness;
                if (typeof freshSources === 'object' && !Array.isArray(freshSources)) {
                    Object.entries(freshSources).forEach(([source, info]) => {
                        if (info && typeof info === 'object' && (info.stale || info.is_stale || info.status === 'stale')) {
                            const lagH = info.lag_hours || info.hours_since_update;
                            const sev = lagH > 48 ? 'critical' : 'warning';
                            issues.push({ severity: sev, title: source + ' data is stale', description: 'Last update: ' + (lagH ? Math.round(lagH) + 'h ago' : 'unknown'), recommendation: 'Check sync for ' + source });
                            if (sev === 'critical') allCriticalIssues.push({ source: 'Data Quality', title: source + ' data is stale (' + Math.round(lagH) + 'h)' });
                        }
                    });
                }

                // Overall summary message as fallback
                if (issues.length === 0 && d.summary && d.summary.status === 'critical') {
                    issues.push({ severity: 'critical', title: d.summary.message || 'Data quality is critical', description: d.issues_found + ' issues found', recommendation: 'Review data quality dashboard for details' });
                    allCriticalIssues.push({ source: 'Data Quality', title: d.summary.message || 'Score: ' + score + '/100' });
                }

                document.getElementById('dq-issues').textContent = issues.length || d.issues_found || 0;
                renderIssues('dq-list', issues, 'All data sources are fresh and healthy', 'Data Quality');

                // Render freshness panel
                renderFreshness(d.freshness);

                return score;
            } catch (e) {
                document.getElementById('dq-list').innerHTML = '<div class="empty-state">Could not load data quality</div>';
                return null;
            }
        }

        async function loadSitePerformance() {
            try {
                const res = await fetch('/site-health/summary');
                const data = await res.json();
                const d = data.data || data;

                const issues = [];

                // Core Web Vitals  API returns uppercase keys: LCP, CLS, INP, TTFB
                const cwv = d.core_web_vitals || {};
                let score = 85;

                // LCP (value in ms or seconds)
                const lcpRaw = cwv.LCP || cwv.lcp;
                if (lcpRaw !== null && lcpRaw !== undefined) {
                    const lcpVal = typeof lcpRaw === 'object' ? (lcpRaw.p75 || lcpRaw.value) : lcpRaw;
                    if (lcpVal) {
                        const lcpMs = lcpVal > 100 ? lcpVal : lcpVal * 1000; // handle s vs ms
                        if (lcpMs > 4000) { issues.push({ severity: 'critical', title: 'LCP is poor: ' + (lcpMs / 1000).toFixed(1) + 's', description: 'Largest Contentful Paint should be under 2.5s', recommendation: 'Optimize images, reduce server response time' }); allCriticalIssues.push({ source: 'Performance', title: 'LCP is ' + (lcpMs / 1000).toFixed(1) + 's (poor)' }); score -= 25; }
                        else if (lcpMs > 2500) { issues.push({ severity: 'warning', title: 'LCP needs improvement: ' + (lcpMs / 1000).toFixed(1) + 's', description: 'Target under 2.5s for good experience', recommendation: 'Optimize largest image/text block' }); score -= 10; }
                    }
                }

                // CLS
                const clsRaw = cwv.CLS || cwv.cls;
                if (clsRaw !== null && clsRaw !== undefined) {
                    const clsVal = typeof clsRaw === 'object' ? (clsRaw.p75 || clsRaw.value) : clsRaw;
                    if (clsVal) {
                        if (clsVal > 0.25) { issues.push({ severity: 'critical', title: 'CLS is poor: ' + clsVal.toFixed(3), description: 'Cumulative Layout Shift should be under 0.1', recommendation: 'Set dimensions on images/ads, avoid dynamic content injection' }); score -= 20; }
                        else if (clsVal > 0.1) { issues.push({ severity: 'warning', title: 'CLS needs improvement: ' + clsVal.toFixed(3), description: 'Target under 0.1', recommendation: 'Reserve space for dynamic content' }); score -= 8; }
                    }
                }

                // INP
                const inpRaw = cwv.INP || cwv.inp;
                if (inpRaw !== null && inpRaw !== undefined) {
                    const inpVal = typeof inpRaw === 'object' ? (inpRaw.p75 || inpRaw.value) : inpRaw;
                    if (inpVal) {
                        if (inpVal > 500) { issues.push({ severity: 'critical', title: 'INP is poor: ' + inpVal + 'ms', description: 'Interaction to Next Paint should be under 200ms', recommendation: 'Reduce JavaScript execution time, optimize event handlers' }); score -= 20; }
                        else if (inpVal > 200) { issues.push({ severity: 'warning', title: 'INP needs improvement: ' + inpVal + 'ms', description: 'Target under 200ms', recommendation: 'Optimize interaction responsiveness' }); score -= 8; }
                    }
                }

                // Error pages
                const errorPages = d.error_pages || [];
                if (Array.isArray(errorPages)) {
                    errorPages.slice(0, 3).forEach(err => {
                        const count = err.error_count || err.count || err.occurrences || '';
                        issues.push({ severity: 'warning', title: (err.status_code ? err.status_code + ' error' : 'Error') + (err.page_path ? ' on ' + err.page_path : ''), description: count + ' occurrences', file_path: err.page_path || err.url, recommendation: 'Investigate and fix error page' });
                    });
                }

                // Error types
                const errorTypes = d.error_types || [];
                if (Array.isArray(errorTypes)) {
                    errorTypes.slice(0, 3).forEach(err => {
                        issues.push({ severity: 'warning', title: err.error_type || err.type || 'Error', description: (err.count || '') + ' occurrences', recommendation: 'Fix this error type' });
                    });
                }

                // Slow pages
                const slow = d.slowest_pages || [];
                if (Array.isArray(slow)) {
                    slow.slice(0, 2).forEach(p => {
                        const lcp = p.lcp_p75 || p.avg_lcp || p.lcp;
                        issues.push({ severity: 'info', title: 'Slow page' + (lcp ? ': ' + (lcp > 100 ? (lcp / 1000).toFixed(1) : lcp.toFixed(1)) + 's LCP' : ''), file_path: p.page_path || p.url || p.path, recommendation: 'Optimize page load' });
                    });
                }

                // If no CWV data at all, show neutral "No Data" state
                const noData = !lcpRaw && !clsRaw && !inpRaw && errorPages.length === 0 && slow.length === 0;
                if (noData) {
                    issues.push({ severity: 'info', title: 'No performance data available', description: 'GA4 performance events may not be configured', recommendation: 'Ensure GA4 is tracking Core Web Vitals' });
                    score = null;
                }

                if (score !== null) score = Math.max(0, Math.min(100, score));
                setScore('sp-score', noData ? '--' : score);
                if (noData) {
                    const statusEl = document.getElementById('sp-status');
                    if (statusEl) { statusEl.textContent = 'No Data'; statusEl.className = 'hi-status status-nodata'; }
                    const badgeEl = document.getElementById('sp-badge');
                    if (badgeEl) { badgeEl.textContent = 'No Data'; badgeEl.className = 'section-badge status-nodata'; }
                } else {
                    setStatus('sp-status', score);
                    setBadge('sp-badge', score);
                }
                document.getElementById('sp-issues').textContent = issues.length;
                renderIssues('sp-list', issues, 'Site performance looks healthy', 'Site Performance');
                return score;
            } catch (e) {
                document.getElementById('sp-list').innerHTML = '<div class="empty-state">Could not load site performance</div>';
                return null;
            }
        }

        async function loadCodeHealth() {
            try {
                const res = await fetch('/code/issues');
                const data = await res.json();
                const d = data.data || data;

                const issues = d.issues || [];
                const summary = d.summary || {};
                const total = d.total_count || issues.length;
                const critical = summary.critical || 0;
                const warning = summary.warning || 0;

                let score = 100 - (critical * 10) - (warning * 3);
                score = Math.max(0, Math.min(100, score));

                // Add critical code issues to global list
                issues.filter(i => i.severity === 'critical').forEach(i => {
                    allCriticalIssues.push({ source: 'Code Health', title: i.title || i.check_name });
                });

                setScore('ch-score', score);
                setStatus('ch-status', score);
                setBadge('ch-badge', score);
                document.getElementById('ch-issues').textContent = total;
                renderIssues('ch-list', issues, 'No code issues found. Theme looks clean!', 'Code Health');
                return score;
            } catch (e) {
                document.getElementById('ch-list').innerHTML = '<div class="empty-state">Could not load code health. Is GitHub connected?</div>';
                return null;
            }
        }

        async function loadRedirectHealth() {
            try {
                const res = await fetch('/redirects/dashboard');
                const data = await res.json();
                const d = data.data || data;

                const issues = [];
                let score = 90;
                const overview = d.overview || {};

                // 404 errors from 404_summary.top_errors
                const summary404 = d['404_summary'] || {};
                const errors404 = summary404.top_errors || d.top_404s || [];
                if (Array.isArray(errors404)) {
                    errors404.slice(0, 4).forEach(e => {
                        const traffic = e.traffic || {};
                        const hits = traffic.total_hits || e.total_hits || e.hit_count || 0;
                        const revenue = (e.revenue_impact || {}).estimated_monthly_revenue_loss || e.estimated_lost_revenue || 0;
                        const sev = hits > 100 ? 'critical' : hits > 20 ? 'warning' : 'info';
                        issues.push({ severity: sev, title: '404: ' + (e.requested_url || e.url_path || e.url), description: hits + ' hits' + (revenue ? ' / ~$' + Math.round(revenue) + '/mo lost' : ''), revenue_impact: revenue, recommendation: (e.recommended_redirect || {}).action || e.recommended_action || 'Create redirect or restore page' });
                        totalRevenueAtRisk += revenue;
                        if (sev === 'critical') { allCriticalIssues.push({ source: 'Redirects', title: '404 with ' + hits + ' hits: ' + (e.requested_url || e.url), revenue: revenue }); score -= 15; }
                        else if (sev === 'warning') score -= 5;
                    });
                }

                // Redirect issues from redirect_issues_summary
                const redirectSummary = d.redirect_issues_summary || {};
                if (redirectSummary.redirect_chains > 0) {
                    issues.push({ severity: 'warning', title: redirectSummary.redirect_chains + ' redirect chain(s) detected', description: 'Multiple hops slow down page loads and waste crawl budget', recommendation: 'Simplify to single direct redirects' });
                    score -= 5 * redirectSummary.redirect_chains;
                }
                if (redirectSummary.broken_redirects > 0) {
                    issues.push({ severity: 'critical', title: redirectSummary.broken_redirects + ' broken redirect(s)', description: 'Redirects pointing to non-existent pages', recommendation: 'Fix redirect destinations' });
                    allCriticalIssues.push({ source: 'Redirects', title: redirectSummary.broken_redirects + ' broken redirects' });
                    score -= 15;
                }

                // Broken links from broken_links_summary.top_links
                const brokenSummary = d.broken_links_summary || {};
                const brokenLinks = brokenSummary.top_links || d.broken_links || [];
                if (Array.isArray(brokenLinks)) {
                    brokenLinks.slice(0, 3).forEach(b => {
                        issues.push({ severity: b.priority === 'high' ? 'warning' : 'info', title: 'Broken link on ' + (b.source_page || 'page'), description: 'Links to: ' + (b.broken_link || b.broken_url || b.url), recommendation: b.recommended_fix || 'Fix or remove broken link' });
                    });
                }

                // Top priorities as additional context
                const priorities = d.top_priorities || [];
                if (Array.isArray(priorities) && issues.length === 0) {
                    priorities.slice(0, 3).forEach(p => {
                        issues.push({ severity: p.priority === 'high' ? 'warning' : 'info', title: p.title, description: p.description, recommendation: p.action || '' });
                    });
                }

                // Revenue impact
                const totalRevenueLoss = overview.total_revenue_loss || 0;
                if (totalRevenueLoss > 500) {
                    score -= 10;
                }

                score = Math.max(0, Math.min(100, score));
                setScore('rh-score', score);
                setStatus('rh-status', score);
                setBadge('rh-badge', score);
                document.getElementById('rh-issues').textContent = issues.length;
                renderIssues('rh-list', issues, 'No redirect issues found', 'Redirects & 404s');
                return score;
            } catch (e) {
                document.getElementById('rh-list').innerHTML = '<div class="empty-state">Could not load redirect health</div>';
                return null;
            }
        }

        // Track revenue at risk from redirects
        let totalRevenueAtRisk = 0;

        function renderFreshness(freshness) {
            const panel = document.getElementById('freshness-panel');
            const grid = document.getElementById('freshness-grid');
            if (!freshness || !freshness.sources) { panel.style.display = 'none'; return; }
            panel.style.display = '';

            const sourceNames = {
                'shopify_orders': 'Shopify Orders',
                'shopify_order_items': 'Order Items',
                'ga4_daily_summary': 'GA4 Analytics',
                'ga4_traffic_sources': 'GA4 Traffic',
                'search_console_queries': 'GSC Queries',
                'search_console_pages': 'GSC Pages',
                'google_ads_campaigns': 'Google Ads',
                'merchant_center_statuses': 'Merchant Center'
            };

            const entries = Object.entries(freshness.sources);
            grid.innerHTML = entries.map(([key, s]) => {
                const name = sourceNames[key] || key.replace(/_/g, ' ');
                const isStale = s.stale || s.status === 'stale';
                const lagH = Math.round(s.lag_hours || 0);
                const rows = s.rows || 0;
                const age = lagH < 1 ? 'Just now' : lagH < 24 ? lagH + 'h ago' : Math.round(lagH / 24) + 'd ago';
                return '<div class="freshness-item ' + (isStale ? 'stale' : 'fresh') + '">' +
                    '<div class="freshness-source"><span class="freshness-dot ' + (isStale ? 'stale' : 'fresh') + '"></span>' + esc(name) + '</div>' +
                    '<div class="freshness-age">' + age + '</div>' +
                    '<div class="freshness-rows">' + rows.toLocaleString() + ' rows</div>' +
                '</div>';
            }).join('');
        }

        function renderPriorities() {
            const panel = document.getElementById('priorities-panel');
            const list = document.getElementById('priorities-list');

            // Build priority list from all critical issues + high revenue items
            const items = allCriticalIssues
                .map(i => ({ ...i, weight: (i.revenue || 0) + (i.source === 'Code Health' ? 5 : 10) }))
                .sort((a, b) => b.weight - a.weight)
                .slice(0, 3);

            if (items.length === 0) { panel.style.display = 'none'; return; }
            panel.style.display = '';

            list.innerHTML = items.map((item, idx) => {
                return '<div class="priority-item">' +
                    '<div class="priority-num">' + (idx + 1) + '</div>' +
                    '<div class="priority-body">' +
                        '<div class="priority-title">' + esc(item.title) + '</div>' +
                        (item.revenue ? '<div class="priority-impact">~$' + Math.round(item.revenue) + '/mo at risk</div>' : '') +
                        '<div class="priority-action">' + esc(item.source) + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderKPIs(totalIssues) {
            const strip = document.getElementById('kpi-strip');
            strip.style.display = '';

            document.getElementById('kpi-revenue').textContent = totalRevenueAtRisk > 0 ? '$' + Math.round(totalRevenueAtRisk).toLocaleString() + '/mo' : '$0';
            document.getElementById('kpi-total-issues').textContent = totalIssues;

            // Change tracking via localStorage
            const storageKey = 'site_intel_snapshot';
            const prev = JSON.parse(localStorage.getItem(storageKey) || 'null');
            const newEl = document.getElementById('kpi-new-issues');

            if (prev && prev.totalIssues !== undefined) {
                const diff = totalIssues - prev.totalIssues;
                if (diff > 0) { newEl.textContent = '+' + diff; newEl.style.color = 'var(--red)'; }
                else if (diff < 0) { newEl.textContent = diff; newEl.style.color = 'var(--green)'; }
                else { newEl.textContent = 'None'; newEl.style.color = 'var(--green)'; }
            } else {
                newEl.textContent = 'First visit';
                newEl.style.color = 'var(--slate)';
            }

            // Save current snapshot
            localStorage.setItem(storageKey, JSON.stringify({
                totalIssues: totalIssues,
                revenue: totalRevenueAtRisk,
                timestamp: new Date().toISOString()
            }));
        }

        async function loadAll() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            allCriticalIssues = [];
            totalRevenueAtRisk = 0;

            // Load freshness early (comes from DQ endpoint)
            const dqPromise = loadDataQuality();
            const spPromise = loadSitePerformance();
            const chPromise = loadCodeHealth();
            const rhPromise = loadRedirectHealth();

            const [dqScore, spScore, chScore, rhScore] = await Promise.all([dqPromise, spPromise, chPromise, rhPromise]);

            // Calculate overall score
            const scores = [dqScore, spScore, chScore, rhScore].filter(s => s !== null);
            const overall = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            setScoreRing(overall);

            // Count total issues
            const totalIssues = ['dq-issues', 'sp-issues', 'ch-issues', 'rh-issues']
                .map(id => parseInt(document.getElementById(id).textContent) || 0)
                .reduce((a, b) => a + b, 0);

            // Render new panels
            renderKPIs(totalIssues);
            renderPriorities();
            showCriticalBanner();

            // Update timestamp
            const now = new Date();
            document.getElementById('last-refresh').textContent = 'Last refresh: ' + now.toLocaleTimeString();

            btn.disabled = false;
            btn.textContent = 'Refresh';
        }

        // Load on page load
        loadAll();
    </script>
</body>
</html>
