<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cass Brothers Â· Pricing Intelligence</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

        :root {
            --ink: #1c1b1f;
            --ink-soft: #3d3a40;
            --slate: #6b6670;
            --card: #ffffff;
            --line: rgba(27, 27, 27, 0.08);
            --shadow: 0 1px 3px rgba(17,18,19,0.04), 0 8px 24px rgba(17,18,19,0.06);
            --shadow-lg: 0 4px 12px rgba(17,18,19,0.05), 0 20px 48px rgba(17,18,19,0.08);
            --cass-black: #1b1b1b;
            --cass-cream: #f7f3ed;
            --cass-gold: #c49a4a;
            --cass-teal: #1f6f6b;
            --cass-moss: #2f3d33;
            --green: #1a7a3a;
            --green-bg: rgba(26,122,58,0.08);
            --red: #b5342a;
            --red-bg: rgba(181,52,42,0.08);
            --amber: #8b6b1f;
            --amber-bg: rgba(196,154,74,0.12);
            --radius: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "IBM Plex Sans", "Space Grotesk", sans-serif;
            background: radial-gradient(circle at top left, #fdfbf7 0%, var(--cass-cream) 45%, #f1ede6 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        /* ---- Shell ---- */
        .app-shell {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .brand-bar {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 28px;
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: "Space Grotesk", sans-serif;
            letter-spacing: 0.5px;
        }

        .brand-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--cass-gold);
            box-shadow: 0 0 0 3px rgba(196,154,74,0.2);
        }

        .brand-actions {
            display: flex; gap: 10px; font-size: 13px;
        }

        .header-pill {
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.18);
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .header-pill:hover { border-color: rgba(255,255,255,0.4); }

        /* ---- Side Nav ---- */
        .side-nav {
            padding: 24px 16px;
            border-right: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.35) 100%);
        }

        .side-nav h2 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--slate);
            margin-bottom: 14px;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 13.5px;
            color: var(--ink-soft);
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }
        .nav-item:hover { background: rgba(27,27,27,0.04); }
        .nav-item.active {
            background: var(--cass-black);
            color: #f7f1e8;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .nav-item span {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--cass-gold);
            opacity: 0.6;
            flex-shrink: 0;
        }
        .nav-item.active span { opacity: 1; }

        /* ---- Main Content ---- */
        .main-area {
            padding: 28px 32px 48px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        /* ---- Page Header ---- */
        .page-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
        }

        .page-header h1 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .page-header .subtitle {
            font-size: 13px;
            color: var(--slate);
            margin-top: 2px;
        }

        .header-badges {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .meta-badge {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(27,27,27,0.05);
            color: var(--ink-soft);
        }

        .meta-badge.trust-healthy { background: var(--green-bg); color: var(--green); }
        .meta-badge.trust-warning { background: var(--amber-bg); color: var(--amber); }
        .meta-badge.trust-critical { background: var(--red-bg); color: var(--red); }

        /* ---- Tab Navigation ---- */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: rgba(27,27,27,0.04);
            border-radius: 12px;
            padding: 4px;
        }

        .tab-btn {
            padding: 9px 22px;
            border-radius: 10px;
            border: none;
            background: transparent;
            font-family: "Space Grotesk", sans-serif;
            font-size: 13.5px;
            font-weight: 500;
            color: var(--slate);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab-btn:hover {
            color: var(--ink);
            background: rgba(255,255,255,0.5);
        }

        .tab-btn.active {
            background: var(--card);
            color: var(--ink);
            box-shadow: var(--shadow);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        /* ---- Pulse Banner ---- */
        .pulse-banner {
            background: var(--cass-moss);
            color: #e8e2d6;
            border-radius: var(--radius);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: start;
            box-shadow: var(--shadow-lg);
        }

        .pulse-banner h2 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--cass-gold);
            letter-spacing: 0.3px;
        }

        .pulse-body {
            font-size: 14px;
            line-height: 1.55;
            color: #c8c1b4;
        }

        .pulse-status-chip {
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .pulse-status-chip.competitive { background: rgba(26,122,58,0.2); color: #6cd992; }
        .pulse-status-chip.at-risk { background: rgba(196,154,74,0.2); color: var(--cass-gold); }
        .pulse-status-chip.exposed { background: rgba(181,52,42,0.2); color: #f08c84; }

        /* ---- KPI Row ---- */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        .kpi-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-card .kpi-label {
            font-size: 11px;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 500;
        }

        .kpi-card .kpi-value {
            font-family: "Space Grotesk", sans-serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .kpi-card .kpi-delta {
            font-size: 12px;
            font-weight: 500;
        }
        .kpi-delta.up { color: var(--green); }
        .kpi-delta.down { color: var(--red); }
        .kpi-delta.neutral { color: var(--slate); }

        /* ---- Section Grid ---- */
        .section-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .section-grid .full-width {
            grid-column: 1 / -1;
        }

        /* ---- Card ---- */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px 22px;
            border: 1px solid var(--line);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .card-header h3 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 14px;
            font-weight: 600;
        }

        .card-header .card-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(27,27,27,0.05);
            color: var(--slate);
            font-weight: 500;
        }

        .card .narrative {
            font-size: 13px;
            color: var(--slate);
            line-height: 1.45;
            margin-bottom: 12px;
        }

        /* ---- Tables ---- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12.5px;
        }

        th, td {
            padding: 8px 8px;
            text-align: left;
            border-bottom: 1px solid #f0ece5;
        }

        th {
            color: var(--slate);
            font-weight: 600;
            font-size: 10.5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 10px;
        }

        tr:last-child td { border-bottom: none; }

        td.num { text-align: right; font-variant-numeric: tabular-nums; }
        th.num { text-align: right; }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.info { background: rgba(31,111,107,0.1); color: var(--cass-teal); }
        .badge.warning { background: var(--amber-bg); color: var(--amber); }
        .badge.critical { background: var(--red-bg); color: var(--red); }
        .badge.ok { background: var(--green-bg); color: var(--green); }

        .delta-positive { color: var(--green); font-weight: 500; }
        .delta-negative { color: var(--red); font-weight: 500; }

        .wrap { white-space: normal; word-break: break-word; }

        .table-scroll { max-height: 460px; overflow-y: auto; }

        .clickable-row { cursor: pointer; transition: background 0.12s ease; }
        .clickable-row:hover { background: #faf8f4; }

        /* ---- Brand Selector ---- */
        .brand-select {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #faf8f4;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            min-width: 260px;
            outline: none;
            transition: border-color 0.15s;
        }
        .brand-select:focus { border-color: var(--cass-gold); }

        .export-pdf-btn {
            padding: 9px 18px;
            border-radius: 10px;
            border: 1px solid var(--cass-moss);
            background: var(--cass-moss);
            color: #fff;
            font-size: 13px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            white-space: nowrap;
        }
        .export-pdf-btn:hover { background: #243528; }
        .export-pdf-btn:active { transform: scale(0.97); }
        .export-pdf-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
        }

        /* ---- SKU Search ---- */
        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
            position: relative;
        }

        .search-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #faf8f4;
            font-size: 13.5px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.15s;
        }
        .search-input:focus { border-color: var(--cass-gold); }

        .range-select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #faf8f4;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            border-radius: 10px;
            border: 1px solid var(--line);
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 50;
            max-height: 260px;
            overflow-y: auto;
        }

        .suggestions button {
            width: 100%;
            text-align: left;
            padding: 10px 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12.5px;
            font-family: inherit;
            border-bottom: 1px solid #f0ece5;
            line-height: 1.4;
        }
        .suggestions button:last-child { border-bottom: none; }
        .suggestions button:hover { background: #faf8f4; }
        .suggestions .sg-sku { font-weight: 600; }
        .suggestions .sg-meta { color: var(--slate); font-size: 11.5px; }

        /* ---- SKU Detail Grid ---- */
        .sku-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 14px;
        }

        .sku-stat {
            background: #faf8f4;
            border-radius: 10px;
            padding: 12px 14px;
        }

        .sku-stat .ss-label {
            font-size: 10.5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate);
            font-weight: 600;
        }

        .sku-stat .ss-value {
            margin-top: 4px;
            font-weight: 600;
            font-size: 15px;
            font-family: "Space Grotesk", sans-serif;
        }

        /* ---- SKU Sub-grid ---- */
        .sku-sub-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 16px;
        }

        /* ---- Price History Chart ---- */
        .history-chart-wrap {
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(31,111,107,0.06), rgba(196,154,74,0.06));
            padding: 12px;
        }

        .history-legend {
            display: flex;
            gap: 16px;
            font-size: 11.5px;
            color: var(--slate);
            margin-top: 8px;
        }

        .legend-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }

        /* ---- Following Pill ---- */
        .follow-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 999px;
            background: var(--amber-bg);
            color: var(--amber);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 10px;
        }

        /* ---- Chart Tooltip ---- */
        .chart-tooltip {
            position: absolute;
            pointer-events: none;
            background: var(--cass-black);
            color: #f7f1e8;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 11.5px;
            line-height: 1.55;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.12s ease;
        }
        .chart-tooltip.visible { opacity: 1; }
        .chart-tooltip .tt-date {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--cass-gold);
        }
        .chart-tooltip .tt-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }
        .chart-tooltip .tt-label { color: #a09a90; }
        .chart-tooltip .tt-val { font-weight: 600; font-variant-numeric: tabular-nums; }
        .chart-tooltip .tt-sales { margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.12); }

        /* ---- Chart container ---- */
        .chart-container {
            position: relative;
        }

        .chart-container svg { display: block; }

        /* ---- Sales bar legend ---- */
        .legend-bar {
            width: 10px; height: 8px;
            border-radius: 2px;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }

        /* ---- Cost Breakdown ---- */
        .cost-section {
            margin-top: 16px;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .cost-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #faf8f4;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate);
            transition: background 0.12s;
        }
        .cost-header:hover { background: #f3efe8; }
        .cost-header .chevron {
            transition: transform 0.2s;
            font-size: 14px;
        }
        .cost-header.open .chevron { transform: rotate(180deg); }
        .cost-body {
            display: none;
            padding: 14px 16px;
        }
        .cost-body.open { display: block; }
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px 16px;
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 4px 0;
            font-size: 12.5px;
            border-bottom: 1px solid var(--line);
        }
        .cost-item:last-child { border-bottom: none; }
        .cost-item .ci-label {
            color: var(--slate);
            font-size: 11.5px;
        }
        .cost-item .ci-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .cost-item .ci-value.pct {
            color: var(--cass-teal);
        }
        .sku-flags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .sku-flag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 11.5px;
            font-weight: 600;
        }
        .sku-flag.warn {
            background: var(--red-bg);
            color: var(--red);
        }
        .sku-flag.info {
            background: var(--amber-bg);
            color: var(--amber);
        }

        /* ---- Empty State ---- */
        .empty-state {
            text-align: center;
            color: var(--slate);
            padding: 32px 16px;
            font-size: 13px;
        }

        /* ---- Modal ---- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(27,27,27,0.5);
            backdrop-filter: blur(2px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-panel {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            max-width: 960px;
            width: 92%;
            max-height: 88vh;
            overflow-y: auto;
            padding: 28px 28px 20px;
            position: relative;
        }

        .modal-close {
            position: sticky;
            top: 0;
            float: right;
            background: var(--card);
            border: 1px solid var(--line);
            font-size: 20px;
            color: var(--slate);
            cursor: pointer;
            z-index: 1;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.12s;
        }
        .modal-close:hover {
            background: rgba(27,27,27,0.06);
            color: var(--ink);
        }

        .sku-link {
            color: var(--cass-teal);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
        }
        .sku-link:hover { text-decoration: underline; }

        /* ---- Decision Card ---- */
        .decision-card {
            background: var(--card); border-radius: var(--radius); padding: 20px 22px;
            border: 1px solid var(--line); border-left: 4px solid var(--cass-gold);
            box-shadow: var(--shadow);
        }
        .decision-card-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;
        }
        .decision-card-header h3 {
            font-family: "Space Grotesk", sans-serif; font-size: 14px; font-weight: 600;
            color: var(--amber); display: flex; align-items: center; gap: 8px; margin: 0;
        }
        .confidence-badge {
            padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.4px;
        }
        .confidence-high { background: var(--green-bg); color: var(--green); }
        .confidence-medium { background: var(--amber-bg); color: var(--amber); }
        .confidence-low { background: var(--red-bg); color: var(--red); }
        .decision-row {
            display: grid; grid-template-columns: 120px 1fr;
            gap: 4px 16px; padding: 8px 0; border-bottom: 1px solid var(--line);
        }
        .decision-row:last-child { border-bottom: none; }
        .decision-row .dr-label {
            font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--slate); font-weight: 600; padding-top: 2px;
        }
        .decision-row .dr-value { font-size: 13.5px; line-height: 1.5; color: var(--ink-soft); }
        .impact-badge, .effort-badge {
            display: inline-block; padding: 2px 8px; border-radius: 999px;
            font-size: 10px; font-weight: 600; letter-spacing: 0.3px;
            margin-left: 6px; vertical-align: middle;
        }
        .impact-high { background: var(--red-bg); color: var(--red); }
        .impact-medium { background: var(--amber-bg); color: var(--amber); }
        .impact-low { background: rgba(27,27,27,0.06); color: var(--slate); }
        .effort-low { background: var(--green-bg); color: var(--green); }
        .effort-medium { background: var(--amber-bg); color: var(--amber); }
        .effort-high { background: var(--red-bg); color: var(--red); }

        /* ---- Trust Banner ---- */
        .trust-banner {
            background: rgba(196,154,74,0.08); border: 1px solid rgba(196,154,74,0.3);
            border-radius: var(--radius); padding: 14px 18px;
            display: flex; align-items: flex-start; gap: 10px;
            font-size: 13px; color: var(--amber);
        }
        .trust-banner .tb-icon { font-size: 18px; flex-shrink: 0; line-height: 1; }
        .trust-banner .tb-body { line-height: 1.5; }
        .trust-banner strong { color: var(--ink); }

        /* ---- Explainability Tooltips ---- */
        .why-tip {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; border-radius: 50%;
            background: rgba(27,27,27,0.08); color: var(--slate);
            font-size: 9px; font-weight: 700; cursor: help;
            margin-left: 4px; position: relative; vertical-align: middle;
        }
        .why-tip .why-tip-box {
            display: none; position: absolute; bottom: calc(100% + 6px); left: 50%;
            transform: translateX(-50%); width: 220px; padding: 10px 12px;
            background: var(--cass-black); color: #e8e2d6; border-radius: 10px;
            font-size: 11px; font-weight: 400; line-height: 1.5;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 50;
            text-transform: none; letter-spacing: 0; pointer-events: none;
        }
        .why-tip:hover .why-tip-box { display: block; }

        /* ---- Table Readability ---- */
        tbody tr:nth-child(even) { background: rgba(0,0,0,0.015); }
        th { position: sticky; top: 0; background: var(--card); z-index: 1; }

        /* ---- Responsive ---- */
        @media (max-width: 1100px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .sku-sub-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) {
            .app-shell { grid-template-columns: 1fr; }
            .side-nav {
                display: flex; gap: 8px; overflow-x: auto;
                padding: 12px 16px; border-right: none; border-bottom: 1px solid var(--line);
            }
            .side-nav h2 { display: none; }
            .section-grid { grid-template-columns: 1fr; }
            .kpi-row { grid-template-columns: 1fr 1fr; }
            .pulse-banner { grid-template-columns: 1fr; }
            .tab-nav { overflow-x: auto; }
            .modal-panel { width: 96%; padding: 18px; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- Brand Bar -->
        <div class="brand-bar">
            <div class="brand-mark">
                <span class="brand-dot"></span>
                <strong>Cass Brothers Intelligence</strong>
            </div>
            <div class="brand-actions">
                <span class="header-pill" id="pricing-refresh">Loading...</span>
            </div>
        </div>

        <!-- Side Nav -->
        <aside class="side-nav">
            <h2>Dashboards</h2>
            <a class="nav-item" href="/dashboard"><span></span> Overview</a>
            <a class="nav-item" href="/performance"><span></span> Performance</a>
            <a class="nav-item" href="/seo-dashboard"><span></span> SEO &amp; Content</a>
            <a class="nav-item" href="/ads-intelligence"><span></span> Ads Intelligence</a>
            <a class="nav-item" href="/finance-dashboard"><span></span> Finance</a>
            <a class="nav-item" href="/inventory"><span></span> Inventory</a>
            <a class="nav-item" href="/stock-worthiness"><span></span> Stock Worthiness</a>
            <a class="nav-item active" href="/pricing-intel"><span></span> Pricing Intel</a>
            <a class="nav-item" href="/customer-intelligence"><span></span> Customer Intel</a>
            <a class="nav-item" href="/merchant-center-intel"><span></span> Merchant Center</a>
            <a class="nav-item" href="/strategic-intelligence"><span></span> Intelligence Brief</a>
            <a class="nav-item" href="/site-intelligence"><span></span> Site Intelligence</a>
            <a class="nav-item" href="/brand-intelligence"><span></span> Brand Intelligence</a>
            <div style="border-top:1px solid rgba(27,27,27,0.08);margin-top:16px;padding-top:12px">
                <a class="nav-item" href="#" onclick="openInviteModal();return false" style="opacity:0.6"><span></span> Invite User</a>
                <a class="nav-item" href="#" onclick="fetch('/auth/logout',{method:'POST'}).then(()=>location.href='/auth/login');return false" style="opacity:0.6"><span></span> Logout</a>
            </div>
    </aside>

        <!-- Main Content -->
        <section class="main-area">

            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1>Pricing Intelligence</h1>
                    <p class="subtitle">Market overview, brand analysis &amp; SKU lookup</p>
                </div>
                <div class="header-badges">
                    <div class="meta-badge" id="snapshot-badge">--</div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="brand-report">Brand Report</button>
                <button class="tab-btn" data-tab="sku-lookup">SKU Lookup</button>
            </div>

            <!-- ===== TAB: Overview ===== -->
            <div class="tab-content active" id="tab-overview">

                <!-- Pulse Banner -->
                <div class="pulse-banner">
                    <div>
                        <h2>Pricing Pulse</h2>
                        <div class="pulse-body" id="ov-pulse">Loading market overview...</div>
                    </div>
                    <div class="pulse-status-chip at-risk" id="ov-status">Loading</div>
                </div>

                <!-- Trust Banner (conditional) -->
                <div class="trust-banner" id="pricing-trust-banner" style="display:none;">
                    <div class="tb-icon">&#9888;</div>
                    <div class="tb-body" id="pricing-trust-body"></div>
                </div>

                <!-- Decision Card -->
                <div class="decision-card" id="pricing-decision-card">
                    <div class="decision-card-header">
                        <h3>Decision Summary</h3>
                        <span class="confidence-badge confidence-high" id="pricing-confidence">High</span>
                    </div>
                    <div class="decision-row">
                        <div class="dr-label">Primary Insight</div>
                        <div class="dr-value" id="pricing-dc-insight">Loading...</div>
                    </div>
                    <div class="decision-row">
                        <div class="dr-label">Why It Matters</div>
                        <div class="dr-value" id="pricing-dc-why">--</div>
                    </div>
                    <div class="decision-row">
                        <div class="dr-label">Do Next</div>
                        <div class="dr-value" id="pricing-dc-next">--</div>
                    </div>
                </div>

                <!-- KPI Row -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-label">Avg Market Discount <span class="why-tip">?<span class="why-tip-box">Average discount from RRP across all tracked competitor prices. Higher means more aggressive market. Over 30% signals heavy discounting pressure.</span></span></div>
                        <div class="kpi-value" id="ov-kpi-discount">--</div>
                        <div class="kpi-delta neutral">Off RRP</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">SKUs Below Floor <span class="why-tip">?<span class="why-tip-box">Products where at least one competitor is priced below your minimum allowed price (floor). You cannot profitably match these.</span></span></div>
                        <div class="kpi-value" id="ov-kpi-below">--</div>
                        <div class="kpi-delta neutral" id="ov-kpi-below-sub">--</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Gap $ <span class="why-tip">?<span class="why-tip-box">Sum of all price gaps between competitor lowest price and your floor price. Represents revenue exposure from unmatchable competition.</span></span></div>
                        <div class="kpi-value" id="ov-kpi-gap">--</div>
                        <div class="kpi-delta neutral">Revenue exposure</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Brands Tracked</div>
                        <div class="kpi-value" id="ov-kpi-brands">--</div>
                        <div class="kpi-delta neutral" id="ov-kpi-total-skus">--</div>
                    </div>
                </div>

                <!-- Section Grid -->
                <div class="section-grid">

                    <!-- Brand Pressure (full width) -->
                    <div class="card full-width">
                        <div class="card-header">
                            <h3>Brand Pressure</h3>
                            <div class="card-badge">Click a row to drill down</div>
                        </div>
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Brand</th>
                                        <th class="num">Total SKUs</th>
                                        <th class="num">Undercut</th>
                                        <th class="num">Avg Discount %</th>
                                        <th class="num">Avg Gap $</th>
                                        <th>Most Aggressive</th>
                                    </tr>
                                </thead>
                                <tbody id="ov-brand-pressure">
                                    <tr><td colspan="6">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Competitor Leaderboard -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Competitor Leaderboard</h3>
                        </div>
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Competitor</th>
                                        <th class="num">Times Cheapest</th>
                                        <th class="num">Below Floor</th>
                                        <th class="num">Avg Gap $</th>
                                    </tr>
                                </thead>
                                <tbody id="ov-competitor-board">
                                    <tr><td colspan="4">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Category Pressure -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Category Pressure</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="num">Avg Discount %</th>
                                    <th class="num">Below Floor</th>
                                    <th class="num">Avg Gap $</th>
                                </tr>
                            </thead>
                            <tbody id="ov-category-pressure">
                                <tr><td colspan="4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <!-- ===== TAB: Brand Report ===== -->
            <div class="tab-content" id="tab-brand-report">

                <!-- Brand Selector -->
                <div style="display:flex;align-items:center;gap:14px;">
                    <label style="font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:14px;">Select Brand</label>
                    <select id="brandSelect" class="brand-select">
                        <option value="">-- Choose a brand --</option>
                    </select>
                    <button id="exportPdfBtn" class="export-pdf-btn" style="display:none;" onclick="exportBrandPdf()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align:-2px;margin-right:5px;">
                            <path d="M8 1v9M8 10L5 7M8 10l3-3M3 13h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Export PDF
                    </button>
                </div>

                <!-- Empty state -->
                <div id="brand-report-empty" class="empty-state">
                    Select a brand above to view the full pricing report.
                </div>

                <!-- Brand report content (hidden until brand selected) -->
                <div id="brand-report-content" style="display:none;">

                    <!-- KPI Row -->
                    <div class="kpi-row">
                        <div class="kpi-card">
                            <div class="kpi-label">Avg Discount %</div>
                            <div class="kpi-value" id="br-kpi-discount">--</div>
                            <div class="kpi-delta neutral">Off RRP</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">SKUs Below Floor</div>
                            <div class="kpi-value" id="br-kpi-below">--</div>
                            <div class="kpi-delta neutral" id="br-kpi-below-sub">--</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Total SKUs</div>
                            <div class="kpi-value" id="br-kpi-total">--</div>
                            <div class="kpi-delta neutral" id="br-kpi-with-rrp">--</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Total Gap $</div>
                            <div class="kpi-value" id="br-kpi-gap">--</div>
                            <div class="kpi-delta neutral">Revenue exposure</div>
                        </div>
                    </div>

                    <!-- Section Grid -->
                    <div class="section-grid">

                        <!-- Category Breakdown -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Category Breakdown</h3>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th class="num">SKUs</th>
                                        <th class="num">Avg Disc %</th>
                                        <th class="num">Max Disc %</th>
                                        <th class="num">Below Floor</th>
                                        <th class="num">Avg Gap $</th>
                                        <th>Aggressor</th>
                                    </tr>
                                </thead>
                                <tbody id="br-category">
                                    <tr><td colspan="7" class="empty-state">Select a brand</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Collection Breakdown -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Collection Breakdown</h3>
                                <div class="card-badge" id="br-collection-count">--</div>
                            </div>
                            <div class="table-scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Collection</th>
                                            <th class="num">SKUs</th>
                                            <th class="num">Avg Disc %</th>
                                            <th class="num">Below Floor</th>
                                            <th class="num">Avg Gap $</th>
                                            <th>Aggressor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="br-collection">
                                        <tr><td colspan="6" class="empty-state">Select a brand</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Competitor Activity -->
                        <div class="card full-width">
                            <div class="card-header">
                                <h3>Competitor Activity</h3>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Competitor</th>
                                        <th class="num">Times Below Floor</th>
                                        <th class="num">Avg Gap $</th>
                                        <th class="num">Max Gap $</th>
                                        <th>Top Category</th>
                                        <th>Top Collection</th>
                                    </tr>
                                </thead>
                                <tbody id="br-competitor">
                                    <tr><td colspan="6" class="empty-state">Select a brand</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Monthly Trends -->
                        <div class="card full-width">
                            <div class="card-header">
                                <h3>Monthly Trends</h3>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th class="num">Avg Discount %</th>
                                        <th class="num">Below Floor</th>
                                        <th class="num">Avg Gap $</th>
                                        <th class="num">Snapshots</th>
                                    </tr>
                                </thead>
                                <tbody id="br-monthly">
                                    <tr><td colspan="5" class="empty-state">Select a brand</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Heavily Discounted SKUs -->
                        <div class="card full-width">
                            <div class="card-header">
                                <h3>Heavily Discounted SKUs</h3>
                                <div class="card-badge">Top 50 by discount %</div>
                            </div>
                            <div class="table-scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Title</th>
                                            <th>Collection</th>
                                            <th>Category</th>
                                            <th class="num">RRP</th>
                                            <th class="num">Our Min</th>
                                            <th class="num">Mkt Low</th>
                                            <th class="num">Disc %</th>
                                            <th>Below?</th>
                                            <th class="num">Gap $</th>
                                            <th>Cheapest</th>
                                        </tr>
                                    </thead>
                                    <tbody id="br-skus">
                                        <tr><td colspan="11" class="empty-state">Select a brand</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ===== TAB: SKU Lookup ===== -->
            <div class="tab-content" id="tab-sku-lookup">
                <div class="card full-width">
                    <div class="card-header">
                        <h3>SKU Pricing Lookup</h3>
                        <div class="card-badge">Search &amp; drill down</div>
                    </div>
                    <div class="search-row">
                        <input id="skuSearch" class="search-input" placeholder="Search SKU, product name, or vendor...">
                        <select id="rangeSelect" class="range-select">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="365">12 months</option>
                        </select>
                        <div id="suggestions" class="suggestions"></div>
                    </div>
                    <div id="skuDetail">
                        <div class="empty-state">Search for a SKU above to view full pricing intelligence.</div>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <!-- SKU Detail Modal -->
    <div id="skuModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeSkuModal()">
        <div class="modal-panel">
            <button class="modal-close" onclick="closeSkuModal()">&times;</button>
            <div id="modalSkuContent">
                <div class="empty-state">Loading SKU details...</div>
            </div>
        </div>
    </div>

    <script>
        /* ============================================================
           Utilities
           ============================================================ */
        function fmt(val, decimals = 2) {
            if (val === null || val === undefined) return '\u2014';
            return '$' + Number(val).toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
        }

        function fmtPct(val) {
            if (val === null || val === undefined) return '\u2014';
            const sign = val >= 0 ? '+' : '';
            return sign + Number(val).toFixed(1) + '%';
        }

        function fmtN(val) {
            if (val === null || val === undefined) return '\u2014';
            return Number(val).toLocaleString();
        }

        function renderTable(targetId, rows, rowTemplate, limit) {
            const tbody = document.getElementById(targetId);
            if (!tbody) return;
            const list = limit ? (rows || []).slice(0, limit) : (rows || []);
            if (!list.length) {
                const colspan = tbody.closest('table')?.querySelectorAll('th')?.length || 4;
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="color:var(--slate);text-align:center;padding:16px 0;">No data</td></tr>`;
                return;
            }
            tbody.innerHTML = list.map(rowTemplate).join('');
        }

        /* ============================================================
           Tab Switching
           ============================================================ */
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
            tabContents.forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
        }

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        /* ============================================================
           Overview Tab
           ============================================================ */
        let overviewLoaded = false;

        async function loadOverview() {
            if (overviewLoaded) return;
            try {
                const res = await fetch('/pricing/overview');
                const json = await res.json();
                if (!json.success) throw new Error('Failed to load overview');
                renderOverview(json.data);
                overviewLoaded = true;
            } catch (e) {
                console.error('Overview load error:', e);
                document.getElementById('ov-pulse').textContent = 'Failed to load market overview.';
            }
        }

        let overviewData = null;

        function renderPricingDecision(d) {
            const kpis = d.kpis || {};
            const belowFloor = kpis.skus_below_floor || 0;
            const belowPct = kpis.skus_below_floor_pct || 0;
            const totalGap = kpis.total_gap_below_floor || 0;

            // Trust banner â show if snapshot_date is more than 3 days old
            const trustBanner = document.getElementById('pricing-trust-banner');
            const trustBody = document.getElementById('pricing-trust-body');
            if (d.snapshot_date) {
                const snapDate = new Date(d.snapshot_date);
                const now = new Date();
                const daysDiff = Math.floor((now - snapDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > 3) {
                    trustBanner.style.display = 'flex';
                    trustBody.innerHTML = `<strong>DATA FRESHNESS:</strong> Pricing snapshot is ${daysDiff} days old. Competitor prices may have changed. <strong>Action:</strong> Run a fresh Caprice pricing sync.`;
                }
            }

            // Primary insight
            let insight, why, doNext;
            let impactLevel = 'Medium', effortLevel = 'Medium';

            if (belowPct >= 7) {
                insight = `${belowFloor} SKUs (${belowPct.toFixed(1)}%) are priced below your floor by competitors \u2014 you're exposed.`;
            } else if (belowPct >= 3) {
                insight = `${belowFloor} SKUs (${belowPct.toFixed(1)}%) are below floor. Moderate competitive pressure.`;
            } else {
                insight = `Pricing is competitive. Only ${belowFloor} SKUs below floor (${belowPct.toFixed(1)}%).`;
            }

            // Why it matters
            if (totalGap > 0) {
                why = `The total gap below floor is ${fmt(totalGap, 0)}. These are SKUs where competitors undercut your minimum \u2014 you cannot profitably match.`;
            } else {
                why = 'No competitors are currently pricing below your floor. Pricing position is strong.';
            }

            // Do next
            if (belowPct >= 7) {
                doNext = 'Review top 10 brands by undercut count. Negotiate floor adjustments with suppliers or delist unmatchable SKUs.';
                impactLevel = 'High'; effortLevel = 'High';
            } else if (belowPct >= 3) {
                doNext = 'Monitor the most aggressive competitors and assess if rule adjustments are needed.';
                impactLevel = 'Medium'; effortLevel = 'Low';
            } else {
                doNext = 'Pricing position is strong. Review any remaining below-floor SKUs for quick wins.';
                impactLevel = 'Low'; effortLevel = 'Low';
            }

            // Confidence: High (direct measurement from Caprice)
            const confidence = 'High';
            const confEl = document.getElementById('pricing-confidence');
            confEl.textContent = confidence;
            confEl.className = 'confidence-badge confidence-' + confidence.toLowerCase();

            document.getElementById('pricing-dc-insight').textContent = insight;
            document.getElementById('pricing-dc-why').textContent = why;
            document.getElementById('pricing-dc-next').innerHTML = doNext
                + ` <span class="impact-badge impact-${impactLevel.toLowerCase()}">Impact: ${impactLevel}</span>`
                + ` <span class="effort-badge effort-${effortLevel.toLowerCase()}">Effort: ${effortLevel}</span>`;
        }

        function renderOverview(d) {
            overviewData = d;
            const kpis = d.kpis || {};
            const brandCount = (d.brand_pressure || []).length;

            // Decision card
            renderPricingDecision(d);

            // Pulse
            document.getElementById('ov-pulse').textContent =
                `${fmtN(d.total_skus)} SKUs tracked across ${brandCount} brands \u00b7 Snapshot ${d.snapshot_date} \u00b7 Average market discount ${(kpis.avg_market_discount_pct || 0).toFixed(1)}% off RRP`;

            // Status chip
            const chip = document.getElementById('ov-status');
            const belowPct = kpis.skus_below_floor_pct || 0;
            if (belowPct < 3) {
                chip.textContent = 'Competitive';
                chip.className = 'pulse-status-chip competitive';
            } else if (belowPct < 7) {
                chip.textContent = 'At Risk';
                chip.className = 'pulse-status-chip at-risk';
            } else {
                chip.textContent = 'Exposed';
                chip.className = 'pulse-status-chip exposed';
            }

            // KPIs
            document.getElementById('ov-kpi-discount').textContent = (kpis.avg_market_discount_pct || 0).toFixed(1) + '%';
            document.getElementById('ov-kpi-below').textContent = fmtN(kpis.skus_below_floor);
            document.getElementById('ov-kpi-below-sub').textContent = (kpis.skus_below_floor_pct || 0).toFixed(1) + '% of tracked';
            document.getElementById('ov-kpi-gap').textContent = fmt(kpis.total_gap_below_floor, 0);
            document.getElementById('ov-kpi-brands').textContent = brandCount;
            document.getElementById('ov-kpi-total-skus').textContent = fmtN(d.total_skus) + ' SKUs';

            // Header
            document.getElementById('snapshot-badge').textContent = d.snapshot_date;
            document.getElementById('pricing-refresh').textContent = 'Updated just now';

            // Brand Pressure table
            renderTable('ov-brand-pressure', d.brand_pressure, row => `
                <tr class="clickable-row" onclick="drillToBrand('${(row.brand || '').replace(/'/g, "\\'")}')">
                    <td style="font-weight:600;">${row.brand || '\u2014'}</td>
                    <td class="num">${fmtN(row.total_skus)}</td>
                    <td class="num">${fmtN(row.undercut_count)}</td>
                    <td class="num">${(row.avg_discount_pct != null ? row.avg_discount_pct.toFixed(1) : '\u2014')}%</td>
                    <td class="num">${row.avg_gap_when_below != null ? fmt(row.avg_gap_when_below) : '\u2014'}</td>
                    <td>${row.most_aggressive || '\u2014'}</td>
                </tr>
            `, 40);

            // Competitor Leaderboard
            renderTable('ov-competitor-board', d.competitor_leaderboard, row => `
                <tr>
                    <td style="font-weight:500;">${row.competitor || '\u2014'}</td>
                    <td class="num">${fmtN(row.times_cheapest)}</td>
                    <td class="num">${fmtN(row.times_below_floor)}</td>
                    <td class="num">${row.avg_gap_when_cheapest != null ? fmt(row.avg_gap_when_cheapest) : '\u2014'}</td>
                </tr>
            `, 20);

            // Category Pressure
            renderTable('ov-category-pressure', d.category_pressure, row => `
                <tr>
                    <td style="font-weight:500;">${row.category || '\u2014'}</td>
                    <td class="num">${row.avg_discount_pct != null ? row.avg_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td class="num">${fmtN(row.skus_below_floor)}</td>
                    <td class="num">${row.avg_gap_below != null ? fmt(row.avg_gap_below) : '\u2014'}</td>
                </tr>
            `);
        }

        /* ============================================================
           Brand Report Tab
           ============================================================ */
        let brandsLoaded = false;

        async function loadBrandList() {
            if (brandsLoaded) return;
            try {
                const res = await fetch('/pricing/brands');
                const json = await res.json();
                if (!json.success) throw new Error('Failed');
                const sel = document.getElementById('brandSelect');
                (json.data || []).forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.brand;
                    opt.textContent = `${b.brand} (${b.sku_count} SKUs)`;
                    sel.appendChild(opt);
                });
                brandsLoaded = true;
            } catch (e) {
                console.error('Brand list load error:', e);
            }
        }

        document.getElementById('brandSelect').addEventListener('change', function() {
            const brand = this.value;
            const pdfBtn = document.getElementById('exportPdfBtn');
            if (brand) {
                loadBrandReport(brand);
                pdfBtn.style.display = '';
            } else {
                document.getElementById('brand-report-content').style.display = 'none';
                document.getElementById('brand-report-empty').style.display = '';
                pdfBtn.style.display = 'none';
            }
        });

        function exportBrandPdf() {
            const brand = document.getElementById('brandSelect').value;
            if (!brand) return;
            const btn = document.getElementById('exportPdfBtn');
            const orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span style="display:inline-block;animation:spin .8s linear infinite;margin-right:5px;">&#9696;</span>Generating...';
            // Open in new tab / trigger download
            const url = `/pricing/brand-report/pdf?brand=${encodeURIComponent(brand)}`;
            fetch(url)
                .then(res => {
                    if (!res.ok) throw new Error('PDF generation failed');
                    return res.blob();
                })
                .then(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `Pricing_Report_${brand.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(a.href);
                })
                .catch(e => {
                    console.error('PDF export error:', e);
                    alert('Failed to generate PDF. Please try again.');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = orig;
                });
        }

        async function loadBrandReport(brand) {
            document.getElementById('brand-report-empty').style.display = 'none';
            document.getElementById('brand-report-content').style.display = '';

            // Loading states
            ['br-category', 'br-collection', 'br-competitor', 'br-monthly', 'br-skus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const cols = el.closest('table')?.querySelectorAll('th')?.length || 6;
                    el.innerHTML = `<tr><td colspan="${cols}" style="color:var(--slate);text-align:center;padding:16px 0;">Loading...</td></tr>`;
                }
            });

            try {
                const res = await fetch(`/pricing/brand-report?brand=${encodeURIComponent(brand)}`);
                const json = await res.json();
                if (!json.success) throw new Error(json.error || 'Failed');
                renderBrandReport(json.data);
            } catch (e) {
                console.error('Brand report load error:', e);
            }
        }

        function renderBrandReport(d) {
            const kpis = d.kpis || {};

            // KPIs
            document.getElementById('br-kpi-discount').textContent = (kpis.avg_market_discount_pct || 0).toFixed(1) + '%';
            document.getElementById('br-kpi-below').textContent = fmtN(kpis.skus_below_floor);
            document.getElementById('br-kpi-below-sub').textContent = 'of ' + fmtN(d.total_skus) + ' SKUs';
            document.getElementById('br-kpi-total').textContent = fmtN(d.total_skus);
            document.getElementById('br-kpi-with-rrp').textContent = fmtN(kpis.skus_with_rrp) + ' with RRP';
            document.getElementById('br-kpi-gap').textContent = fmt(kpis.total_gap_below_floor, 0);

            // Category Breakdown
            renderTable('br-category', d.category_breakdown, row => `
                <tr>
                    <td style="font-weight:500;">${row.category || '\u2014'}</td>
                    <td class="num">${fmtN(row.sku_count)}</td>
                    <td class="num">${row.avg_discount_pct != null ? row.avg_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td class="num">${row.max_discount_pct != null ? row.max_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td class="num">${fmtN(row.skus_below_floor)}</td>
                    <td class="num">${row.avg_gap_below != null ? fmt(row.avg_gap_below) : '\u2014'}</td>
                    <td>${row.most_aggressive || '\u2014'}</td>
                </tr>
            `);

            // Collection Breakdown
            const colls = d.collection_breakdown || [];
            document.getElementById('br-collection-count').textContent = colls.length + ' collections';
            renderTable('br-collection', colls, row => `
                <tr>
                    <td style="font-weight:500;">${row.collection || '\u2014'}</td>
                    <td class="num">${fmtN(row.sku_count)}</td>
                    <td class="num">${row.avg_discount_pct != null ? row.avg_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td class="num">${fmtN(row.skus_below_floor)}</td>
                    <td class="num">${row.avg_gap_below != null ? fmt(row.avg_gap_below) : '\u2014'}</td>
                    <td>${row.most_aggressive || '\u2014'}</td>
                </tr>
            `, 30);

            // Competitor Activity
            renderTable('br-competitor', d.competitor_activity, row => `
                <tr>
                    <td style="font-weight:500;">${row.competitor || '\u2014'}</td>
                    <td class="num">${fmtN(row.times_below_floor)}</td>
                    <td class="num">${row.avg_gap_when_below != null ? fmt(row.avg_gap_when_below) : '\u2014'}</td>
                    <td class="num">${row.max_gap != null ? fmt(row.max_gap) : '\u2014'}</td>
                    <td>${row.top_category || '\u2014'}</td>
                    <td>${row.top_collection || '\u2014'}</td>
                </tr>
            `);

            // Monthly Trends
            renderTable('br-monthly', d.monthly_trends, row => `
                <tr>
                    <td style="font-weight:500;">${row.month_name || row.month || '\u2014'}</td>
                    <td class="num">${row.avg_discount_pct != null ? row.avg_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td class="num">${fmtN(row.skus_below_floor)}</td>
                    <td class="num">${row.avg_gap_below != null ? fmt(row.avg_gap_below) : '\u2014'}</td>
                    <td class="num">${row.snapshot_count || '\u2014'}</td>
                </tr>
            `);

            // Heavily Discounted SKUs
            renderTable('br-skus', d.heavily_discounted_skus, row => `
                <tr>
                    <td><span class="sku-link" onclick="openSkuModal('${(row.sku || '').replace(/'/g, "\\'")}')">${row.sku || '\u2014'}</span></td>
                    <td class="wrap" style="max-width:220px;font-size:11.5px;">${row.title || '\u2014'}</td>
                    <td>${row.collection || '\u2014'}</td>
                    <td>${row.category || '\u2014'}</td>
                    <td class="num">${fmt(row.rrp)}</td>
                    <td class="num">${fmt(row.our_min)}</td>
                    <td class="num">${fmt(row.market_lowest)}</td>
                    <td class="num" style="font-weight:600;${row.market_discount_pct > 40 ? 'color:var(--red);' : ''}">${row.market_discount_pct != null ? row.market_discount_pct.toFixed(1) + '%' : '\u2014'}</td>
                    <td>${row.below_floor ? '<span class="badge critical">Yes</span>' : '<span class="badge ok">No</span>'}</td>
                    <td class="num">${row.gap > 0 ? fmt(row.gap) : '\u2014'}</td>
                    <td>${row.cheapest_competitor || '\u2014'}</td>
                </tr>
            `, 50);
        }

        /* ============================================================
           Drill-down from Overview â Brand Report
           ============================================================ */
        function drillToBrand(brand) {
            switchTab('brand-report');
            const sel = document.getElementById('brandSelect');
            sel.value = brand;
            sel.dispatchEvent(new Event('change'));
        }

        /* ============================================================
           SKU Detail Modal
           ============================================================ */
        const skuModal = document.getElementById('skuModal');
        const modalContent = document.getElementById('modalSkuContent');

        async function openSkuModal(sku) {
            skuModal.style.display = 'flex';
            modalContent.innerHTML = '<div class="empty-state">Loading pricing intelligence...</div>';
            document.body.style.overflow = 'hidden';

            try {
                const res = await fetch(`/pricing/sku?sku=${encodeURIComponent(sku)}&days=90`);
                const json = await res.json();
                if (!json.success || json.data?.error) {
                    modalContent.innerHTML = `<div class="empty-state">${json.data?.error || 'SKU not found'}</div>`;
                    return;
                }
                modalContent.innerHTML = buildSkuDetailHTML(json.data, 'modalHistoryChart', 'modalChartTooltip');
                renderHistoryChart(json.data.history || [], 'modalHistoryChart', 'modalChartTooltip');
            } catch (e) {
                modalContent.innerHTML = '<div class="empty-state">Error loading SKU data.</div>';
            }
        }

        function closeSkuModal() {
            skuModal.style.display = 'none';
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && skuModal.style.display !== 'none') closeSkuModal();
        });

        /* ============================================================
           SKU Search + Autocomplete
           ============================================================ */
        const skuSearch = document.getElementById('skuSearch');
        const suggestionsEl = document.getElementById('suggestions');
        const rangeSelect = document.getElementById('rangeSelect');
        const skuDetail = document.getElementById('skuDetail');

        let debounceTimer;

        skuSearch.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const query = skuSearch.value.trim();
            if (query.length < 2) {
                suggestionsEl.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`/pricing/search?query=${encodeURIComponent(query)}`);
                    const json = await res.json();
                    const items = json.success ? json.data : [];
                    if (!items.length) { suggestionsEl.style.display = 'none'; return; }
                    suggestionsEl.innerHTML = items.map(item => `
                        <button data-sku="${item.sku}">
                            <span class="sg-sku">${item.sku}</span> &middot; ${item.vendor || 'Unknown'}<br>
                            <span class="sg-meta">${item.title || ''}</span>
                        </button>
                    `).join('');
                    suggestionsEl.style.display = 'block';
                    suggestionsEl.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', () => {
                            skuSearch.value = btn.dataset.sku;
                            suggestionsEl.style.display = 'none';
                            loadSkuDetail(btn.dataset.sku);
                        });
                    });
                } catch (e) {
                    suggestionsEl.style.display = 'none';
                }
            }, 400);
        });

        rangeSelect.addEventListener('change', () => {
            if (skuSearch.value.trim()) loadSkuDetail(skuSearch.value.trim());
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-row')) suggestionsEl.style.display = 'none';
        });

        /* ============================================================
           SKU Detail View
           ============================================================ */
        async function loadSkuDetail(sku) {
            const days = rangeSelect.value;
            try {
                const res = await fetch(`/pricing/sku?sku=${encodeURIComponent(sku)}&days=${days}`);
                const json = await res.json();
                if (!json.success || json.data?.error) {
                    skuDetail.innerHTML = `<div class="empty-state">${json.data?.error || 'SKU not found'}</div>`;
                    return;
                }
                renderSkuDetail(json.data);
            } catch (e) {
                skuDetail.innerHTML = '<div class="empty-state">Error loading SKU data.</div>';
            }
        }

        function buildSkuDetailHTML(d, svgId, tooltipId) {
            const gap = (d.current_price != null && d.cheapest_competitor_price != null)
                ? d.current_price - d.cheapest_competitor_price : null;
            const gapClass = gap != null ? (gap > 0 ? 'delta-negative' : gap < 0 ? 'delta-positive' : '') : '';

            const sales = d.sales_summary || {};

            let html = `
                <div style="margin-top:14px;">
                    <h3 style="font-family:'Space Grotesk',sans-serif; font-size:16px; font-weight:600;">${d.sku} &middot; ${d.title || 'Unknown Product'}</h3>
                    <p style="font-size:12.5px; color:var(--slate); margin-top:2px;">${d.vendor || 'Unknown vendor'} &middot; Snapshot ${d.pricing_date}${d.match_rule ? ' &middot; Rule: ' + d.match_rule : ''}</p>
                </div>
                <div class="sku-detail-grid">
                    <div class="sku-stat"><div class="ss-label">Our Price</div><div class="ss-value">${fmt(d.current_price)}</div></div>
                    <div class="sku-stat"><div class="ss-label">Lowest Competitor</div><div class="ss-value ${gapClass}">${fmt(d.cheapest_competitor_price)}</div></div>
                    <div class="sku-stat"><div class="ss-label">Minimum Floor</div><div class="ss-value">${fmt(d.minimum_price)}</div></div>
                    <div class="sku-stat"><div class="ss-label">Nett Cost</div><div class="ss-value">${fmt(d.nett_cost)}</div></div>
                    <div class="sku-stat"><div class="ss-label">RRP</div><div class="ss-value">${fmt(d.rrp)}</div></div>
                    <div class="sku-stat"><div class="ss-label">Min Margin</div><div class="ss-value">${d.min_margin_pct != null ? d.min_margin_pct.toFixed(1) + '%' : '\u2014'}</div></div>
                    <div class="sku-stat"><div class="ss-label">Units Sold (${sales.period_days || 30}d)</div><div class="ss-value">${sales.total_units ?? '\u2014'}</div></div>
                    <div class="sku-stat"><div class="ss-label">Revenue (${sales.period_days || 30}d)</div><div class="ss-value">${sales.total_revenue != null ? fmt(sales.total_revenue, 0) : '\u2014'}</div></div>
                </div>
            `;

            // Sub-grid: competitor table + chart
            html += '<div class="sku-sub-grid">';

            // Competitor table
            const sorted = [...(d.competitor_prices || [])].sort((a, b) => a.price - b.price);
            html += '<div>';
            html += '<div style="font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--slate); margin-bottom:8px;">Competitor Map</div>';
            html += '<table><thead><tr><th>Competitor</th><th class="num">Price</th><th class="num">Gap vs Us</th></tr></thead><tbody>';
            if (sorted.length) {
                const followNames = new Set((d.following_competitors || []).map(f => f.competitor));
                sorted.forEach(item => {
                    const g = d.current_price != null ? item.price - d.current_price : null;
                    const cls = g != null ? (g < 0 ? 'delta-negative' : g > 0 ? 'delta-positive' : '') : '';
                    const isFollowed = followNames.has(item.competitor);
                    const fStyle = isFollowed ? 'color:#c49a4a;font-weight:700;' : '';
                    const fStar = isFollowed ? ' \u2605' : '';
                    html += `<tr><td style="${fStyle}">${item.competitor}${fStar}</td><td class="num" style="${fStyle}">${fmt(item.price)}</td><td class="num ${cls}">${g != null ? (g >= 0 ? '+' : '') + g.toFixed(2) : '\u2014'}</td></tr>`;
                });
            } else {
                html += '<tr><td colspan="3" style="color:var(--slate);text-align:center;padding:16px 0;">No competitor prices</td></tr>';
            }
            html += '</tbody></table>';

            // Following pill
            const following = d.following_competitors || [];
            if (following.length) {
                html += `<div class="follow-pill">Following ${following.map(f => f.competitor).join(', ')}</div>`;
            }
            html += '</div>';

            // Price + Sales History chart
            html += '<div>';
            html += '<div style="font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--slate); margin-bottom:8px;">Price &amp; Sales History</div>';
            html += `<div class="chart-container"><div class="history-chart-wrap"><svg id="${svgId}" width="100%" height="220" viewBox="0 0 600 220" preserveAspectRatio="none"></svg></div><div class="chart-tooltip" id="${tooltipId}"></div></div>`;
            html += '<div class="history-legend">';
            html += '<span><span class="legend-dot" style="background:var(--cass-teal);"></span>Our price</span>';
            html += '<span><span class="legend-dot" style="background:var(--cass-gold);"></span>Lowest competitor</span>';
            html += '<span><span class="legend-dot" style="background:var(--ink);"></span>Floor price</span>';
            html += '<span><span class="legend-bar" style="background:rgba(31,111,107,0.25);"></span>Units sold</span>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // close sku-sub-grid

            // ââ Flags: Do Not Follow, Set Price ââ
            const flags = [];
            if (d.do_not_follow) flags.push('<span class="sku-flag warn">Do Not Follow</span>');
            if (d.set_price != null) flags.push(`<span class="sku-flag info">Set Price: ${fmt(d.set_price)}</span>`);
            if (flags.length) {
                html += `<div class="sku-flags">${flags.join('')}</div>`;
            }

            // ââ Cost & Discount Breakdown (collapsible) ââ
            const cb = d.cost_breakdown;
            if (cb) {
                const costItems = [
                    ['Invoice Price', cb.invoice_price_inc_gst, '$'],
                    ['Special Cost', cb.special_cost_inc_gst, '$'],
                    ['Nett Nett Cost', cb.nett_nett_cost_inc_gst, '$'],
                ];
                const discountItems = [
                    ['Discount', cb.discount, '%'],
                    ['Additional Discount', cb.additional_discount, '%'],
                    ['Extra Discount', cb.extra_discount, '%'],
                    ['Rebate', cb.rebate, '%'],
                    ['Extra', cb.extra, '%'],
                    ['Settlement', cb.settlement, '%'],
                    ['CRF', cb.crf, '%'],
                    ['Loyalty', cb.loyalty, '%'],
                    ['Advertising', cb.advertising, '%'],
                    ['Timed Settlement', cb.timed_settlement_fee, '%'],
                    ['Other', cb.other, '%'],
                ];
                // Only show items that have a value
                const hasCosts = costItems.some(i => i[1] != null);
                const hasDiscounts = discountItems.some(i => i[1] != null && i[1] !== 0);
                const hasSpecialDate = cb.special_end_date != null;

                if (hasCosts || hasDiscounts) {
                    const uid = 'costSection_' + Math.random().toString(36).slice(2,8);
                    html += `<div class="cost-section">`;
                    html += `<div class="cost-header" onclick="this.classList.toggle('open');document.getElementById('${uid}').classList.toggle('open')">`;
                    html += `Cost & Discount Breakdown <span class="chevron">&#9662;</span></div>`;
                    html += `<div class="cost-body" id="${uid}">`;

                    // Cost prices row
                    if (hasCosts) {
                        html += '<div class="cost-grid">';
                        costItems.forEach(([label, val, type]) => {
                            if (val != null) {
                                const display = type === '$' ? fmt(val) : val.toFixed(2) + '%';
                                html += `<div class="cost-item"><span class="ci-label">${label}</span><span class="ci-value">${display}</span></div>`;
                            }
                        });
                        if (hasSpecialDate) {
                            html += `<div class="cost-item"><span class="ci-label">Special Ends</span><span class="ci-value">${cb.special_end_date}</span></div>`;
                        }
                        html += '</div>';
                    }

                    // Discount breakdown
                    if (hasDiscounts) {
                        if (hasCosts) html += '<div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px;"></div>';
                        html += '<div class="cost-grid">';
                        discountItems.forEach(([label, val, type]) => {
                            if (val != null && val !== 0) {
                                const display = type === '%' ? val.toFixed(2) + '%' : fmt(val);
                                html += `<div class="cost-item"><span class="ci-label">${label}</span><span class="ci-value pct">${display}</span></div>`;
                            }
                        });
                        html += '</div>';
                    }

                    html += '</div></div>'; // close cost-body + cost-section
                }
            }

            // ââ Comments ââ
            if (d.comments) {
                html += `<div style="margin-top:14px; font-size:12.5px; color:var(--slate); padding:10px 14px; background:#faf8f4; border-radius:10px; border:1px solid var(--line);"><strong>Notes:</strong> ${d.comments}</div>`;
            }

            return html;
        }

        function renderSkuDetail(d) {
            skuDetail.innerHTML = buildSkuDetailHTML(d, 'historyChart', 'chartTooltip');
            renderHistoryChart(d.history || []);
        }

        /* ============================================================
           Price + Sales History SVG Chart with Hover Tooltips
           ============================================================ */
        function renderHistoryChart(history, svgId, tooltipId) {
            const svg = document.getElementById(svgId || 'historyChart');
            const tooltip = document.getElementById(tooltipId || 'chartTooltip');
            if (!svg) return;
            svg.innerHTML = '';

            if (!history.length) {
                svg.innerHTML = '<text x="300" y="110" fill="#6b6670" text-anchor="middle" font-size="13">No history available</text>';
                return;
            }

            const W = 600, H = 220;
            const PRICE_TOP = 0, PRICE_BOTTOM = 160;
            const BAR_TOP = 170, BAR_BOTTOM = 215;
            const priceH = PRICE_BOTTOM - PRICE_TOP;
            const barH = BAR_BOTTOM - BAR_TOP;

            const step = W / Math.max(history.length - 1, 1);

            // Price scale
            const priceVals = history.flatMap(r => [r.our_price, r.lowest_competitor, r.minimum_price]).filter(v => v != null);
            if (!priceVals.length) return;
            const pMin = Math.min(...priceVals);
            const pMax = Math.max(...priceVals);
            const pPad = (pMax - pMin) * 0.12 || 1;
            const scaleMin = pMin - pPad;
            const scaleMax = pMax + pPad;

            // Sales scale
            const maxUnits = Math.max(...history.map(r => r.units_sold || 0), 1);

            function toY(v) {
                return v == null ? null : PRICE_TOP + priceH - ((v - scaleMin) / (scaleMax - scaleMin)) * priceH;
            }

            function toBarH(units) {
                return (units / maxUnits) * barH;
            }

            let svgContent = '';

            // Separator line
            svgContent += `<line x1="0" y1="${PRICE_BOTTOM + 4}" x2="${W}" y2="${PRICE_BOTTOM + 4}" stroke="#e8e4dc" stroke-width="0.5"/>`;

            // Sales bars
            const barWidth = Math.max(step * 0.5, 4);
            history.forEach((r, i) => {
                const units = r.units_sold || 0;
                if (units === 0) return;
                const bh = toBarH(units);
                const x = i * step - barWidth / 2;
                const y = BAR_BOTTOM - bh;
                svgContent += `<rect x="${x}" y="${y}" width="${barWidth}" height="${bh}" rx="2" fill="rgba(31,111,107,0.25)"/>`;
            });

            // Price lines
            function makePath(key, color, width, opacity) {
                const pts = [];
                history.forEach((r, i) => {
                    const y = toY(r[key]);
                    if (y != null) pts.push(`${pts.length === 0 ? 'M' : 'L'} ${i * step} ${y}`);
                });
                if (pts.length) {
                    svgContent += `<path d="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="${width}" opacity="${opacity}"/>`;
                }
            }

            makePath('minimum_price', '#1c1b1f', 1.5, 0.3);
            makePath('lowest_competitor', '#c49a4a', 2, 0.8);
            makePath('our_price', '#1f6f6b', 2.5, 1);

            // Sale dots
            history.forEach((r, i) => {
                if ((r.units_sold || 0) > 0 && r.our_price != null) {
                    const y = toY(r.our_price);
                    svgContent += `<circle cx="${i * step}" cy="${y}" r="3.5" fill="#1f6f6b" stroke="#fff" stroke-width="1.5"/>`;
                }
            });

            // Hover targets
            history.forEach((r, i) => {
                const x = i * step - step / 2;
                const w = step;
                svgContent += `<rect class="hover-target" data-idx="${i}" x="${Math.max(x, 0)}" y="0" width="${Math.min(w, W)}" height="${H}" fill="transparent" style="cursor:crosshair"/>`;
            });

            // Crosshair
            svgContent += `<line id="crosshair" x1="0" y1="0" x2="0" y2="${H}" stroke="var(--cass-gold)" stroke-width="1" stroke-dasharray="3,3" opacity="0"/>`;

            svg.innerHTML = svgContent;

            // Hover interaction
            const crosshair = svg.querySelector('#crosshair');
            const container = svg.closest('.chart-container');

            svg.querySelectorAll('.hover-target').forEach(rect => {
                rect.addEventListener('mouseenter', (e) => {
                    const idx = parseInt(rect.dataset.idx);
                    const r = history[idx];
                    const cx = idx * step;

                    crosshair.setAttribute('x1', cx);
                    crosshair.setAttribute('x2', cx);
                    crosshair.setAttribute('opacity', '0.6');

                    let ttHtml = `<div class="tt-date">${r.date}</div>`;
                    if (r.our_price != null) ttHtml += `<div class="tt-row"><span class="tt-label">Our price</span><span class="tt-val">${fmt(r.our_price)}</span></div>`;
                    if (r.lowest_competitor != null) {
                        ttHtml += `<div class="tt-row"><span class="tt-label" style="color:#c49a4a;font-weight:700;">${r.lowest_competitor_name || 'Lowest'} \u2605</span><span class="tt-val" style="color:#c49a4a;font-weight:700;">${fmt(r.lowest_competitor)}</span></div>`;
                    }
                    if (r.minimum_price != null) ttHtml += `<div class="tt-row"><span class="tt-label">Floor</span><span class="tt-val">${fmt(r.minimum_price)}</span></div>`;

                    if (r.competitors && r.competitors.length) {
                        const others = r.competitors.filter(c =>
                            !r.lowest_competitor_name || c.competitor !== r.lowest_competitor_name
                        ).slice(0, 4);
                        others.forEach(c => {
                            ttHtml += `<div class="tt-row"><span class="tt-label">${c.competitor}</span><span class="tt-val">${fmt(c.price)}</span></div>`;
                        });
                    }

                    ttHtml += `<div class="tt-sales">`;
                    ttHtml += `<div class="tt-row"><span class="tt-label">Units sold</span><span class="tt-val">${r.units_sold || 0}</span></div>`;
                    if (r.day_revenue) ttHtml += `<div class="tt-row"><span class="tt-label">Revenue</span><span class="tt-val">${fmt(r.day_revenue, 0)}</span></div>`;
                    ttHtml += `</div>`;

                    tooltip.innerHTML = ttHtml;
                    tooltip.classList.add('visible');

                    const containerRect = container.getBoundingClientRect();
                    const svgRect = svg.getBoundingClientRect();
                    const mouseXInContainer = (cx / W) * svgRect.width + (svgRect.left - containerRect.left);
                    const ttWidth = tooltip.offsetWidth;

                    let left = mouseXInContainer + 14;
                    if (left + ttWidth > containerRect.width - 10) {
                        left = mouseXInContainer - ttWidth - 14;
                    }
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = '8px';
                });

                rect.addEventListener('mouseleave', () => {
                    crosshair.setAttribute('opacity', '0');
                    tooltip.classList.remove('visible');
                });
            });
        }

        /* ============================================================
           Init
           ============================================================ */
        loadOverview();
        loadBrandList();
    </script>

<!-- Invite User Modal -->
<div id="invite-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:16px;padding:32px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.15)">
        <h3 style="font-family:'Space Grotesk',sans-serif;margin-bottom:8px">Invite User</h3>
        <p style="color:#6b6670;font-size:14px;margin-bottom:20px">Send an invite email to create a new account</p>
        <div id="invite-error" style="background:#fef2f2;color:#dc2626;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
        <div id="invite-success" style="background:#f0fdf4;color:#16a34a;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
        <input type="email" id="invite-email" placeholder="email@example.com" style="width:100%;padding:12px 14px;border:1px solid rgba(27,27,27,0.08);border-radius:10px;font-size:14px;font-family:'IBM Plex Sans',sans-serif;margin-bottom:16px;outline:none;background:#faf9f6">
        <div style="display:flex;gap:12px">
            <button onclick="closeInviteModal()" style="flex:1;padding:12px;border:1px solid rgba(27,27,27,0.08);border-radius:10px;background:#fff;font-size:14px;font-family:'Space Grotesk',sans-serif;cursor:pointer">Cancel</button>
            <button id="send-invite-btn" onclick="sendInvite()" style="flex:1;padding:12px;background:#1b1b1b;color:#f7f1e8;border:none;border-radius:10px;font-size:14px;font-weight:600;font-family:'Space Grotesk',sans-serif;cursor:pointer">Send Invite</button>
        </div>
    </div>
</div>
<script>
function openInviteModal(){
    var m=document.getElementById('invite-modal');m.style.display='flex';
    document.getElementById('invite-email').value='';
    document.getElementById('invite-error').style.display='none';
    document.getElementById('invite-success').style.display='none';
    document.getElementById('invite-email').focus();
}
function closeInviteModal(){document.getElementById('invite-modal').style.display='none'}
async function sendInvite(){
    var btn=document.getElementById('send-invite-btn');
    var email=document.getElementById('invite-email').value.trim();
    var errEl=document.getElementById('invite-error');
    var okEl=document.getElementById('invite-success');
    errEl.style.display='none';okEl.style.display='none';
    if(!email){errEl.textContent='Please enter an email address';errEl.style.display='block';return}
    btn.disabled=true;btn.textContent='Sending...';
    try{
        var r=await fetch('/auth/invite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email})});
        var d=await r.json();
        if(r.ok){okEl.textContent='Invite sent to '+email;okEl.style.display='block';document.getElementById('invite-email').value=''}
        else{errEl.textContent=d.detail||'Failed to send invite';errEl.style.display='block'}
    }catch(e){errEl.textContent='Network error';errEl.style.display='block'}
    btn.disabled=false;btn.textContent='Send Invite';
}
document.getElementById('invite-modal').addEventListener('click',function(e){if(e.target===this)closeInviteModal()});
</script>
</body>
</html>
