<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Intelligence - Cass Brothers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');
        :root {
            --ink: #1c1b1f; --ink-soft: #3d3a40; --slate: #6b6670;
            --stone: #f4f2ee; --pearl: #faf9f6;
            --cass-black: #1b1b1b; --cass-cream: #f7f3ed;
            --cass-gold: #c49a4a; --cass-moss: #2f3d33; --cass-teal: #1f6f6b;
            --card: #ffffff; --line: rgba(27,27,27,0.08);
            --shadow: 0 18px 45px rgba(17,18,19,0.08);
            --green: #16a34a; --red: #dc2626; --amber: #d97706;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: "IBM Plex Sans", sans-serif; background: radial-gradient(circle at top left, #fdfbf7 0%, var(--cass-cream) 45%, #f1ede6 100%); color: var(--ink); min-height: 100vh; }

        /* ── Layout ── */
        .app-shell {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }
        .brand-bar { grid-column: 1 / -1; display: flex; align-items: center; padding: 16px 28px; background: var(--cass-black); color: #f7f1e8; position: sticky; top: 0; z-index: 100; }
        .brand-mark { display: flex; align-items: center; gap: 12px; font-family: "Space Grotesk", sans-serif; }
        .brand-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--cass-gold); }
        .side-nav {
            grid-row: 2; padding: 28px 20px;
            border-right: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.4) 100%);
        }
        .side-nav h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--slate); margin-bottom: 12px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 12px; font-size: 14px;
            color: var(--ink-soft); margin-bottom: 6px; cursor: pointer;
            transition: all 0.2s ease; text-decoration: none;
        }
        .nav-item:hover { background: rgba(27,27,27,0.04); }
        .nav-item.active { background: var(--cass-black); color: #f7f1e8; box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .nav-item span { width: 8px; height: 8px; border-radius: 50%; background: var(--cass-gold); opacity: 0.7; }
        .nav-item.active span { opacity: 1; }
        .main-area { grid-row: 2; padding: 28px 32px 32px; overflow-y: auto; }

        /* ── Alert Banner ── */
        .alert-banner { padding: 12px 28px; display: flex; align-items: center; justify-content: space-between; gap: 16px; font-size: 13px; font-weight: 500; }
        .alert-banner.severity-high { background: #fef2f2; color: #991b1b; border-bottom: 2px solid var(--red); }
        .alert-banner.severity-medium { background: #fffbeb; color: #92400e; border-bottom: 2px solid var(--amber); }
        .alert-banner .dismiss-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: inherit; opacity: 0.6; padding: 4px 8px; }
        .alert-banner .dismiss-btn:hover { opacity: 1; }

        /* ── Layout ── */
        .container { max-width: 1400px; margin: 0 auto; padding: 24px 28px; }
        .page-title { font-family: "Space Grotesk", sans-serif; font-size: 28px; font-weight: 600; margin-bottom: 8px; }
        .page-subtitle { color: var(--slate); margin-bottom: 24px; font-size: 14px; }
        .section-gap { margin-bottom: 24px; }

        /* ── KPI Row ── */
        .kpi-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--line); }
        .kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--slate); margin-bottom: 8px; }
        .kpi-value { font-family: "Space Grotesk", sans-serif; font-size: 26px; font-weight: 600; }
        .kpi-sub { font-size: 12px; color: var(--slate); margin-top: 4px; }

        /* ── Cards ── */
        .card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--line); margin-bottom: 24px; }
        .card-title { font-family: "Space Grotesk", sans-serif; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .card-title .badge { font-size: 11px; padding: 2px 10px; border-radius: 99px; font-weight: 500; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .chart-container { position: relative; height: 320px; }
        .chart-container-sm { position: relative; height: 250px; }

        /* ── Health Score Circles ── */
        .health-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px; }
        .health-item { text-align: center; }
        .health-circle { position: relative; width: 90px; height: 90px; margin: 0 auto 8px; }
        .health-circle svg { transform: rotate(-90deg); }
        .health-circle .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .health-circle .score-num { font-family: "Space Grotesk", sans-serif; font-size: 22px; font-weight: 700; display: block; line-height: 1; }
        .health-circle .score-grade { font-size: 11px; font-weight: 600; color: var(--slate); }
        .health-name { font-size: 12px; color: var(--ink-soft); font-weight: 500; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: 0 auto; }

        /* ── Google vs Reality ── */
        .gvr-summary { padding: 20px; background: #fef3c7; border-radius: 10px; display: flex; flex-direction: column; gap: 12px; justify-content: center; }
        .gvr-stat { font-family: "Space Grotesk", sans-serif; }
        .gvr-stat .label { font-size: 12px; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; }
        .gvr-stat .value { font-size: 24px; font-weight: 700; color: #78350f; }
        .gvr-stat .value.danger { color: var(--red); }

        /* ── Campaign Scorecards ── */
        .scorecard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
        .scorecard { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--line); border-left: 4px solid var(--slate); }
        .scorecard.profitable { border-left-color: var(--green); }
        .scorecard.marginal { border-left-color: var(--amber); }
        .scorecard.losing { border-left-color: var(--red); }
        .scorecard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .scorecard-name { font-weight: 600; font-size: 14px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }
        .scorecard-health { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: "Space Grotesk", sans-serif; font-weight: 700; font-size: 12px; color: #fff; flex-shrink: 0; }
        .scorecard-badge { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 500; flex-shrink: 0; }
        .badge-profitable { background: #dcfce7; color: #166534; }
        .badge-marginal { background: #fef3c7; color: #92400e; }
        .badge-losing { background: #fee2e2; color: #991b1b; }
        .badge-paused { background: #f3f4f6; color: #6b7280; }
        .scorecard-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .scorecard-metric { text-align: center; }
        .scorecard-metric-label { font-size: 10px; text-transform: uppercase; color: var(--slate); letter-spacing: 0.5px; }
        .scorecard-metric-value { font-family: "Space Grotesk", sans-serif; font-size: 15px; font-weight: 600; }
        .be-indicator { height: 4px; border-radius: 2px; margin-top: 10px; }
        .be-indicator.above { background: linear-gradient(90deg, var(--green), #22c55e); }
        .be-indicator.below { background: linear-gradient(90deg, var(--red), #f87171); }
        .trend-arrows { display: flex; gap: 12px; margin-top: 8px; font-size: 11px; color: var(--slate); }
        .trend-arrows .up { color: var(--green); }
        .trend-arrows .down { color: var(--red); }
        .trend-arrows .flat { color: var(--slate); }
        .scorecard-footer { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line); font-size: 12px; color: var(--slate); }
        .scorecard-footer .action { font-weight: 600; color: var(--ink); text-transform: capitalize; }
        .scorecard-footer .action.investigate { color: #7c3aed; }

        /* ── Strategy Layer ── */
        .strategy-chip { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-weight: 700; letter-spacing: 0.5px; flex-shrink: 0; margin-left: 4px; }
        .strategy-chip.s-high_consideration { background: #f3e8ff; color: #7c3aed; }
        .strategy-chip.s-fast_turn { background: #ccfbf1; color: #0f766e; }
        .strategy-chip.s-brand_defense { background: #dbeafe; color: #1d4ed8; }
        .strategy-chip.s-prospecting { background: #ffedd5; color: #c2410c; }
        .strategy-chip.s-unknown { background: #f3f4f6; color: #6b7280; }
        .dual-badges { display: flex; gap: 4px; flex-shrink: 0; }
        .sts-badge, .sv-badge { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-weight: 600; }
        .sts-badge.sts-strong { background: #dcfce7; color: #166534; }
        .sts-badge.sts-healthy { background: #d1fae5; color: #065f46; }
        .sts-badge.sts-marginal { background: #fef3c7; color: #92400e; }
        .sts-badge.sts-weak { background: #fee2e2; color: #991b1b; }
        .sv-badge.sv-high { background: #dbeafe; color: #1d4ed8; }
        .sv-badge.sv-moderate { background: #fef3c7; color: #92400e; }
        .sv-badge.sv-low { background: #f3f4f6; color: #6b7280; }
        .why-now { font-size: 11px; font-style: italic; color: var(--slate); margin-top: 8px; line-height: 1.3; }
        .decision-score { font-family: "Space Grotesk", sans-serif; font-size: 11px; font-weight: 700; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; }
        .scorecard.scale { border-left-color: var(--green); }
        .scorecard.maintain { border-left-color: #3b82f6; }
        .scorecard.optimize { border-left-color: var(--amber); }
        .scorecard.investigate { border-left-color: #7c3aed; }
        .scorecard.reduce { border-left-color: var(--red); }
        .scorecard.pause { border-left-color: #6b7280; }

        /* ── Break-Even ── */
        .break-even-chart { position: relative; min-height: 300px; }

        /* ── Concentration ── */
        .concentration-layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; align-items: center; }
        .concentration-kpis { display: flex; flex-direction: column; gap: 16px; }
        .concentration-kpi { text-align: center; }
        .concentration-kpi .label { font-size: 11px; text-transform: uppercase; color: var(--slate); letter-spacing: 0.5px; }
        .concentration-kpi .value { font-family: "Space Grotesk", sans-serif; font-size: 28px; font-weight: 700; }
        .risk-badge { display: inline-block; padding: 3px 12px; border-radius: 99px; font-size: 12px; font-weight: 600; }
        .risk-low { background: #dcfce7; color: #166534; }
        .risk-moderate { background: #fef3c7; color: #92400e; }
        .risk-high { background: #fee2e2; color: #991b1b; }

        /* ── Type Comparison Table ── */
        .type-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .type-table th { text-align: left; padding: 10px 12px; border-bottom: 2px solid var(--line); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate); font-weight: 600; }
        .type-table td { padding: 10px 12px; border-bottom: 1px solid var(--line); }
        .type-table tr:last-child td { border-bottom: none; }
        .type-table .winner { background: #f0fdf4; }
        .type-table .type-name { font-weight: 600; font-family: "Space Grotesk", sans-serif; }
        .type-callout { margin-top: 16px; padding: 12px 16px; background: #f0fdf4; border-radius: 8px; border-left: 3px solid var(--green); font-size: 13px; }

        /* ── Diminishing Returns ── */
        .dr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .dr-card { background: var(--stone); border-radius: 10px; padding: 16px; }
        .dr-card-title { font-weight: 600; font-size: 13px; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dr-callout { font-size: 12px; margin-top: 8px; padding: 8px; border-radius: 6px; }
        .dr-callout.overspend { background: #fee2e2; color: #991b1b; }
        .dr-callout.optimal { background: #dcfce7; color: #166534; }

        /* ── Competitor Pressure ── */
        .cp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .cp-card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--line); }
        .cp-name { font-weight: 600; font-size: 14px; margin-bottom: 10px; }
        .cp-gauge { height: 10px; border-radius: 5px; background: #f3f4f6; overflow: hidden; margin-bottom: 10px; }
        .cp-gauge-fill { height: 100%; border-radius: 5px; transition: width .3s; }
        .cp-type { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .cp-detail { font-size: 12px; color: var(--ink-soft); margin-bottom: 4px; }
        .cp-detail .change { font-weight: 600; }
        .cp-interp { font-size: 12px; color: var(--slate); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--line); font-style: italic; }

        /* ── Impression Share bars ── */
        .is-bar-container { margin-bottom: 16px; }
        .is-bar-label { font-size: 13px; font-weight: 500; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .is-bar-track { height: 24px; background: #f3f4f6; border-radius: 4px; display: flex; overflow: hidden; }
        .is-bar-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff; font-weight: 500; min-width: 2px; }
        .is-won { background: var(--cass-teal); }
        .is-budget-lost { background: var(--amber); }
        .is-rank-lost { background: var(--red); opacity: 0.7; }

        /* ── Waste & Actions ── */
        .waste-list { list-style: none; }
        .waste-item { padding: 14px 0; border-bottom: 1px solid var(--line); }
        .waste-item:last-child { border-bottom: none; }
        .waste-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .waste-item-name { font-weight: 600; font-size: 13px; }
        .waste-item-amount { font-family: "Space Grotesk", sans-serif; font-weight: 700; color: var(--red); font-size: 14px; }
        .waste-item-desc { font-size: 12px; color: var(--slate); margin-bottom: 4px; }
        .waste-item-fix { font-size: 12px; color: var(--cass-teal); font-weight: 500; }
        .severity-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        .realloc-item { padding: 14px 0; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 12px; }
        .realloc-item:last-child { border-bottom: none; }
        .realloc-arrow { font-size: 18px; color: var(--cass-gold); flex-shrink: 0; }
        .realloc-from, .realloc-to { flex: 1; }
        .realloc-label { font-size: 10px; text-transform: uppercase; color: var(--slate); letter-spacing: 0.5px; }
        .realloc-name { font-size: 13px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .realloc-amount { font-family: "Space Grotesk", sans-serif; font-size: 13px; font-weight: 600; }
        .realloc-profit { font-size: 12px; color: var(--green); font-weight: 500; text-align: center; }

        .qw-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; margin-top: 16px; }
        .qw-card { background: var(--stone); border-radius: 10px; padding: 14px; }
        .qw-type { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate); font-weight: 600; margin-bottom: 4px; }
        .qw-desc { font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .qw-action { font-size: 12px; color: var(--cass-teal); font-weight: 500; }
        .qw-meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--slate); }
        .qw-savings { color: var(--green); font-weight: 600; }
        .qw-effort { text-transform: capitalize; }

        /* ── Products ── */
        .product-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--line); gap: 8px; }
        .product-row:last-child { border-bottom: none; }
        .product-title { font-size: 13px; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
        .product-stats { display: flex; gap: 16px; flex-shrink: 0; font-size: 12px; text-align: right; }
        .product-stats span { min-width: 60px; }
        .product-action { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }

        /* ── Forecast ── */
        .forecast-meta { display: flex; gap: 20px; margin-bottom: 12px; }
        .forecast-tag { font-size: 12px; padding: 4px 12px; border-radius: 99px; font-weight: 500; }

        /* ── Loading ── */
        .loading { text-align: center; padding: 40px; color: var(--slate); }
        .section-empty { text-align: center; padding: 24px; color: var(--slate); font-size: 13px; }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .app-shell { grid-template-columns: 1fr; }
            .side-nav { display: flex; gap: 8px; overflow-x: auto; padding: 12px 16px; border-right: none; border-bottom: 1px solid var(--line); }
            .side-nav h2 { display: none; }
            .nav-item { white-space: nowrap; font-size: 13px; padding: 8px 12px; margin-bottom: 0; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .two-col, .three-col { grid-template-columns: 1fr; }
            .scorecard-grid { grid-template-columns: 1fr; }
            .concentration-layout { grid-template-columns: 1fr; }
            .health-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
            .cp-grid { grid-template-columns: 1fr; }
            .dr-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-shell">
    <!-- Nav -->
    <div class="brand-bar">
        <div class="brand-mark">
            <div class="brand-dot"></div>
            <span style="font-size:18px;font-weight:600">Cass Brothers</span>
            <span style="opacity:0.5;font-size:13px;margin-left:8px">Ads Intelligence</span>
        </div>
    </div>

    <nav class="side-nav">
        <h2>Dashboards</h2>
        <a class="nav-item" href="/dashboard"><span></span> Overview</a>
        <a class="nav-item" href="/performance"><span></span> Performance</a>
        <a class="nav-item" href="/seo-dashboard"><span></span> SEO &amp; Content</a>
        <a class="nav-item active" href="/ads-intelligence"><span></span> Ads Intelligence</a>
        <a class="nav-item" href="/finance-dashboard"><span></span> Finance</a>
        <a class="nav-item" href="/inventory"><span></span> Inventory</a>
        <a class="nav-item" href="/pricing-intel"><span></span> Pricing Intel</a>
        <a class="nav-item" href="/customer-intelligence"><span></span> Customer Intel</a>
        <a class="nav-item" href="/merchant-center-intel"><span></span> Merchant Center</a>
        <a class="nav-item" href="/strategic-intelligence"><span></span> Intelligence Brief</a>
        <a class="nav-item" href="/site-intelligence"><span></span> Site Intelligence</a>
        <a class="nav-item" href="/brand-intelligence"><span></span> Brand Intelligence</a>
        <div style="border-top:1px solid rgba(27,27,27,0.08);margin-top:16px;padding-top:12px">
            <a class="nav-item" href="#" onclick="fetch('/auth/logout',{method:'POST'}).then(()=>location.href='/auth/login');return false" style="opacity:0.6"><span></span> Logout</a>
        </div>
    </nav>

    <main class="main-area">
    <!-- 1. Alert Banner -->
    <div id="alert-banner"></div>

    <div class="container">
        <h1 class="page-title">Ads Intelligence</h1>
        <p class="page-subtitle">Campaign performance, profitability, and optimization opportunities — last 30 days</p>
        <div id="data-as-of" style="font-size:11px;color:var(--slate);margin-top:-4px;margin-bottom:8px"></div>

        <!-- 2. KPI Row -->
        <div class="kpi-grid" id="kpi-grid">
            <div class="loading" style="grid-column:1/-1">Loading dashboard...</div>
        </div>

        <!-- 3. Campaign Health Scores -->
        <div class="card section-gap" id="health-section">
            <div class="card-title">Campaign Health Scores</div>
            <div class="health-grid" id="health-grid"><div class="loading">Loading...</div></div>
        </div>

        <!-- 4. Google vs Reality -->
        <div class="two-col section-gap" id="gvr-section">
            <div class="card" style="margin-bottom:0">
                <div class="card-title">Google vs Reality</div>
                <div id="gvr-summary"><div class="loading">Loading...</div></div>
            </div>
            <div class="card" style="margin-bottom:0">
                <div class="card-title">ROAS Comparison by Campaign</div>
                <div class="chart-container"><canvas id="gvrChart"></canvas></div>
            </div>
        </div>

        <!-- 5. Weekly Trends -->
        <div class="two-col section-gap">
            <div class="card" style="margin-bottom:0">
                <div class="card-title">Weekly Spend &amp; Conversions</div>
                <div class="chart-container"><canvas id="trendChart1"></canvas></div>
            </div>
            <div class="card" style="margin-bottom:0">
                <div class="card-title">ROAS &amp; CPC Trend</div>
                <div class="chart-container"><canvas id="trendChart2"></canvas></div>
            </div>
        </div>

        <!-- 6. Campaign Scorecards -->
        <div class="card section-gap">
            <div class="card-title">Campaign Scorecards</div>
            <div class="scorecard-grid" id="scorecards"><div class="loading">Loading campaigns...</div></div>
        </div>

        <!-- 7. Break-Even Analysis -->
        <div class="card section-gap">
            <div class="card-title">Break-Even Analysis</div>
            <div class="break-even-chart" id="break-even-wrap"><canvas id="breakEvenChart"></canvas></div>
        </div>

        <!-- 8. Revenue Concentration -->
        <div class="card section-gap">
            <div class="card-title">Revenue Concentration</div>
            <div class="concentration-layout" id="concentration-layout">
                <div class="concentration-kpis" id="concentration-kpis"><div class="loading">Loading...</div></div>
                <div style="position:relative;max-width:360px;margin:0 auto"><canvas id="concentrationChart"></canvas></div>
            </div>
        </div>

        <!-- 9. Campaign Type Comparison -->
        <div class="card section-gap">
            <div class="card-title">Campaign Type Comparison</div>
            <div id="type-comparison"><div class="loading">Loading...</div></div>
        </div>

        <!-- 10. Diminishing Returns -->
        <div class="card section-gap">
            <div class="card-title">Diminishing Returns Analysis</div>
            <div class="dr-grid" id="diminishing-returns"><div class="loading">Loading...</div></div>
        </div>

        <!-- 11. Competitor Pressure -->
        <div class="card section-gap">
            <div class="card-title">Competitor Pressure</div>
            <div class="cp-grid" id="competitor-pressure"><div class="loading">Loading...</div></div>
        </div>

        <!-- 12. Impression Share -->
        <div class="card section-gap">
            <div class="card-title">Impression Share Analysis</div>
            <div id="impression-share"><div class="loading">Loading impression share data...</div></div>
        </div>

        <!-- 13. Waste & Budget Actions -->
        <div class="card section-gap">
            <div class="card-title">Waste &amp; Budget Actions</div>
            <div class="two-col" style="margin-bottom:0">
                <div>
                    <h3 style="font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:600;margin-bottom:12px;color:var(--red)">Waste Identified</h3>
                    <ul class="waste-list" id="waste-list"><li class="loading">Loading...</li></ul>
                </div>
                <div>
                    <h3 style="font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:600;margin-bottom:12px;color:var(--cass-teal)">Budget Reallocation</h3>
                    <div id="realloc-list"><div class="loading">Loading...</div></div>
                </div>
            </div>
            <div>
                <h3 style="font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--cass-gold)">Quick Wins</h3>
                <div class="qw-grid" id="quick-wins"></div>
            </div>
        </div>

        <!-- 14. Product Performance -->
        <div class="two-col section-gap">
            <div class="card" style="margin-bottom:0">
                <div class="card-title" style="color:var(--green)">Top Products to Scale</div>
                <div id="products-scale"><div class="loading">Loading...</div></div>
            </div>
            <div class="card" style="margin-bottom:0">
                <div class="card-title" style="color:var(--red)">Products to Exclude</div>
                <div id="products-exclude"><div class="loading">Loading...</div></div>
            </div>
        </div>

        <!-- 15. Forecast -->
        <div class="card section-gap">
            <div class="card-title">Revenue &amp; Spend Forecast</div>
            <div class="forecast-meta" id="forecast-meta"></div>
            <div class="chart-container"><canvas id="forecastChart"></canvas></div>
        </div>
    </div>

    <script>
        /* ================================================================
           CASS BROTHERS — ADS INTELLIGENCE DASHBOARD
           15-section analytics dashboard
           ================================================================ */

        const API = '';
        let trendChart1, trendChart2, breakEvenChart, concentrationChart, forecastChart, googleVsRealityChart;

        /* ── Helpers ── */
        function fmt(n) {
            if (n == null) return '--';
            return '$' + Math.round(n).toLocaleString();
        }
        function fmtK(n) {
            if (n == null) return '--';
            const abs = Math.abs(n);
            if (abs >= 1000) return (n < 0 ? '-' : '') + '$' + (abs / 1000).toFixed(1) + 'k';
            return '$' + Math.round(n).toLocaleString();
        }
        function fmtRoas(n) {
            if (n == null) return '--';
            return n.toFixed(2) + 'x';
        }
        function fmtPct(n) {
            if (n == null) return '--';
            return n.toFixed(1) + '%';
        }
        function fmtMoney(n) {
            if (n == null) return '--';
            const abs = Math.abs(n);
            if (abs >= 1000000) return (n < 0 ? '-' : '') + '$' + (abs / 1000000).toFixed(1) + 'M';
            if (abs >= 1000) return (n < 0 ? '-' : '') + '$' + (abs / 1000).toFixed(1) + 'k';
            return '$' + Math.round(n).toLocaleString();
        }
        function parseMoney(v) {
            if (v == null) return null;
            if (typeof v === 'number') return Number.isFinite(v) ? v : null;
            const cleaned = String(v).replace(/[^0-9.-]/g, '');
            const parsed = parseFloat(cleaned);
            return Number.isFinite(parsed) ? parsed : null;
        }
        function trendArrow(trend) {
            if (trend == null) return '<span class="flat">--</span>';
            if (typeof trend === 'string') {
                if (trend === 'up' || trend === 'increasing' || trend === 'rising' || trend === 'growing') return '<span class="up">&#9650;</span>';
                if (trend === 'down' || trend === 'decreasing' || trend === 'falling' || trend === 'declining') return '<span class="down">&#9660;</span>';
                return '<span class="flat">&#9654;</span>';
            }
            if (trend > 0.02) return '<span class="up">&#9650; +' + (trend * 100).toFixed(1) + '%</span>';
            if (trend < -0.02) return '<span class="down">&#9660; ' + (trend * 100).toFixed(1) + '%</span>';
            return '<span class="flat">&#9654; flat</span>';
        }
        function truncate(s, len) {
            if (!s) return '--';
            return s.length > len ? s.substring(0, len) + '...' : s;
        }
        function healthColor(score) {
            if (score >= 70) return 'var(--green)';
            if (score >= 40) return 'var(--amber)';
            return 'var(--red)';
        }
        function severityColor(severity) {
            if (severity === 'high' || severity === 'critical') return 'var(--red)';
            if (severity === 'medium') return 'var(--amber)';
            return 'var(--cass-gold)';
        }

        /* ── Chart.js Defaults ── */
        Chart.defaults.font.family = '"IBM Plex Sans", sans-serif';
        Chart.defaults.font.size = 11;
        Chart.defaults.color = '#6b6670';

        /* ================================================================
           SECTION RENDERERS
           ================================================================ */

        /* ── 1. Alert Banner ── */
        function renderAlertBanner(anomalies) {
            const el = document.getElementById('alert-banner');
            if (!anomalies?.length) { el.innerHTML = ''; return; }

            const highSev = anomalies.some(a => a.severity === 'high' || a.severity === 'critical');
            const cls = highSev ? 'severity-high' : 'severity-medium';
            const firstInterp = anomalies[0]?.interpretation || anomalies[0]?.metric + ' changed by ' + fmtPct(Math.abs(anomalies[0]?.change_pct));

            el.innerHTML = `
                <div class="alert-banner ${cls}" id="alert-banner-inner">
                    <span>&#9888; <strong>${anomalies.length} anomal${anomalies.length === 1 ? 'y' : 'ies'} detected:</strong> ${firstInterp}${anomalies.length > 1 ? ' (and ' + (anomalies.length - 1) + ' more)' : ''}</span>
                    <button class="dismiss-btn" onclick="document.getElementById('alert-banner-inner').remove()">&#10005;</button>
                </div>
            `;
        }

        /* ── 2. KPI Row ── */
        function renderKPIs(d) {
            const s = d.summary || {};
            const campaigns = d.campaigns || [];
            const flProfit = campaigns.reduce((sum, c) => sum + (c.true_metrics?.fully_loaded_profit || 0), 0);
            // Weighted portfolio ROAS: sum(revenue - COGS) / sum(spend)
            const totalGrossProfit = campaigns.reduce((sum, c) => sum + (c.true_metrics?.profit || 0) + (c.spend || 0), 0);
            const totalSpend = campaigns.reduce((sum, c) => sum + (c.spend || 0), 0);
            const avgRoas = totalSpend > 0 ? totalGrossProfit / totalSpend : null;

            document.getElementById('kpi-grid').innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Total Spend</div>
                    <div class="kpi-value">${fmtK(s.total_spend)}</div>
                    <div class="kpi-sub">Last 30 days</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">True Profit</div>
                    <div class="kpi-value" style="color:${(s.total_profit || 0) >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtK(s.total_profit)}</div>
                    <div class="kpi-sub">Revenue - COGS - Ads</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Fully Loaded Profit</div>
                    <div class="kpi-value" style="color:${flProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtK(flProfit)}</div>
                    <div class="kpi-sub">Incl. overhead allocation</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Avg True ROAS</div>
                    <div class="kpi-value">${avgRoas != null && !isNaN(avgRoas) ? fmtRoas(avgRoas) : '--'}</div>
                    <div class="kpi-sub">Weighted (Rev-COGS) / Spend</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Profitable</div>
                    <div class="kpi-value" style="color:var(--green)">${s.profitable_count ?? 0}</div>
                    <div class="kpi-sub">of ${s.campaign_count ?? campaigns.length} campaigns</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Waste</div>
                    <div class="kpi-value" style="color:${(s.total_waste || 0) > 0 ? 'var(--red)' : 'var(--green)'}">${fmtK(s.total_waste)}</div>
                    <div class="kpi-sub">${s.wasting_count ?? 0} campaigns wasting</div>
                </div>
            `;
        }

        /* ── 3. Health Scores ── */
        function renderHealthScores(healthScores) {
            const el = document.getElementById('health-grid');
            if (!healthScores?.length) { el.innerHTML = '<div class="section-empty">No health score data available</div>'; return; }

            const sorted = [...healthScores].sort((a, b) => (a.health_score || 0) - (b.health_score || 0));
            let html = '';
            sorted.forEach(h => {
                const score = h.health_score ?? 0;
                const color = healthColor(score);
                const circumference = 2 * Math.PI * 38;
                const offset = circumference - (score / 100) * circumference;

                html += `
                <div class="health-item">
                    <div class="health-circle">
                        <svg width="90" height="90">
                            <circle cx="45" cy="45" r="38" stroke="#f3f4f6" stroke-width="6" fill="none"/>
                            <circle cx="45" cy="45" r="38" stroke="${color}" stroke-width="6" fill="none"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
                        </svg>
                        <div class="score-text">
                            <span class="score-num" style="color:${color}">${score}</span>
                            <span class="score-grade">${h.grade || ''}</span>
                        </div>
                    </div>
                    <div class="health-name" title="${h.campaign_name || ''}">${truncate(h.campaign_name, 18)}</div>
                </div>`;
            });
            el.innerHTML = html;
        }

        /* ── 4. Google vs Reality ── */
        function renderGoogleVsReality(gvr) {
            const summaryEl = document.getElementById('gvr-summary');
            if (!gvr) { summaryEl.innerHTML = '<div class="section-empty">No Google vs Reality data</div>'; return; }

            const t = gvr.totals || {};
            summaryEl.innerHTML = `
                <div class="gvr-summary">
                    <div class="gvr-stat">
                        <div class="label">Google Says Revenue</div>
                        <div class="value">${fmtMoney(t.google_total_revenue)}</div>
                    </div>
                    <div class="gvr-stat">
                        <div class="label">Actual Revenue</div>
                        <div class="value">${fmtMoney(t.actual_total_revenue)}</div>
                    </div>
                    <div class="gvr-stat">
                        <div class="label">Inflation</div>
                        <div class="value danger">${fmtPct(t.inflation_pct)}</div>
                    </div>
                    <div style="display:flex;gap:24px">
                        <div class="gvr-stat">
                            <div class="label">Google Avg ROAS</div>
                            <div class="value" style="font-size:18px">${fmtRoas(t.avg_google_roas)}</div>
                        </div>
                        <div class="gvr-stat">
                            <div class="label">True Avg ROAS</div>
                            <div class="value" style="font-size:18px">${fmtRoas(t.avg_true_roas)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Chart
            const campaigns = gvr.campaigns || [];
            if (!campaigns.length) return;
            const labels = campaigns.map(c => truncate(c.campaign_name, 25));
            const ctx = document.getElementById('gvrChart').getContext('2d');
            if (googleVsRealityChart) googleVsRealityChart.destroy();
            googleVsRealityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Google ROAS', data: campaigns.map(c => c.google_roas), backgroundColor: 'rgba(217,119,6,0.6)', borderRadius: 4 },
                        { label: 'True ROAS', data: campaigns.map(c => c.true_roas), backgroundColor: 'rgba(31,111,107,0.7)', borderRadius: 4 },
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
                    scales: {
                        x: { title: { display: true, text: 'ROAS (x)' } },
                        y: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        /* ── 5. Trend Charts ── */
        function renderTrendCharts(trends) {
            if (!trends?.length) return;
            const labels = trends.map(t => t.week_start || t.week_label || '');

            // Chart 1: Spend (bars) + Conversions (line)
            const ctx1 = document.getElementById('trendChart1').getContext('2d');
            if (trendChart1) trendChart1.destroy();
            trendChart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Spend', data: trends.map(t => t.spend), backgroundColor: 'rgba(31,111,107,0.6)', borderRadius: 4, yAxisID: 'y' },
                        { label: 'Conversions', data: trends.map(t => t.conversions), type: 'line', borderColor: '#dc2626', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 3, yAxisID: 'y1', tension: 0.3 },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
                    scales: {
                        y: { position: 'left', ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'k' } },
                        y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Conversions' } },
                        x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                    }
                }
            });

            // Chart 2: ROAS (area) + CPC (line)
            const ctx2 = document.getElementById('trendChart2').getContext('2d');
            if (trendChart2) trendChart2.destroy();
            trendChart2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'ROAS', data: trends.map(t => t.roas), borderColor: 'var(--cass-teal)', backgroundColor: 'rgba(31,111,107,0.1)', fill: true, borderWidth: 2, pointRadius: 3, yAxisID: 'y', tension: 0.3 },
                        { label: 'Avg CPC', data: trends.map(t => t.avg_cpc || t.cpc), borderColor: 'var(--cass-gold)', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 3, yAxisID: 'y1', tension: 0.3 },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'ROAS (x)' } },
                        y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'CPC ($)' }, ticks: { callback: v => '$' + v.toFixed(2) } },
                        x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                    }
                }
            });
        }

        /* ── 6. Campaign Scorecards ── */
        function renderScorecards(campaigns, healthScores, deepMetrics, breakEven) {
            const el = document.getElementById('scorecards');
            if (!campaigns?.length) { el.innerHTML = '<div class="section-empty">No campaign data</div>'; return; }

            const hsMap = {};
            (healthScores || []).forEach(h => { hsMap[h.campaign_id] = h; });
            const dmMap = {};
            (deepMetrics || []).forEach(dm => { dmMap[dm.campaign_id] = dm; });
            const beMap = {};
            (breakEven || []).forEach(be => { beMap[be.campaign_id] = be; });

            const sorted = [...campaigns].sort((a, b) => (b.true_metrics?.profit || 0) - (a.true_metrics?.profit || 0));
            let html = '';

            const _stratLabels = {high_consideration:'HC', fast_turn:'FT', brand_defense:'BD', prospecting:'PR', unknown:'??'};
            const _stsLabels = {strong:'Strong', healthy:'Healthy', marginal:'Marginal', weak:'Weak'};
            const _svLabels = {high:'High SV', moderate:'Med SV', low:'Low SV'};
            const _actionLabels = {scale_aggressively:'Scale 50%', scale:'Scale 25%', maintain:'Maintain', optimize:'Optimize', reduce:'Reduce 50%', pause:'Pause', investigate:'Investigate'};
            const _actionCardClass = {scale_aggressively:'scale', scale:'scale', maintain:'maintain', optimize:'optimize', reduce:'reduce', pause:'pause', investigate:'investigate'};

            sorted.forEach(c => {
                const profit = c.true_metrics?.profit || 0;
                const roas = c.true_metrics?.true_roas;
                const flProfit = c.true_metrics?.fully_loaded_profit;
                const flRoas = c.true_metrics?.fully_loaded_roas;
                const overhead = c.true_metrics?.allocated_overhead;
                const spend = c.spend || 0;
                const perf = c.performance || {};
                const dm = dmMap[c.campaign_id];
                const hs = hsMap[c.campaign_id];
                const be = beMap[c.campaign_id];
                const strat = c.strategy;

                // Card class: prefer strategy action, fallback to legacy
                let cardClass;
                if (strat?.action) {
                    cardClass = _actionCardClass[strat.action] || '';
                } else if (spend === 0) {
                    cardClass = '';
                } else if (c.indicators?.is_profitable && roas >= 2) {
                    cardClass = 'profitable';
                } else if (profit > 0) {
                    cardClass = 'marginal';
                } else {
                    cardClass = 'losing';
                }

                // Decision score circle
                const dScore = strat?.decision_score;
                const dScoreBg = dScore != null ? healthColor(dScore) : '#9ca3af';

                const healthBg = hs ? healthColor(hs.health_score) : '#9ca3af';
                const healthLabel = hs ? hs.health_score + (hs.grade ? ' ' + hs.grade : '') : '--';

                const convRate = dm?.metrics?.conv_rate != null ? dm.metrics.conv_rate * 100 : null;
                const cpa = dm?.metrics?.cpa;

                const beAbove = be?.above_break_even;

                // Strategy chip + dual badges (when strategy is available)
                const stratChip = strat?.type ? `<span class="strategy-chip s-${strat.type}" title="${strat.type.replace(/_/g,' ')}">${_stratLabels[strat.type] || '??'}</span>` : '';
                const dualBadges = strat?.short_term_status
                    ? `<div class="dual-badges">
                        <span class="sts-badge sts-${strat.short_term_status}">${_stsLabels[strat.short_term_status] || strat.short_term_status}</span>
                        <span class="sv-badge sv-${strat.strategic_value}">${_svLabels[strat.strategic_value] || strat.strategic_value}</span>
                       </div>`
                    : (() => {
                        let status, badgeClass;
                        if (spend === 0) { status = 'Paused'; badgeClass = 'badge-paused'; }
                        else if (c.indicators?.is_profitable && roas >= 2) { status = 'Profitable'; badgeClass = 'badge-profitable'; }
                        else if (profit > 0) { status = 'Marginal'; badgeClass = 'badge-marginal'; }
                        else { status = 'Losing'; badgeClass = 'badge-losing'; }
                        return `<span class="scorecard-badge ${badgeClass}">${status}</span>`;
                    })();

                const actionLabel = strat?.action ? (_actionLabels[strat.action] || strat.action) : (c.recommendation?.action || '--');
                const actionClass = strat?.action === 'investigate' ? ' investigate' : '';
                const whyNow = strat?.why_now ? `<div class="why-now">${strat.why_now}</div>` : '';
                const confBadge = strat?.confidence ? ` <span style="font-size:10px;color:var(--slate)">(${strat.confidence} conf)</span>` : '';

                html += `
                <div class="scorecard ${cardClass}">
                    <div class="scorecard-header">
                        <span class="scorecard-name">${c.campaign_name || c.campaign_id}</span>
                        ${dScore != null ? `<span class="decision-score" style="background:${dScoreBg}" title="Decision Score: ${dScore}/100">${dScore}</span>` : `<span class="scorecard-health" style="background:${healthBg}" title="Health: ${healthLabel}">${hs?.grade || '--'}</span>`}
                        ${stratChip}
                        ${dualBadges}
                    </div>
                    <div class="scorecard-metrics">
                        <div class="scorecard-metric"><div class="scorecard-metric-label">Spend</div><div class="scorecard-metric-value">${fmt(spend)}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">True ROAS</div><div class="scorecard-metric-value">${roas != null ? fmtRoas(roas) : '--'}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">Profit</div><div class="scorecard-metric-value" style="color:${profit >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(profit)}</div></div>
                    </div>
                    <div class="scorecard-metrics">
                        <div class="scorecard-metric"><div class="scorecard-metric-label">CPA</div><div class="scorecard-metric-value">${cpa != null ? fmt(cpa) : (perf.avg_cpc ? fmt(perf.avg_cpc) : '--')}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">CTR</div><div class="scorecard-metric-value">${perf.ctr != null ? fmtPct(perf.ctr) : (dm?.metrics?.ctr != null ? fmtPct(dm.metrics.ctr * 100) : '--')}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">Conv Rate</div><div class="scorecard-metric-value">${convRate != null ? fmtPct(convRate) : '--'}</div></div>
                    </div>
                    ${flProfit != null ? `
                    <div class="scorecard-metrics" style="margin-top:4px;padding-top:8px;border-top:1px dashed var(--line)">
                        <div class="scorecard-metric"><div class="scorecard-metric-label">FL ROAS</div><div class="scorecard-metric-value">${flRoas != null ? fmtRoas(flRoas) : '--'}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">FL Profit</div><div class="scorecard-metric-value" style="color:${flProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(flProfit)}</div></div>
                        <div class="scorecard-metric"><div class="scorecard-metric-label">Overhead</div><div class="scorecard-metric-value">${fmt(overhead)}</div></div>
                    </div>` : ''}
                    ${be != null ? `<div class="be-indicator ${beAbove ? 'above' : 'below'}" title="${beAbove ? 'Above' : 'Below'} break-even by ${fmtMoney(Math.abs(be.headroom_dollars || 0))}"></div>` : ''}
                    ${dm ? `<div class="trend-arrows">
                        <span>CPC ${trendArrow(dm.trends?.cpc_trend)}</span>
                        <span>CTR ${trendArrow(dm.trends?.ctr_trend)}</span>
                        <span>Conv ${trendArrow(dm.trends?.conv_rate_trend)}</span>
                        <span>CPA ${trendArrow(dm.trends?.cpa_trend)}</span>
                    </div>` : ''}
                    ${whyNow}
                    <div class="scorecard-footer">
                        Action: <span class="action${actionClass}">${actionLabel}</span>${confBadge}
                        ${perf.clicks ? ' &middot; ' + perf.clicks.toLocaleString() + ' clicks' : ''}
                        ${c.true_metrics?.conversions ? ' &middot; ' + c.true_metrics.conversions + ' conv' : ''}
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        /* ── 7. Break-Even Analysis ── */
        function renderBreakEven(breakEvenData) {
            const wrap = document.getElementById('break-even-wrap');
            if (!breakEvenData?.length) { wrap.innerHTML = '<div class="section-empty">No break-even data available</div>'; return; }

            const sorted = [...breakEvenData].sort((a, b) => (a.margin_of_safety || 0) - (b.margin_of_safety || 0));
            const labels = sorted.map(b => truncate(b.campaign_name, 25));
            const data = sorted.map(b => b.actual_roas || 0);
            const bgColors = sorted.map(b => b.above_break_even ? 'rgba(22,163,74,0.6)' : 'rgba(220,38,38,0.6)');
            const beLines = sorted.map(b => b.break_even_roas || 0);

            wrap.style.minHeight = Math.max(300, sorted.length * 40 + 60) + 'px';
            wrap.innerHTML = '<canvas id="breakEvenChart"></canvas>';

            const ctx = document.getElementById('breakEvenChart').getContext('2d');
            if (breakEvenChart) breakEvenChart.destroy();
            breakEvenChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Actual ROAS',
                            data: data,
                            backgroundColor: bgColors,
                            borderRadius: 4,
                        },
                        {
                            label: 'Break-Even ROAS',
                            data: beLines,
                            type: 'scatter',
                            pointStyle: 'line',
                            pointRadius: 12,
                            pointBorderWidth: 3,
                            pointBorderColor: '#1b1b1b',
                            backgroundColor: '#1b1b1b',
                            showLine: false,
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(ctx) {
                                    const item = sorted[ctx.dataIndex];
                                    return item ? 'Headroom: ' + fmtMoney(item.headroom_dollars) : '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'ROAS (x)' }, beginAtZero: true },
                        y: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        /* ── 8. Revenue Concentration ── */
        function renderConcentration(conc) {
            const kpiEl = document.getElementById('concentration-kpis');
            if (!conc) { kpiEl.innerHTML = '<div class="section-empty">No concentration data</div>'; return; }

            const riskClass = (conc.risk_level === 'critical' || conc.risk_level === 'high')
                ? 'risk-high'
                : (conc.risk_level === 'medium' || conc.risk_level === 'moderate')
                    ? 'risk-moderate'
                    : 'risk-low';
            kpiEl.innerHTML = `
                <div class="concentration-kpi">
                    <div class="label">HHI Score</div>
                    <div class="value">${conc.hhi_score != null ? conc.hhi_score.toLocaleString() : '--'}</div>
                    <span class="risk-badge ${riskClass}">${conc.risk_level || '--'} risk</span>
                </div>
                <div class="concentration-kpi">
                    <div class="label">Top 2 Share</div>
                    <div class="value">${fmtPct(conc.top_2_share_pct)}</div>
                </div>
                <div class="concentration-kpi">
                    <div class="label">Top 5 Share</div>
                    <div class="value">${fmtPct(conc.top_5_share_pct)}</div>
                </div>
            `;

            const campaigns = conc.campaigns || [];
            if (!campaigns.length) return;

            const colors = ['#1f6f6b', '#c49a4a', '#dc2626', '#2563eb', '#7c3aed', '#059669', '#d97706', '#be185d', '#6366f1', '#0d9488'];
            const ctx = document.getElementById('concentrationChart').getContext('2d');
            if (concentrationChart) concentrationChart.destroy();
            concentrationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: campaigns.map(c => truncate(c.name, 20)),
                    datasets: [{
                        data: campaigns.map(c => c.revenue || c.share_pct || 0),
                        backgroundColor: campaigns.map((_, i) => colors[i % colors.length]),
                        borderWidth: 2,
                        borderColor: '#fff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10 }, padding: 10 } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const item = campaigns[ctx.dataIndex];
                                    return item ? item.name + ': ' + fmtPct(item.share_pct) + ' (' + fmtMoney(item.revenue) + ')' : '';
                                }
                            }
                        }
                    }
                }
            });
        }

        /* ── 9. Campaign Type Comparison ── */
        function renderTypeComparison(tc) {
            const el = document.getElementById('type-comparison');
            if (!tc?.types?.length) { el.innerHTML = '<div class="section-empty">No type comparison data</div>'; return; }

            const types = tc.types;
            // Find winners per column
            const cols = ['total_spend', 'total_revenue', 'total_profit', 'avg_roas', 'avg_cpc', 'avg_ctr', 'total_conversions'];
            const winners = {};
            cols.forEach(col => {
                let bestIdx = 0;
                let bestVal = col === 'avg_cpc' ? Infinity : -Infinity;
                types.forEach((t, i) => {
                    const v = t[col] || 0;
                    if (col === 'avg_cpc') { if (v < bestVal && v > 0) { bestVal = v; bestIdx = i; } }
                    else { if (v > bestVal) { bestVal = v; bestIdx = i; } }
                });
                winners[col] = bestIdx;
            });

            let html = '<table class="type-table"><thead><tr>';
            html += '<th>Type</th><th>Campaigns</th><th>Spend</th><th>Revenue</th><th>Profit</th><th>ROAS</th><th>CPC</th><th>CTR</th><th>Conversions</th>';
            html += '</tr></thead><tbody>';

            types.forEach((t, i) => {
                html += '<tr>';
                html += `<td class="type-name">${t.type || '--'}</td>`;
                html += `<td>${t.campaign_count || 0}</td>`;
                html += `<td class="${winners.total_spend === i ? 'winner' : ''}">${fmtMoney(t.total_spend)}</td>`;
                html += `<td class="${winners.total_revenue === i ? 'winner' : ''}">${fmtMoney(t.total_revenue)}</td>`;
                html += `<td class="${winners.total_profit === i ? 'winner' : ''}" style="color:${(t.total_profit || 0) >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtMoney(t.total_profit)}</td>`;
                html += `<td class="${winners.avg_roas === i ? 'winner' : ''}">${fmtRoas(t.avg_roas)}</td>`;
                html += `<td class="${winners.avg_cpc === i ? 'winner' : ''}">${t.avg_cpc != null ? '$' + t.avg_cpc.toFixed(2) : '--'}</td>`;
                html += `<td class="${winners.avg_ctr === i ? 'winner' : ''}">${fmtPct((t.avg_ctr || 0) * 100)}</td>`;
                html += `<td class="${winners.total_conversions === i ? 'winner' : ''}">${t.total_conversions != null ? Math.round(t.total_conversions).toLocaleString() : '--'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            if (tc.best_type || tc.recommendation) {
                html += `<div class="type-callout">
                    ${tc.best_type ? '<strong>Best performing type: ' + tc.best_type + '</strong>' : ''}
                    ${tc.recommendation ? '<br>' + tc.recommendation : ''}
                </div>`;
            }

            el.innerHTML = html;
        }

        /* ── 10. Diminishing Returns ── */
        function renderDiminishingReturns(drData) {
            const el = document.getElementById('diminishing-returns');
            if (!drData?.length) { el.innerHTML = '<div class="section-empty">No diminishing returns data available</div>'; return; }

            let html = '';
            drData.forEach((dr, idx) => {
                const buckets = dr.buckets || [];
                const canvasId = 'drChart_' + idx;
                const isOverspend = dr.overspend_per_day > 0;

                html += `
                <div class="dr-card">
                    <div class="dr-card-title" title="${dr.campaign_name || ''}">${truncate(dr.campaign_name, 35)}</div>
                    <div style="height:160px"><canvas id="${canvasId}"></canvas></div>
                    <div style="display:flex;gap:16px;margin-top:8px;font-size:12px;color:var(--slate)">
                        <span>Optimal: <strong>${dr.optimal_daily_spend != null ? fmt(dr.optimal_daily_spend) : '--'}</strong>/day</span>
                        <span>Current: <strong>${dr.current_daily_spend != null ? fmt(dr.current_daily_spend) : '--'}</strong>/day</span>
                    </div>
                    ${isOverspend ? `<div class="dr-callout overspend">Overspending by ${fmt(dr.overspend_per_day)}/day</div>` : `<div class="dr-callout optimal">${dr.status || 'Within optimal range'}</div>`}
                </div>`;
            });
            el.innerHTML = html;

            // Render mini charts
            drData.forEach((dr, idx) => {
                const buckets = dr.buckets || [];
                if (!buckets.length) return;
                const canvasId = 'drChart_' + idx;
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;

                const optBucket = buckets.reduce((best, b) => (b.avg_roas || 0) > (best.avg_roas || 0) ? b : best, buckets[0]);

                new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: buckets.map(b => b.range_label || ''),
                        datasets: [{
                            label: 'Avg ROAS',
                            data: buckets.map(b => b.avg_roas || 0),
                            backgroundColor: buckets.map(b => b === optBucket ? 'rgba(31,111,107,0.8)' : 'rgba(31,111,107,0.3)'),
                            borderRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { title: { display: true, text: 'ROAS', font: { size: 9 } }, ticks: { font: { size: 9 } } },
                            x: { ticks: { font: { size: 8 }, maxRotation: 30 } }
                        }
                    }
                });
            });
        }

        /* ── 11. Competitor Pressure ── */
        function renderCompetitorPressure(cpData) {
            const el = document.getElementById('competitor-pressure');
            if (!cpData?.length) { el.innerHTML = '<div class="section-empty">No competitor pressure data available</div>'; return; }

            let html = '';
            cpData.forEach(cp => {
                const score = cp.pressure_score || 0;
                let gaugeColor;
                if (score >= 70) gaugeColor = 'var(--red)';
                else if (score >= 40) gaugeColor = 'var(--amber)';
                else gaugeColor = 'var(--green)';

                const cpcChange = cp.cpc_change_pct;
                const cpcColor = cpcChange > 0 ? 'var(--red)' : cpcChange < 0 ? 'var(--green)' : 'var(--slate)';
                const rlChange = cp.rank_lost_change;
                const rlColor = rlChange > 0 ? 'var(--red)' : rlChange < 0 ? 'var(--green)' : 'var(--slate)';

                html += `
                <div class="cp-card">
                    <div class="cp-name">${cp.campaign_name || cp.campaign_id}</div>
                    <div class="cp-gauge"><div class="cp-gauge-fill" style="width:${score}%;background:${gaugeColor}"></div></div>
                    <div class="cp-type" style="color:${gaugeColor}">${cp.pressure_type || 'Score: ' + score}</div>
                    <div class="cp-detail">CPC: <strong>$${cp.cpc_current?.toFixed(2) || '--'}</strong> (was $${cp.cpc_prior?.toFixed(2) || '--'}) <span class="change" style="color:${cpcColor}">${cpcChange != null ? (cpcChange > 0 ? '+' : '') + fmtPct(cpcChange) : ''}</span></div>
                    <div class="cp-detail">Rank Lost IS: <strong>${fmtPct(cp.rank_lost_current)}</strong> (was ${fmtPct(cp.rank_lost_prior)}) <span class="change" style="color:${rlColor}">${rlChange != null ? (rlChange > 0 ? '+' : '') + rlChange.toFixed(1) : ''}</span></div>
                    ${cp.interpretation ? `<div class="cp-interp">${cp.interpretation}</div>` : ''}
                </div>`;
            });
            el.innerHTML = html;
        }

        /* ── 12. Impression Share ── */
        function renderImpressionShare(trendsData) {
            const el = document.getElementById('impression-share');

            // Try to get IS data from trends or campaigns
            // This section works with data from the trends endpoint if available
            if (!trendsData?.length) {
                el.innerHTML = '<div class="section-empty">No impression share data available. Data is populated from trend analysis.</div>';
                return;
            }

            // If we have trends data with IS info, render it
            const weeksWithIS = trendsData.filter(t => t.avg_impression_share > 0);
            if (!weeksWithIS.length) {
                el.innerHTML = '<div class="section-empty">No impression share data in trend response</div>';
                return;
            }

            let html = '<div style="display:flex;gap:8px;margin-bottom:16px;font-size:12px">' +
                '<span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--cass-teal);border-radius:2px"></span> Won</span>' +
                '<span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--amber);border-radius:2px"></span> Budget Lost</span>' +
                '<span style="display:inline-flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--red);opacity:0.7;border-radius:2px"></span> Rank Lost</span>' +
                '</div>';

            weeksWithIS.forEach(c => {
                const is = c.avg_impression_share || 0;
                const bl = c.avg_budget_lost_is || 0;
                const rl = c.avg_rank_lost_is || 0;

                html += `<div class="is-bar-container">
                    <div class="is-bar-label">
                        <span>${c.week_start || c.week || 'Week'}</span>
                        <span>${fmtPct(is)} IS</span>
                    </div>
                    <div class="is-bar-track">
                        <div class="is-bar-segment is-won" style="width:${is}%">${is > 10 ? is.toFixed(0) + '%' : ''}</div>
                        <div class="is-bar-segment is-budget-lost" style="width:${bl}%">${bl > 10 ? bl.toFixed(0) + '%' : ''}</div>
                        <div class="is-bar-segment is-rank-lost" style="width:${rl}%">${rl > 10 ? rl.toFixed(0) + '%' : ''}</div>
                    </div>
                </div>`;
            });
            el.innerHTML = html;
        }

        /* ── 13. Waste & Budget Actions ── */
        function renderWasteAndActions(waste, reallocations, quickWins) {
            // Waste list
            const wasteEl = document.getElementById('waste-list');
            if (!waste?.length) {
                wasteEl.innerHTML = '<li class="section-empty">No waste items identified</li>';
            } else {
                let whtml = '';
                waste.forEach(w => {
                    const sevColor = severityColor(w.waste_metrics?.severity);
                    whtml += `
                    <li class="waste-item">
                        <div class="waste-item-header">
                            <span class="waste-item-name"><span class="severity-dot" style="background:${sevColor}"></span>${w.waste_type || 'Waste'}</span>
                            <span class="waste-item-amount">${fmtMoney(w.waste_metrics?.monthly_waste)}</span>
                        </div>
                        <div class="waste-item-desc">${w.description || ''} ${w.affected?.campaign_name ? '(' + truncate(w.affected.campaign_name, 30) + ')' : ''}</div>
                        <div class="waste-item-fix">${w.recommendation?.action || ''} ${w.recommendation?.expected_savings ? ' &mdash; save ' + fmtMoney(w.recommendation.expected_savings) : ''} ${w.recommendation?.difficulty ? ' [' + w.recommendation.difficulty + ']' : ''}</div>
                    </li>`;
                });
                wasteEl.innerHTML = whtml;
            }

            // Reallocations
            const reallocEl = document.getElementById('realloc-list');
            if (!reallocations?.length) {
                reallocEl.innerHTML = '<div class="section-empty">No reallocation recommendations</div>';
            } else {
                let rhtml = '';
                reallocations.forEach(r => {
                    rhtml += `
                    <div class="realloc-item">
                        <div class="realloc-from">
                            <div class="realloc-label">Reduce</div>
                            <div class="realloc-name" title="${r.from_campaign?.name || ''}">${truncate(r.from_campaign?.name, 22)}</div>
                            <div class="realloc-amount" style="color:var(--red)">-${fmtMoney(r.from_campaign?.budget_reduction)}</div>
                        </div>
                        <div class="realloc-arrow">&#10132;</div>
                        <div class="realloc-to">
                            <div class="realloc-label">Increase</div>
                            <div class="realloc-name" title="${r.to_campaign?.name || ''}">${truncate(r.to_campaign?.name, 22)}</div>
                            <div class="realloc-amount" style="color:var(--green)">+${fmtMoney(r.to_campaign?.budget_increase)}</div>
                        </div>
                        <div class="realloc-profit">+${fmtMoney(r.expected_impact?.additional_profit)} profit</div>
                    </div>`;
                });
                reallocEl.innerHTML = rhtml;
            }

            // Quick Wins
            const qwEl = document.getElementById('quick-wins');
            if (!quickWins?.length) {
                qwEl.innerHTML = '<div class="section-empty">No quick wins identified</div>';
            } else {
                let qhtml = '';
                quickWins.forEach(qw => {
                    qhtml += `
                    <div class="qw-card">
                        <div class="qw-type">${qw.type || 'Optimization'}</div>
                        <div class="qw-desc">${qw.description || ''}</div>
                        <div class="qw-action">${qw.action || ''}</div>
                        <div class="qw-meta">
                            <span class="qw-savings">${qw.savings ? (parseMoney(qw.savings) != null ? fmtMoney(parseMoney(qw.savings)) : qw.savings) : ''}</span>
                            <span class="qw-effort">${qw.effort || ''}</span>
                        </div>
                    </div>`;
                });
                qwEl.innerHTML = qhtml;
            }
        }

        /* ── 14. Product Performance ── */
        function renderProducts(products) {
            const scaleEl = document.getElementById('products-scale');
            const excludeEl = document.getElementById('products-exclude');

            if (!products?.length) {
                scaleEl.innerHTML = '<div class="section-empty">No product data available</div>';
                excludeEl.innerHTML = '<div class="section-empty">No product data available</div>';
                return;
            }

            const profitable = products
                .filter(p => p.indicators?.is_profitable && (p.ad_spend?.total_spend || 0) >= 50)
                .sort((a, b) => {
                    // Rank by spend * ROAS to prioritize actionable scale candidates
                    const aScore = (a.ad_spend?.total_spend || 0) * (a.roas?.profit_roas || 0);
                    const bScore = (b.ad_spend?.total_spend || 0) * (b.roas?.profit_roas || 0);
                    return bScore - aScore;
                })
                .slice(0, 10);

            const losing = products
                .filter(p => p.indicators?.is_losing_money)
                .sort((a, b) => (a.profitability?.net_profit || 0) - (b.profitability?.net_profit || 0))
                .slice(0, 10);

            function renderProductList(items, el, isScale) {
                if (!items.length) { el.innerHTML = '<div class="section-empty">None found</div>'; return; }
                let html = '';
                items.forEach(p => {
                    const profit = p.profitability?.net_profit;
                    const profitColor = (profit || 0) >= 0 ? 'var(--green)' : 'var(--red)';
                    const actionBg = isScale ? '#dcfce7' : '#fee2e2';
                    const actionColor = isScale ? '#166534' : '#991b1b';

                    html += `
                    <div class="product-row">
                        <span class="product-title" title="${p.product_title || ''}">${truncate(p.product_title, 50)}</span>
                        <div class="product-stats">
                            <span>${fmtMoney(p.ad_spend?.total_spend)}</span>
                            <span style="color:${profitColor}">${fmtMoney(profit)}</span>
                            <span>${p.roas?.profit_roas != null ? fmtRoas(p.roas.profit_roas) : '--'}</span>
                        </div>
                        <span class="product-action" style="background:${actionBg};color:${actionColor}">${p.recommendation?.action || (isScale ? 'Scale' : 'Exclude')}</span>
                    </div>`;
                });

                // Add header row
                const header = `<div class="product-row" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--slate);font-weight:600;border-bottom:2px solid var(--line)">
                    <span class="product-title">Product</span>
                    <div class="product-stats"><span>Spend</span><span>Profit</span><span>ROAS</span></div>
                    <span class="product-action" style="background:transparent;color:var(--slate)">Action</span>
                </div>`;

                el.innerHTML = header + html;
            }

            renderProductList(profitable, scaleEl, true);
            renderProductList(losing, excludeEl, false);
        }

        /* ── 15. Forecast ── */
        function renderForecast(forecast) {
            const metaEl = document.getElementById('forecast-meta');
            const canvas = document.getElementById('forecastChart');
            if (!forecast) {
                metaEl.innerHTML = '';
                canvas.parentElement.innerHTML = '<div class="section-empty">No forecast data available</div>';
                return;
            }

            // Meta tags
            const td = forecast.trend_direction;
            const trendColor = (td === 'up' || td === 'growing') ? 'var(--green)' : (td === 'down' || td === 'declining') ? 'var(--red)' : 'var(--amber)';
            const trendIcon = (td === 'up' || td === 'growing') ? '&#9650;' : (td === 'down' || td === 'declining') ? '&#9660;' : '&#9654;';
            const confColor = forecast.confidence === 'high' ? '#dcfce7' : forecast.confidence === 'low' ? '#fee2e2' : '#fef3c7';
            const confText = forecast.confidence === 'high' ? '#166534' : forecast.confidence === 'low' ? '#991b1b' : '#92400e';

            metaEl.innerHTML = `
                <span class="forecast-tag" style="background:${confColor};color:${confText}">Confidence: ${forecast.confidence || '--'} ${forecast.r_squared != null ? '(R&sup2;=' + forecast.r_squared.toFixed(2) + ')' : ''}</span>
                <span class="forecast-tag" style="color:${trendColor}">${trendIcon} Trend: ${forecast.trend_direction || '--'}</span>
            `;

            const historical = forecast.historical || [];
            const projected = forecast.projected || [];
            const allData = [...historical, ...projected];
            const labels = allData.map(d => d.week_label || '');
            const histLen = historical.length;

            // Revenue
            const revenueSolid = allData.map((d, i) => i < histLen ? d.revenue : null);
            const revenueDashed = allData.map((d, i) => {
                if (i === histLen - 1) return historical[histLen - 1]?.revenue ?? null;
                return i >= histLen ? d.revenue : null;
            });

            // Spend
            const spendSolid = allData.map((d, i) => i < histLen ? d.spend : null);
            const spendDashed = allData.map((d, i) => {
                if (i === histLen - 1) return historical[histLen - 1]?.spend ?? null;
                return i >= histLen ? d.spend : null;
            });

            const ctx = canvas.getContext('2d');
            if (forecastChart) forecastChart.destroy();
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Revenue (actual)',
                            data: revenueSolid,
                            borderColor: 'var(--cass-teal)',
                            backgroundColor: 'rgba(31,111,107,0.05)',
                            fill: false,
                            borderWidth: 2.5,
                            pointRadius: 3,
                            tension: 0.3,
                            spanGaps: false,
                        },
                        {
                            label: 'Revenue (projected)',
                            data: revenueDashed,
                            borderColor: 'var(--cass-teal)',
                            backgroundColor: 'transparent',
                            borderDash: [6, 4],
                            borderWidth: 2,
                            pointRadius: 3,
                            pointStyle: 'triangle',
                            tension: 0.3,
                            spanGaps: false,
                        },
                        {
                            label: 'Spend (actual)',
                            data: spendSolid,
                            borderColor: 'var(--cass-gold)',
                            backgroundColor: 'transparent',
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.3,
                            spanGaps: false,
                        },
                        {
                            label: 'Spend (projected)',
                            data: spendDashed,
                            borderColor: 'var(--cass-gold)',
                            backgroundColor: 'transparent',
                            borderDash: [6, 4],
                            borderWidth: 2,
                            pointRadius: 3,
                            pointStyle: 'triangle',
                            tension: 0.3,
                            spanGaps: false,
                        },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 }, usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ': ' + fmtMoney(ctx.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { callback: v => fmtMoney(v) } },
                        x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                    }
                }
            });
        }

        /* ================================================================
           MAIN LOAD
           ================================================================ */
        async function loadDashboard() {
            try {
                const [dashRes, trendsRes] = await Promise.all([
                    fetch(API + '/ads/enhanced-dashboard?days=30').then(r => r.json()).catch(() => ({ success: false })),
                    fetch(API + '/ads/trends?days=90').then(r => r.json()).catch(() => ({ success: false })),
                ]);

                if (dashRes.success) {
                    const d = dashRes.data;
                    if (d.data_as_of) {
                        document.getElementById('data-as-of').textContent = 'Data as of ' + d.data_as_of;
                    }
                    renderAlertBanner(d.anomalies);
                    renderKPIs(d);
                    renderHealthScores(d.health_scores);
                    renderGoogleVsReality(d.google_vs_reality);
                    renderScorecards(d.campaigns, d.health_scores, d.deep_metrics, d.break_even);
                    renderBreakEven(d.break_even);
                    renderConcentration(d.concentration);
                    renderTypeComparison(d.type_comparison);
                    renderDiminishingReturns(d.diminishing_returns);
                    renderCompetitorPressure(d.competitor_pressure);
                    // Impression share data comes from trends, not campaigns
                    renderImpressionShare(null);
                    renderWasteAndActions(d.waste, d.reallocations, d.quick_wins);
                    renderProducts(d.products);
                    renderForecast(d.forecast);
                } else {
                    document.getElementById('kpi-grid').innerHTML = '<div class="loading" style="grid-column:1/-1;color:var(--red)">Failed to load dashboard data. Check API connection.</div>';
                }

                if (trendsRes.success) {
                    const trends = trendsRes.data?.trends || trendsRes.data;
                    renderTrendCharts(trends);
                    renderImpressionShare(trends);
                }
            } catch (err) {
                console.error('Dashboard load error:', err);
                document.getElementById('kpi-grid').innerHTML = '<div class="loading" style="grid-column:1/-1;color:var(--red)">Error loading dashboard: ' + err.message + '</div>';
            }
        }

        loadDashboard();
    </script>
    </main><!-- .main-area -->
    </div><!-- .app-shell -->
</body>
</html>
